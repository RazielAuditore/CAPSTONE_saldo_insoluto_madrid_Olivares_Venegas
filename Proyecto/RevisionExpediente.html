<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Revisi√≥n de Expediente</title>
  <style>
    :root { --c1:#0d6efd; --cBg:#f6f7fb; --text:#333; --border:#e5e7eb; --success:#28a745; --warning:#ffc107; --danger:#dc3545; }
    * { box-sizing: border-box; }
    body {
      margin:0;
      font-family: Arial, sans-serif;
      background: linear-gradient(120deg, #e3f0ff 0%, #f7e3e3 100%, #f5f7fb 100%);
      color:var(--text);
      min-height: 100vh;
    }
    .header { background:#fff; border-bottom:1px solid var(--border); padding:20px; text-align:center; }
    h1 { margin:0; color:var(--c1); font-size:28px; }
    .container { max-width:1200px; margin:0 auto; padding:20px; }
    .search-box { background:#fff; border-radius:12px; padding:24px; box-shadow:0 4px 12px rgba(0,0,0,0.1); margin-bottom:20px; }
    .form-group { margin-bottom:16px; }
    label { display:block; margin-bottom:6px; font-weight:500; }
    input { width:100%; padding:12px; border:1px solid var(--border); border-radius:8px; font-size:16px; }
    .btn { background:var(--c1); color:#fff; border:none; padding:12px 24px; border-radius:8px; cursor:pointer; font-size:16px; }
    .btn:hover { background:#084298; }
    .btn-success { background:var(--success); }
    .btn-success:hover { background:#1e7e34; }
    .btn-warning { background:var(--warning); color:#000; }
    .btn-warning:hover { background:#e0a800; }
    .btn-danger { background:var(--danger); }
    .btn-danger:hover { background:#c82333; }
    
    .expediente-info { background:#fff; border-radius:12px; padding:24px; box-shadow:0 4px 12px rgba(0,0,0,0.1); margin-bottom:20px; }
    .info-grid { display:grid; grid-template-columns:1fr 1fr; gap:20px; margin-bottom:20px; }
    .info-section { background:#f8f9fa; padding:16px; border-radius:8px; }
    .info-section h3 { margin:0 0 12px; color:var(--c1); font-size:18px; }
    .info-item { margin-bottom:8px; }
    .info-label { font-weight:600; color:#666; }
    .info-value { color:#333; }
    
    .status-card { background:#fff; border-radius:12px; padding:24px; box-shadow:0 4px 12px rgba(0,0,0,0.1); margin-bottom:20px; }
    .status-header { display:flex; align-items:center; margin-bottom:16px; }
    .status-icon { font-size:24px; margin-right:12px; }
    .status-title { font-size:20px; font-weight:600; margin:0; }
    .status-details { display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:16px; }
    .status-item { text-align:center; padding:12px; background:#f8f9fa; border-radius:8px; }
    .status-number { font-size:24px; font-weight:bold; color:var(--c1); }
    .status-label { font-size:14px; color:#666; }
    
    .documentos-section { background:#fff; border-radius:12px; padding:24px; box-shadow:0 4px 12px rgba(0,0,0,0.1); margin-bottom:20px; }
    .documentos-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; }
    .documentos-count { background:var(--c1); color:#fff; padding:8px 16px; border-radius:20px; font-size:14px; font-weight:600; }
    .documentos-list { display:grid; gap:12px; }
    .documento-item { display:flex; justify-content:space-between; align-items:center; padding:16px; background:#f8f9fa; border-radius:8px; border-left:4px solid var(--c1); }
    .documento-info { flex:1; }
    .documento-nombre { font-weight:600; margin-bottom:4px; }
    .documento-detalles { font-size:14px; color:#666; }
    .documento-acciones { display:flex; gap:8px; }
    
    .beneficiarios-section { background:#fff; border-radius:12px; padding:24px; box-shadow:0 4px 12px rgba(0,0,0,0.1); margin-bottom:20px; }
    .beneficiarios-list { display:grid; gap:12px; }
    .beneficiario-item { display:flex; justify-content:space-between; align-items:center; padding:16px; background:#f8f9fa; border-radius:8px; }
    .beneficiario-info { flex:1; }
    .beneficiario-nombre { font-weight:600; margin-bottom:4px; }
    .beneficiario-detalles { font-size:14px; color:#666; }
    .firma-status { display:flex; align-items:center; gap:8px; }
    .firma-check { font-size:20px; }
    
    .download-section { background:#fff; border-radius:12px; padding:24px; box-shadow:0 4px 12px rgba(0,0,0,0.1); text-align:center; margin-bottom:20px; }
    .download-title { font-size:20px; font-weight:600; margin-bottom:12px; color:var(--c1); }
    .download-description { color:#666; margin-bottom:20px; }
    
    .btn-calculate { padding:12px 32px; font-size:16px; font-weight:600; border-radius:8px; cursor:pointer; transition:all 0.3s; border:none; }
    .btn-calculate:disabled { background:#ccc !important; color:#666 !important; cursor:not-allowed; opacity:0.6; }
    .btn-calculate.enabled { background:linear-gradient(135deg, #28a745 0%, #20c997 100%); color:#fff; box-shadow:0 4px 15px rgba(40,167,69,0.4); }
    .btn-calculate.enabled:hover { transform:translateY(-2px); box-shadow:0 6px 20px rgba(40,167,69,0.6); }
    .btn-calculate.disabled { background:#e0e0e0; color:#999; }
    .btn-inicio { background:var(--c1); color:#fff; margin-top:10px; }
    .btn-inicio:hover { background:#084298; }
    .btn-volver {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: #6c757d;
      color: #fff;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      text-decoration: none;
      margin-bottom: 20px;
      transition: background 0.3s;
    }
    .btn-volver:hover {
      background: #5a6268;
    }
    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 20px;
    }
    .header h1 {
      flex: 1;
    }
    
    .modal-overlay { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:10000; justify-content:center; align-items:center; }
    .modal-content { background:#fff; border-radius:16px; padding:32px; max-width:900px; width:90%; max-height:85vh; overflow-y:auto; box-shadow:0 10px 40px rgba(0,0,0,0.3); }
    .beneficio-row { display:grid; grid-template-columns:1fr 1fr auto; gap:12px; align-items:end; margin-bottom:16px; }
    .btn-add { background:#28a745; color:#fff; border:none; padding:12px 20px; border-radius:8px; cursor:pointer; font-size:18px; font-weight:bold; min-width:50px; }
    .btn-add:hover { background:#1e7e34; }
    .btn-remove { background:#dc3545; color:#fff; border:none; padding:12px 16px; border-radius:8px; cursor:pointer; font-size:16px; }
    .btn-remove:hover { background:#c82333; }
    .modal-header { margin-bottom:24px; text-align:center; }
    .modal-header h2 { margin:0; color:var(--c1); font-size:24px; }
    .modal-body { margin-bottom:24px; }
    .modal-footer { text-align:center; }
    .modal-form-group { margin-bottom:16px; }
    .modal-form-group label { display:block; margin-bottom:8px; font-weight:600; color:#333; }
    .modal-form-group input, .modal-form-group textarea, .modal-form-group select { width:100%; padding:12px; border:1px solid var(--border); border-radius:8px; font-size:16px; }
    .modal-form-group textarea { min-height:100px; resize:vertical; }
    
    .no-results { text-align:center; color:#6b7280; padding:40px; background:#fff; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.1); }
    
    @media (max-width: 768px) {
      .info-grid { grid-template-columns:1fr; }
      .status-details { grid-template-columns:1fr; }
      .documento-item { flex-direction:column; align-items:flex-start; gap:12px; }
      .beneficiario-item { flex-direction:column; align-items:flex-start; gap:12px; }
    }
  </style>
</head>
<body>
  <header class="header">
    <button onclick="window.location.href='index.html'" class="btn-volver">
      ‚Üê Volver al Inicio
    </button>
    <h1>Revisi√≥n de Expediente</h1>
  </header>
  
  <div class="container">
    <div class="search-box">
      <h2>Buscar Expediente</h2>
      <form id="searchForm">
        <div class="form-group">
          <label for="rut">RUT del Causante</label>
          <input type="text" id="rut" placeholder="12.345.678-9" required>
        </div>
        <button type="submit" class="btn">Buscar Expediente</button>
      </form>
    </div>
    
    <div id="expedienteContent" style="display:none;">
      <!-- Contenido del expediente se mostrar√° aqu√≠ -->
    </div>
    
    <div class="no-results" id="noResults" style="display:none;">
      <div style="font-size:48px; margin-bottom:16px;">üîç</div>
      <h3>No se encontr√≥ expediente</h3>
      <p>No se encontr√≥ ning√∫n expediente para el RUT proporcionado.</p>
    </div>
  </div>

  <!-- Modal de C√°lculo de Saldo Insoluto -->
  <div id="modal-calculo" class="modal-overlay" onclick="cerrarModalCalculo(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
      <div class="modal-header">
        <h2>üí∞ Calcular Saldo Insoluto</h2>
      </div>
      <div class="modal-body">
        <div id="beneficios-container">
          <div class="beneficio-row">
            <div class="modal-form-group">
              <label>Beneficio</label>
              <select class="beneficio-select" required onchange="calcularTotal()">
                <option value="">Seleccione un beneficio</option>
                <option value="1">EMPART</option>
                <option value="2">BANCARIA</option>
                <option value="3">CAPREBECH</option>
                <option value="4">CAPREMER</option>
                <option value="5">TRIOMAR</option>
                <option value="6">HIPICA</option>
                <option value="7">S.S.S.</option>
                <option value="8">OO.MM.REP.</option>
                <option value="9">SALITRE</option>
                <option value="10">C.C.U.</option>
                <option value="11">GILDEMEISTER</option>
                <option value="12">M. HOCHSCHILD</option>
                <option value="13">GASCO</option>
                <option value="14">BONO CHILE APOYA INVIERNO</option>
                <option value="15">EMOS EMPLEADOS</option>
                <option value="16">EMOS OBREROS</option>
                <option value="17">FERROCARRILES</option>
                <option value="18">CANAEMPU PUBLICOS</option>
                <option value="19">CANAEMPU PERIODISTAS</option>
                <option value="20">EE.MM.STGO</option>
                <option value="21">CAMUVAL</option>
                <option value="22">EE.MM.REP.</option>
                <option value="23">BONO CLASE MEDIA BENEFICIARIOS IPS</option>
                <option value="24">IFE UNIVERSAL</option>
                <option value="25">BONO APOYO A LA FAMILIA MARZO 2010</option>
                <option value="26">BONO SOLIDARIO ALIMENTOS BENEFICIARIOS IPS</option>
                <option value="27">INGRESO FAMILIAR DE EMERGENCIA</option>
                <option value="28">BONO A LA CULTURA</option>
                <option value="29">APORTE FAMILIAR PERMANENTE MARZO - IPS</option>
                <option value="30">APORTE FAMILIAR PERMANENTE MARZO</option>
                <option value="31">BENEFICIO LEY 21.247 CRIANZA PROTEGIDA</option>
                <option value="32">INDEMN. CARB√ìN</option>
                <option value="33">LEY REPARACIONES 19.123 (Rettig)</option>
                <option value="34">LEY DE REPARACI√ìN N¬∞ 19.992 (Valech)</option>
                <option value="35">BOLSILLO FAMILIAR ELECTRONICO II</option>
                <option value="36">APORTE COMPENSATORIO CANASTA BASICA</option>
                <option value="37">PENSION GARANTIZADA UNIVERSAL</option>
                <option value="38">BOLSILLO FAMILIAR ELECTRONICO</option>
                <option value="39">PGU CONTRIBUTIVA (EXTERNA)</option>
                <option value="40">BONO APOYO A INGRESOS FAMILIARES</option>
                <option value="41">BONO EXTRAORDINARIO MARZO 2013</option>
                <option value="42">AFAM PAGO DIRECTO A TRABAJADORES</option>
                <option value="43">APS</option>
                <option value="44">SUBSIDIO DISCAPACIDAD MENTAL</option>
                <option value="45">ACCIDENTES DEL TRABAJO</option>
                <option value="46">BONO BODAS DE ORO</option>
                <option value="47">BONO POR HIJO de PBS</option>
                <option value="48">SUBSIDIO TRABAJADOR JOVEN</option>
                <option value="49">SUBSIDIO AL EMPLEO JOVEN</option>
              </select>
            </div>
            <div class="modal-form-group">
              <label>Monto</label>
              <input type="number" class="monto-input" placeholder="0" min="0" step="0.01" required oninput="calcularTotal()">
            </div>
            <button type="button" class="btn-add" onclick="agregarFilaBeneficio()">+</button>
          </div>
        </div>
        <div class="modal-form-group" style="margin-top:24px; padding-top:24px; border-top:2px solid var(--border);">
          <label style="font-size:18px; font-weight:bold;">Total</label>
          <input type="text" id="total-saldo" class="monto-input" value="$0" readonly style="font-size:20px; font-weight:bold; background:#f8f9fa; color:#28a745;">
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-success" onclick="guardarCalculo()">üíæ Guardar C√°lculo</button>
        <button type="button" class="btn btn-secondary" onclick="cerrarModalCalculo()">Cerrar</button>
      </div>
    </div>
  </div>

  <script>
    // Variable global para el expediente actual
    let expedienteActualId = null;
    let solicitudActualId = null;
    
    // Funci√≥n para calcular d√≠gito verificador
    function calcularDV(rut) {
      let suma = 0;
      let multiplicador = 2;
      
      for (let i = rut.length - 1; i >= 0; i--) {
        suma += parseInt(rut[i]) * multiplicador;
        multiplicador = multiplicador < 7 ? multiplicador + 1 : 2;
      }
      
      let resto = suma % 11;
      let dv = 11 - resto;
      
      if (dv === 11) return '0';
      if (dv === 10) return 'K';
      return dv.toString();
    }

    // Funci√≥n para formatear RUT autom√°ticamente
    function formatRUT(e) {
      let input = e.target;
      let value = input.value.replace(/[^0-9kK]/g, '');
      
      if (value.length > 0) {
        // Determinar si es RUT de 7 o 8 d√≠gitos (sin contar el DV)
        const bodyLength = value.length - 1; // Restar el d√≠gito verificador
        
        if (bodyLength <= 7) {
          // Formato: x.xxx.xxx-x (7 d√≠gitos + DV)
          if (value.length > 1) {
            value = value.substring(0, 1) + '.' + value.substring(1);
          }
          if (value.length > 5) {
            value = value.substring(0, 5) + '.' + value.substring(5);
          }
        } else {
          // Formato: xx.xxx.xxx-x (8 d√≠gitos + DV)
          if (value.length > 2) {
            value = value.substring(0, 2) + '.' + value.substring(2);
          }
          if (value.length > 6) {
            value = value.substring(0, 6) + '.' + value.substring(6);
          }
        }
        
        // Agregar gui√≥n antes del √∫ltimo car√°cter si es necesario
        if (value.length > 8 && !value.includes('-')) {
          const lastChar = value.slice(-1);
          value = value.slice(0, -1) + '-' + lastChar;
        }
      }
      
      input.value = value;
    }

    // Variables globales
    let modoEdicion = false;
    
    // Configurar formateo autom√°tico de RUT
    document.addEventListener('DOMContentLoaded', function() {
      const rutField = document.getElementById('rut');
      if (rutField) {
        rutField.addEventListener('input', formatRUT);
      }
      
      // Verificar si hay par√°metros en la URL (modo edici√≥n)
      const urlParams = new URLSearchParams(window.location.search);
      const expedienteIdParam = urlParams.get('expediente_id');
      const solicitudIdParam = urlParams.get('solicitud_id');
      const modoParam = urlParams.get('modo');
      
      if (expedienteIdParam && modoParam === 'edicion') {
        modoEdicion = true;
        expedienteActualId = parseInt(expedienteIdParam);
        solicitudActualId = solicitudIdParam ? parseInt(solicitudIdParam) : null;
        
        // Cargar expediente autom√°ticamente
        cargarExpedientePorId(expedienteActualId);
      }
    });
    
    // Funci√≥n para cargar expediente por ID
    async function cargarExpedientePorId(expedienteId) {
      try {
        // Obtener RUT del causante desde el expediente
        const response = await fetch(`http://localhost:3001/api/expediente/${expedienteId}`, {
          method: 'GET',
          credentials: 'include'
        });
        
        if (response.ok) {
          const resultado = await response.json();
          if (resultado.expediente && resultado.causante) {
            // Llenar el campo RUT y buscar autom√°ticamente
            document.getElementById('rut').value = resultado.causante.fal_run || '';
            document.getElementById('searchForm').dispatchEvent(new Event('submit'));
          }
        }
      } catch (error) {
        console.error('Error cargando expediente:', error);
        alert('Error al cargar el expediente');
      }
    }

    document.getElementById('searchForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      let rut = document.getElementById('rut').value.trim();
      
      if (!rut) {
        alert('Ingresa el RUT del causante');
        return;
      }
      
      // Si el RUT no tiene formato completo, intentar completarlo
      let rutNumeros = rut.replace(/[^0-9]/g, '');
      if (rutNumeros.length >= 7 && rutNumeros.length <= 8 && !rut.includes('-')) {
        // Calcular DV autom√°ticamente si falta
        let dv = calcularDV(rutNumeros);
        rut = rutNumeros + '-' + dv;
        console.log('üîß RUT completado autom√°ticamente:', rut);
      }
      
      // Mostrar loading
      const submitBtn = e.target.querySelector('button[type="submit"]');
      const originalText = submitBtn.textContent;
      submitBtn.textContent = 'Buscando...';
      submitBtn.disabled = true;
      
      try {
        console.log('üîç Buscando expediente por RUT:', rut);
        
        const response = await fetch('http://localhost:3001/api/revision-expediente', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          credentials: 'include',
          body: JSON.stringify({ rut: rut })
        });
        
        console.log('üì° Respuesta recibida:', response.status);
        
        if (!response.ok) {
          // Intentar obtener el mensaje de error del servidor
          let errorMessage = `Error del servidor: ${response.status}`;
          try {
            const errorData = await response.json();
            if (errorData.error) {
              errorMessage = errorData.error;
            }
          } catch (e) {
            console.log('No se pudo obtener mensaje de error detallado');
          }
          throw new Error(errorMessage);
        }
        
        const resultado = await response.json();
        console.log('üìã Resultado completo:', resultado);
        console.log('üîç Datos del funcionario:', resultado.data?.funcionario);
        
        if (resultado.success) {
          if (resultado.data.expediente_id) {
            expedienteActualId = resultado.data.expediente_id;
            solicitudActualId = resultado.data.solicitud?.id || null;
            // Cargar aprobaciones de items si existe solicitud
            if (solicitudActualId) {
              try {
                const aprobResp = await fetch(`http://localhost:3001/api/solicitudes/${solicitudActualId}/aprobacion-items`, {
                  method: 'GET',
                  credentials: 'include'
                });
                if (aprobResp.ok) {
                  const aprobJson = await aprobResp.json();
                  resultado.data.aprobacion_items = aprobJson.data || {};
                }
              } catch (error) {
                console.warn('Error cargando aprobaciones:', error);
              }
            }
            showExpediente(resultado.data);
          } else {
            showNoResults(rut);
          }
        } else {
          throw new Error(resultado.error || 'Error desconocido');
        }
        
      } catch (error) {
        console.error('‚ùå Error en b√∫squeda:', error);
        alert(`‚ùå Error al buscar expediente:\n\n${error.message}\n\nPor favor, verifica que el servidor est√© corriendo y vuelve a intentar.`);
      } finally {
        // Restaurar bot√≥n
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
      }
    });
    
    function showExpediente(data) {
      console.log('üîç Datos recibidos en showExpediente:', data);
      console.log('üîç Funcionario en showExpediente:', data.funcionario);
      document.getElementById('expedienteContent').style.display = 'block';
      document.getElementById('noResults').style.display = 'none';
      
      // Verificar estados
      const estadoSolicitud = data.solicitud?.estado || 'desconocido';
      console.log('üîç Estado de solicitud recibido:', estadoSolicitud);
      
      const estaRechazado = estadoSolicitud === 'rechazado';
      const estaEnRevision = estadoSolicitud === 'rechazado/enRevision';
      const estaPendiente = estadoSolicitud === 'pendiente';
      const estaBloqueado = estaPendiente; // Bloqueado cuando est√° en revisi√≥n de jefatura
      // Puede editar si est√° en modo edici√≥n Y est√° en 'rechazado/enRevision' (no bloqueado)
      // O si est√° en 'rechazado/enRevision' (se puede activar el modo edici√≥n desde aqu√≠)
      const puedeEditar = modoEdicion && estaEnRevision && !estaBloqueado;
      
      // Obtener items rechazados para saber qu√© campos hacer editables
      const itemsRechazados = data.aprobacion_items ? 
        Object.keys(data.aprobacion_items).filter(tipo => 
          data.aprobacion_items[tipo]?.estado === 'rechazado'
        ) : [];
      
      // Funciones helper para verificar si un item es editable
      const esItemEditable = (itemTipo) => {
        return puedeEditar && itemsRechazados.includes(itemTipo);
      };
      
      console.log('üîí Estado bloqueado:', estaBloqueado, '| Pendiente:', estaPendiente);
      
      let html = `
        ${estaBloqueado ? `
        <div style="background: #d1ecf1; border: 2px solid #0c5460; border-radius: 12px; padding: 16px; margin-bottom: 20px;">
          <h3 style="margin: 0 0 8px 0; color: #0c5460;">üîí Expediente Bloqueado</h3>
          <p style="margin: 0; color: #0c5460; font-size: 14px;">
            Este expediente est√° en revisi√≥n de jefatura. No se pueden realizar modificaciones hasta que sea aprobado o rechazado.
          </p>
        </div>
        ` : puedeEditar ? `
        <div style="background: #fff3cd; border: 2px solid #ffc107; border-radius: 12px; padding: 16px; margin-bottom: 20px;">
          <h3 style="margin: 0 0 8px 0; color: #856404;">‚úèÔ∏è Modo Edici√≥n</h3>
          <p style="margin: 0; color: #856404; font-size: 14px;">
            Este expediente fue rechazado. Puedes editar la informaci√≥n y agregar documentos faltantes.
          </p>
        </div>
        ` : ''}
        
        <!-- Informaci√≥n del Expediente -->
        <div class="expediente-info ${puedeEditar ? 'edit-mode' : ''}">
          <h2>üìã Expediente: ${data.expediente_numero}</h2>
          <div class="info-grid">
            <div class="info-section">
              <h3>üë§ Datos del Causante</h3>
              <div class="info-item">
                <span class="info-label">Nombre:</span>
                ${esItemEditable('causante') ? `
                  <input type="text" id="edit_causante_nombre" value="${data.causante.nombre_completo}" style="width: 100%; padding: 8px; border: 1px solid #0d6efd; border-radius: 4px;">
                ` : `
                  <span class="info-value">${data.causante.nombre_completo}</span>
                `}
              </div>
              <div class="info-item">
                <span class="info-label">RUT:</span>
                <span class="info-value">${data.causante.rut}</span>
              </div>
              <div class="info-item">
                <span class="info-label">Fecha Defunci√≥n:</span>
                ${esItemEditable('causante') ? `
                  <input type="date" id="edit_causante_fecha" value="${data.causante.fecha_defuncion && data.causante.fecha_defuncion !== 'No especificada' ? (data.causante.fecha_defuncion.includes('T') ? data.causante.fecha_defuncion.split('T')[0] : data.causante.fecha_defuncion) : ''}" style="width: 100%; padding: 8px; border: 1px solid #0d6efd; border-radius: 4px;">
                ` : `
                  <span class="info-value">${data.causante.fecha_defuncion || 'No especificada'}</span>
                `}
              </div>
              <div class="info-item">
                <span class="info-label">Comuna:</span>
                ${esItemEditable('causante') ? `
                  <input type="text" id="edit_causante_comuna" value="${data.causante.comuna_defuncion || ''}" style="width: 100%; padding: 8px; border: 1px solid #0d6efd; border-radius: 4px;">
                ` : `
                  <span class="info-value">${data.causante.comuna_defuncion}</span>
                `}
              </div>
              <div class="info-item">
                <span class="info-label">Nacionalidad:</span>
                ${esItemEditable('causante') ? `
                  <input type="text" id="edit_causante_nacionalidad" value="${data.causante.nacionalidad || ''}" style="width: 100%; padding: 8px; border: 1px solid #0d6efd; border-radius: 4px;">
                ` : `
                  <span class="info-value">${data.causante.nacionalidad}</span>
                `}
              </div>
            </div>
            
            <div class="info-section">
              <h3>üìÑ Datos del Expediente</h3>
              <div class="info-item">
                <span class="info-label">ID Expediente:</span>
                <span class="info-value">${data.expediente_id}</span>
              </div>
              <div class="info-item">
                <span class="info-label">Folio:</span>
                <span class="info-value">${data.folio}</span>
              </div>
              <div class="info-item">
                <span class="info-label">Estado:</span>
                <span class="info-value" style="color: ${(estaRechazado || estaEnRevision) ? '#dc3545' : '#333'}; font-weight: ${(estaRechazado || estaEnRevision) ? 'bold' : 'normal'}">
                  ${estaRechazado ? '‚ùå RECHAZADO' : estaEnRevision ? 'üîÑ RECHAZADO/EN REVISI√ìN' : data.estado_expediente}
                </span>
              </div>
              <div class="info-item">
                <span class="info-label">Fecha Creaci√≥n:</span>
                <span class="info-value">${data.fecha_creacion}</span>
              </div>
              <div class="info-item">
                <span class="info-label">Sucursal:</span>
                ${puedeEditar ? `
                  <input type="text" id="edit_sucursal" value="${data.solicitud.sucursal || ''}" style="width: 100%; padding: 8px; border: 1px solid #0d6efd; border-radius: 4px;">
                ` : `
                  <span class="info-value">${data.solicitud.sucursal}</span>
                `}
              </div>
              <div class="info-item">
                <span class="info-label">Funcionario Responsable:</span>
                <span class="info-value">${data.funcionario.nombre_completo}</span>
              </div>
            </div>
          </div>
          
          ${puedeEditar ? `
          <div style="margin-top: 20px; text-align: center; padding-top: 20px; border-top: 2px solid #ffc107;">
            <button 
              class="btn btn-success" 
              ${estaBloqueado ? 'disabled style="opacity: 0.5; cursor: not-allowed;"' : ''}
              onclick="${estaBloqueado ? 'alert(\'‚ö†Ô∏è No se pueden guardar cambios. El expediente est√° en revisi√≥n de jefatura.\')' : `guardarCambiosExpediente(${data.expediente_id})`}" 
              style="font-size: 16px; padding: 12px 24px; margin-right: 10px; ${estaBloqueado ? 'opacity: 0.5; cursor: not-allowed;' : ''}">
              üíæ Guardar Cambios
            </button>
            <button 
              class="btn btn-warning" 
              ${estaBloqueado ? 'disabled style="opacity: 0.5; cursor: not-allowed;"' : ''}
              onclick="${estaBloqueado ? 'alert(\'‚ö†Ô∏è No se pueden agregar documentos. El expediente est√° en revisi√≥n de jefatura.\')' : `agregarDocumento(${data.expediente_id}, ${solicitudActualId})`}" 
              style="font-size: 16px; padding: 12px 24px; ${estaBloqueado ? 'opacity: 0.5; cursor: not-allowed;' : ''}">
              üìÅ Agregar Documento
            </button>
          </div>
          ` : ''}
        </div>
        
        <!-- Estado de Firmas -->
        <div class="status-card">
          <div class="status-header">
            <span class="status-icon">${data.firmas.icono}</span>
            <h3 class="status-title">Estado de Firmas Digitales</h3>
          </div>
          <div class="status-details">
            <div class="status-item">
              <div class="status-number">${data.firmas.total_firmas || 0}</div>
              <div class="status-label">Total Firmas</div>
            </div>
            <div class="status-item">
              <div class="status-number">${data.firmas.firmas_completadas || 0}</div>
              <div class="status-label">Firmadas</div>
            </div>
            <div class="status-item">
              <div class="status-number">${data.firmas.pendientes || 0}</div>
              <div class="status-label">Pendientes</div>
            </div>
            <div class="status-item">
              <div class="status-number" style="color:${data.firmas.color}">${data.firmas.estado}</div>
              <div class="status-label">Estado General</div>
            </div>
          </div>
        </div>
        
        ${(estaRechazado || estaEnRevision) && data.aprobacion_items ? `
        <!-- Secci√≥n de Rechazos -->
        <div class="status-card" style="border-left: 4px solid #dc3545; background: #fff5f5;">
          <div class="status-header">
            <span class="status-icon">‚ö†Ô∏è</span>
            <h3 class="status-title" style="color: #dc3545;">Items Rechazados por Jefatura</h3>
          </div>
          <div style="margin-top: 16px;">
            ${Object.entries(data.aprobacion_items).filter(([tipo, item]) => item.estado === 'rechazado').map(([tipo, item]) => `
              <div style="background: #fff; padding: 16px; border-radius: 8px; margin-bottom: 12px; border-left: 4px solid #dc3545;">
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                  <h4 style="margin: 0; color: #333;">
                    ${tipo === 'causante' ? 'üë§ Causante' : 
                      tipo === 'beneficiarios' ? 'üë• Beneficiarios' : 
                      tipo === 'firmas' ? '‚úçÔ∏è Firmas' : 
                      tipo === 'calculo' ? 'üí∞ C√°lculo' : 
                      tipo === 'documentos' ? 'üìÅ Documentos' : tipo}
                  </h4>
                  <span style="padding: 4px 12px; background: #dc3545; color: white; border-radius: 12px; font-size: 12px;">‚ùå Rechazado</span>
                </div>
                <div style="margin-top: 8px;">
                  <strong style="color: #666; font-size: 13px;">Observaci√≥n:</strong>
                  <p style="margin: 4px 0 0 0; color: #333; font-size: 14px; background: #f8f9fa; padding: 8px; border-radius: 4px;">
                    ${item.observacion || 'Sin observaci√≥n'}
                  </p>
                </div>
                ${item.fecha_aprobacion ? `
                  <div style="margin-top: 8px; font-size: 12px; color: #666;">
                    üìÖ ${new Date(item.fecha_aprobacion).toLocaleDateString('es-CL')} ${item.aprobado_por ? `| üë§ ${item.aprobado_por}` : ''}
                  </div>
                ` : ''}
              </div>
            `).join('')}
            ${Object.entries(data.aprobacion_items).filter(([tipo, item]) => item.estado === 'rechazado').length === 0 ? `
              <p style="color: #666; text-align: center; padding: 20px;">No hay items rechazados registrados</p>
            ` : ''}
          </div>
          ${!modoEdicion && estaEnRevision ? `
          <div style="margin-top: 20px; padding: 16px; background: #fff3cd; border-radius: 8px; border: 2px solid #ffc107;">
            <p style="margin: 0 0 12px 0; color: #856404; font-weight: 600;">
              ‚úèÔ∏è Este expediente fue rechazado. Puedes editarlo para corregir los items rechazados.
            </p>
            <button class="btn btn-warning" onclick="activarModoEdicion()" style="font-size: 16px; padding: 12px 24px;">
              ‚úèÔ∏è Editar Expediente
            </button>
          </div>
          ` : ''}
          
          ${modoEdicion && estaEnRevision ? `
          <div style="margin-top: 20px; padding: 16px; background: #d4edda; border-radius: 8px; border: 2px solid #28a745;">
            <p style="margin: 0 0 12px 0; color: #155724; font-weight: 600;">
              ‚úÖ Modo Edici√≥n Activo - Solo los items rechazados son editables
            </p>
            <div style="display: flex; gap: 10px; justify-content: center;">
              <button class="btn btn-success" onclick="guardarCambiosExpediente(${data.expediente_id})" style="font-size: 16px; padding: 12px 24px;">
                üíæ Guardar Cambios
              </button>
              <button class="btn btn-primary" onclick="reenviarSolicitud(${solicitudActualId})" style="font-size: 16px; padding: 12px 24px;">
                üì§ Reenviar a Revisi√≥n
              </button>
            </div>
          </div>
          ` : estaEnRevision && !modoEdicion ? `
          <div style="margin-top: 20px; padding: 16px; background: #d4edda; border-radius: 8px; border: 2px solid #28a745; text-align: center;">
            <strong style="color: #155724;">‚úÖ Solicitud enviada a revisi√≥n</strong>
            <p style="margin: 4px 0 0 0; font-size: 14px; color: #155724;">La jefatura est√° evaluando las correcciones realizadas.</p>
          </div>
          ` : ''}
        </div>
        ` : ''}
        
        <!-- Datos del Representante -->
        <div class="status-card ${esItemEditable('representante') ? 'edit-mode' : ''}">
          <div class="status-header">
            <span class="status-icon">üë®‚Äçüíº</span>
            <h3 class="status-title">Datos del Representante</h3>
            <div style="margin-left: auto;">
              <span class="firma-status" style="background: ${data.representante.firmado ? '#d4edda' : '#f8d7da'}; color: ${data.representante.firmado ? '#155724' : '#721c24'}; padding: 6px 12px; border-radius: 20px; font-size: 14px; font-weight: 600;">
                ${data.representante.firmado ? '‚úÖ Firmado' : '‚ùå Sin firmar'}
              </span>
            </div>
          </div>
          <div class="status-details">
            <div class="status-item">
              <div class="status-label">Nombre Completo</div>
              ${esItemEditable('representante') ? `
                <input type="text" id="edit_rep_nombre" value="${data.representante.nombre_completo || ''}" style="width: 100%; padding: 8px; border: 1px solid #0d6efd; border-radius: 4px; margin-top: 4px;">
              ` : `
                <div class="status-number" style="font-size: 16px; color: #333;">${data.representante.nombre_completo}</div>
              `}
            </div>
            <div class="status-item">
              <div class="status-label">RUT</div>
              ${esItemEditable('representante') ? `
                <input type="text" id="edit_rep_rut" value="${data.representante.rut || ''}" style="width: 100%; padding: 8px; border: 1px solid #0d6efd; border-radius: 4px; margin-top: 4px;">
              ` : `
                <div class="status-number" style="font-size: 16px; color: #333;">${data.representante.rut}</div>
              `}
            </div>
            <div class="status-item">
              <div class="status-label">Calidad</div>
              ${esItemEditable('representante') ? `
                <input type="text" id="edit_rep_calidad" value="${data.representante.calidad || ''}" style="width: 100%; padding: 8px; border: 1px solid #0d6efd; border-radius: 4px; margin-top: 4px;">
              ` : `
                <div class="status-number" style="font-size: 16px; color: #333;">${data.representante.calidad}</div>
              `}
            </div>
            <div class="status-item">
              <div class="status-label">Tel√©fono</div>
              ${esItemEditable('representante') ? `
                <input type="text" id="edit_rep_telefono" value="${data.representante.telefono || ''}" style="width: 100%; padding: 8px; border: 1px solid #0d6efd; border-radius: 4px; margin-top: 4px;">
              ` : `
                <div class="status-number" style="font-size: 16px; color: #333;">${data.representante.telefono}</div>
              `}
            </div>
            <div class="status-item">
              <div class="status-label">Email</div>
              ${esItemEditable('representante') ? `
                <input type="email" id="edit_rep_email" value="${data.representante.email || ''}" style="width: 100%; padding: 8px; border: 1px solid #0d6efd; border-radius: 4px; margin-top: 4px;">
              ` : `
                <div class="status-number" style="font-size: 16px; color: #333;">${data.representante.email}</div>
              `}
            </div>
          </div>
        </div>
        
        <!-- Lista de Beneficiarios -->
        <div class="beneficiarios-section">
          <div class="documentos-header">
            <h3>üë• Beneficiarios (${data.beneficiarios.length})</h3>
            ${esItemEditable('beneficiarios') ? `
              <button class="btn btn-success" onclick="agregarBeneficiario()" style="padding: 8px 16px; font-size: 14px;">
                ‚ûï Agregar Beneficiario
              </button>
            ` : ''}
          </div>
          <div class="beneficiarios-list">
      `;
      
      data.beneficiarios.forEach((beneficiario, index) => {
        const firmaIcon = beneficiario.firma.firmado ? '‚úÖ' : '‚ùå';
        const firmaText = beneficiario.firma.firmado ? 'Firmado' : 'Sin firmar';
        const firmaColor = beneficiario.firma.firmado ? 'color:#28a745' : 'color:#dc3545';
        
        html += `
          <div class="beneficiario-item" id="beneficiario-${beneficiario.id || index}">
            <div class="beneficiario-info">
              ${esItemEditable('beneficiarios') ? `
                <input type="text" class="edit-beneficiario-nombre" value="${beneficiario.nombre_completo}" data-id="${beneficiario.id || index}" style="width: 100%; padding: 8px; border: 1px solid #0d6efd; border-radius: 4px; margin-bottom: 4px;">
                <div style="display: flex; gap: 8px; margin-top: 4px;">
                  <input type="text" class="edit-beneficiario-rut" value="${beneficiario.rut}" data-id="${beneficiario.id || index}" placeholder="RUT" style="flex: 1; padding: 8px; border: 1px solid #0d6efd; border-radius: 4px;">
                  <input type="text" class="edit-beneficiario-parentesco" value="${beneficiario.parentesco}" data-id="${beneficiario.id || index}" placeholder="Parentesco" style="flex: 1; padding: 8px; border: 1px solid #0d6efd; border-radius: 4px;">
                </div>
                <button class="btn btn-danger" onclick="eliminarBeneficiario(${beneficiario.id || index})" style="margin-top: 8px; padding: 4px 12px; font-size: 12px;">
                  üóëÔ∏è Eliminar
                </button>
              ` : `
                <div class="beneficiario-nombre">${beneficiario.nombre_completo}</div>
                <div class="beneficiario-detalles">
                  RUT: ${beneficiario.rut} | Parentesco: ${beneficiario.parentesco}
                </div>
              `}
            </div>
            ${!esItemEditable('beneficiarios') ? `
            <div class="firma-status">
              <span class="firma-check" style="${firmaColor}">${firmaIcon}</span>
              <span style="${firmaColor}">${firmaText}</span>
            </div>
            ` : ''}
          </div>
        `;
      });
      
      html += `
          </div>
        </div>
        
        <!-- Lista de Documentos -->
        <div class="documentos-section">
          <div class="documentos-header">
            <h3>üìÅ Documentos (${data.documentos.total})</h3>
            <div style="display: flex; gap: 10px; align-items: center;">
              <span class="documentos-count">${data.documentos.total} archivos</span>
              ${esItemEditable('documentos') ? `
                <button class="btn btn-success" onclick="agregarDocumento(${data.expediente_id}, ${solicitudActualId})" style="padding: 8px 16px; font-size: 14px;">
                  ‚ûï Agregar Documento
                </button>
              ` : ''}
            </div>
          </div>
          <div class="documentos-list">
      `;
      
      if (data.documentos.lista.length > 0) {
        data.documentos.lista.forEach(documento => {
          html += `
            <div class="documento-item" id="documento-${documento.id}">
              <div class="documento-info">
                <div class="documento-nombre">${documento.nombre}</div>
                <div class="documento-detalles">
                  ${documento.mime_type} ‚Ä¢ ${documento.tamano_mb} MB ‚Ä¢ Subido: ${documento.fecha_subida}
                </div>
              </div>
              <div class="documento-acciones">
                <button class="btn btn-success" onclick="descargarDocumento(${documento.id})">
                  üì• Descargar
                </button>
                ${esItemEditable('documentos') ? `
                  <button class="btn btn-danger" onclick="eliminarDocumento(${documento.id})" style="margin-left: 8px;">
                    üóëÔ∏è Eliminar
                  </button>
                ` : ''}
              </div>
            </div>
          `;
        });
      } else {
        html += `
          <div style="text-align:center; padding:20px; color:#666;">
            No hay documentos cargados en este expediente.
            ${esItemEditable('documentos') ? '<br><button class="btn btn-success" onclick="agregarDocumento(' + data.expediente_id + ', ' + solicitudActualId + ')" style="margin-top: 12px;">‚ûï Agregar Primer Documento</button>' : ''}
          </div>
        `;
      }
      
      html += `
          </div>
        </div>
        
        <!-- Descarga Completa -->
        <div class="download-section">
          <h3 class="download-title">üì¶ Descargar Expediente Completo</h3>
          <p class="download-description">
            Descarga todos los documentos del expediente en un archivo ZIP comprimido.
          </p>
          <button class="btn btn-success" onclick="descargarExpedienteCompleto(${data.expediente_id})">
            üì¶ Descargar Expediente Completo
          </button>
          
          <!-- Bot√≥n Calcular/Modificar Saldo Insoluto -->
          <div style="margin-top:20px;">
            ${esItemEditable('calculo') ? `
              <button 
                id="btn-calcular-saldo" 
                class="btn-calculate enabled" 
                onclick="abrirModalCalculo(${data.expediente_id}, true)">
                ‚úèÔ∏è Modificar C√°lculo de Saldo Insoluto
              </button>
              <p style="color:#856404; font-size:14px; margin-top:8px;">‚ö†Ô∏è El c√°lculo fue rechazado. Puedes modificarlo.</p>
            ` : `
              <button 
                id="btn-calcular-saldo" 
                class="btn-calculate ${data.firmas.pendientes === 0 && data.representante.firmado && !estaBloqueado ? 'enabled' : 'disabled'}" 
                ${data.firmas.pendientes === 0 && data.representante.firmado && !estaBloqueado ? '' : 'disabled'}
                onclick="${estaBloqueado ? 'alert(\'‚ö†Ô∏è No se puede calcular el saldo insoluto. El expediente est√° en revisi√≥n de jefatura.\')' : `abrirModalCalculo(${data.expediente_id})`}">
                üí∞ Calcular Saldo Insoluto
              </button>
              ${estaBloqueado ? 
                '<p style="color:#0c5460; font-size:14px; margin-top:8px;">üîí Expediente bloqueado en revisi√≥n de jefatura</p>' 
                : data.firmas.pendientes > 0 || !data.representante.firmado ? 
                  '<p style="color:#dc3545; font-size:14px; margin-top:8px;">‚ö†Ô∏è Faltan firmas por completar</p>' 
                  : '<p style="color:#28a745; font-size:14px; margin-top:8px;">‚úÖ Todas las firmas est√°n completas</p>'
              }
            `}
          </div>
          
          <!-- Bot√≥n Regresar al Inicio -->
          <div style="margin-top:20px;">
            <button class="btn btn-inicio" onclick="window.location.href='index.html'">
              üè† Regresar al Inicio
            </button>
          </div>
        </div>
      `;
      
      document.getElementById('expedienteContent').innerHTML = html;
      
      // Verificar si ya existe un c√°lculo activo y deshabilitar bot√≥n
      verificarYActualizarEstadoCalculo(data.expediente_id);
    }
    
    async function verificarYActualizarEstadoCalculo(expedienteId) {
      try {
        const response = await fetch(`http://localhost:3001/api/expediente/${expedienteId}/calculo-existente`, {
          method: 'GET',
          credentials: 'include'
        });
        
        const resultado = await response.json();
        
        if (resultado.existe && resultado.calculo.estado !== 'rechazado') {
          const btn = document.getElementById('btn-calcular-saldo');
          if (btn) {
            btn.disabled = true;
            btn.classList.remove('enabled');
            btn.classList.add('disabled');
            btn.title = `Ya existe un c√°lculo ${resultado.calculo.estado} para este expediente`;
          }
          
          // Mostrar mensaje informativo
          const btnContainer = btn?.parentElement;
          if (btnContainer) {
            const infoMsg = document.createElement('p');
            infoMsg.style.cssText = 'color:#ffc107; font-size:14px; margin-top:8px;';
            infoMsg.textContent = `‚ö†Ô∏è Ya existe un c√°lculo ${resultado.calculo.estado} (Total: $${resultado.calculo.total_calculado.toLocaleString('es-CL')})`;
            btnContainer.appendChild(infoMsg);
          }
        }
      } catch (error) {
        console.error('Error verificando c√°lculo:', error);
      }
    }
    
    function showNoResults(rut) {
      document.getElementById('expedienteContent').style.display = 'none';
      document.getElementById('noResults').style.display = 'block';
      
      document.getElementById('noResults').innerHTML = `
        <div style="text-align:center; padding:40px;">
          <div style="font-size:48px; margin-bottom:16px;">üîç</div>
          <h3>No se encontr√≥ expediente</h3>
          <p>No se encontr√≥ ning√∫n expediente para el RUT: <strong>${rut}</strong></p>
          <p style="color:#6c757d; font-size:14px;">
            Verifica que el RUT est√© correcto o que exista un expediente para esta persona.
          </p>
        </div>
      `;
    }
    
    function descargarDocumento(documentoId) {
      window.open(`http://localhost:3001/api/download-documento/${documentoId}`, '_blank');
    }
    
    function descargarExpedienteCompleto(expedienteId) {
      // Descargar expediente completo como ZIP
      console.log('üì¶ Descargando expediente completo:', expedienteId);
      window.open(`http://localhost:3001/api/download-expediente-completo/${expedienteId}`, '_blank');
    }
    
    // Funciones para el modal de c√°lculo
    async function abrirModalCalculo(expedienteId, esModificacion = false) {
      // Si es modificaci√≥n, cargar el c√°lculo existente
      if (esModificacion) {
        try {
          const response = await fetch(`http://localhost:3001/api/expediente/${expedienteId}/calculo-completo`, {
            method: 'GET',
            credentials: 'include'
          });
          
          const resultado = await response.json();
          
          if (resultado.existe && resultado.calculo) {
            // Cargar los beneficios existentes en el modal
            const beneficiosContainer = document.getElementById('beneficios-container');
            if (beneficiosContainer && resultado.detalles) {
              beneficiosContainer.innerHTML = '';
              resultado.detalles.forEach((detalle, index) => {
                agregarFilaBeneficio(detalle.beneficio_codigo, detalle.beneficio_nombre, detalle.monto);
              });
              calcularTotal();
            }
          }
        } catch (error) {
          console.error('Error cargando c√°lculo:', error);
        }
      } else {
        // Verificar si ya existe un c√°lculo activo
        try {
          const response = await fetch(`http://localhost:3001/api/expediente/${expedienteId}/calculo-existente`, {
            method: 'GET',
            credentials: 'include'
          });
          
          const resultado = await response.json();
          
          if (resultado.existe && resultado.calculo.estado !== 'rechazado') {
            alert(`‚ö†Ô∏è Ya existe un c√°lculo ${resultado.calculo.estado} para este expediente.\n\n` +
                  `Total: $${resultado.calculo.total_calculado.toLocaleString('es-CL')}\n` +
                  `Fecha: ${new Date(resultado.calculo.fecha_calculo).toLocaleDateString('es-CL')}\n\n` +
                  `Solo se puede recalcular si el c√°lculo fue rechazado.`);
            return;
          }
        } catch (error) {
          console.error('Error verificando c√°lculo:', error);
          // Continuar si hay error en la verificaci√≥n
        }
      }
      
      expedienteActualId = expedienteId;
      const modal = document.getElementById('modal-calculo');
      modal.style.display = 'flex';
    }
    
    function cerrarModalCalculo(event) {
      if (event && event.target.id !== 'modal-calculo') {
        return; // Solo cerrar si se hace click en el overlay
      }
      const modal = document.getElementById('modal-calculo');
      modal.style.display = 'none';
      expedienteActualId = null;
      // Limpiar el contenedor de beneficios al cerrar
      const container = document.getElementById('beneficios-container');
      container.innerHTML = `
        <div class="beneficio-row">
          <div class="modal-form-group">
            <label>Beneficio</label>
            <select class="beneficio-select" required>
              <option value="">Seleccione un beneficio</option>
              <option value="1">EMPART</option>
              <option value="2">BANCARIA</option>
              <option value="3">CAPREBECH</option>
              <option value="4">CAPREMER</option>
              <option value="5">TRIOMAR</option>
              <option value="6">HIPICA</option>
              <option value="7">S.S.S.</option>
              <option value="8">OO.MM.REP.</option>
              <option value="9">SALITRE</option>
              <option value="10">C.C.U.</option>
              <option value="11">GILDEMEISTER</option>
              <option value="12">M. HOCHSCHILD</option>
              <option value="13">GASCO</option>
              <option value="14">BONO CHILE APOYA INVIERNO</option>
              <option value="15">EMOS EMPLEADOS</option>
              <option value="16">EMOS OBREROS</option>
              <option value="17">FERROCARRILES</option>
              <option value="18">CANAEMPU PUBLICOS</option>
              <option value="19">CANAEMPU PERIODISTAS</option>
              <option value="20">EE.MM.STGO</option>
              <option value="21">CAMUVAL</option>
              <option value="22">EE.MM.REP.</option>
              <option value="23">BONO CLASE MEDIA BENEFICIARIOS IPS</option>
              <option value="24">IFE UNIVERSAL</option>
              <option value="25">BONO APOYO A LA FAMILIA MARZO 2010</option>
              <option value="26">BONO SOLIDARIO ALIMENTOS BENEFICIARIOS IPS</option>
              <option value="27">INGRESO FAMILIAR DE EMERGENCIA</option>
              <option value="28">BONO A LA CULTURA</option>
              <option value="29">APORTE FAMILIAR PERMANENTE MARZO - IPS</option>
              <option value="30">APORTE FAMILIAR PERMANENTE MARZO</option>
              <option value="31">BENEFICIO LEY 21.247 CRIANZA PROTEGIDA</option>
              <option value="32">INDEMN. CARB√ìN</option>
              <option value="33">LEY REPARACIONES 19.123 (Rettig)</option>
              <option value="34">LEY DE REPARACI√ìN N¬∞ 19.992 (Valech)</option>
              <option value="35">BOLSILLO FAMILIAR ELECTRONICO II</option>
              <option value="36">APORTE COMPENSATORIO CANASTA BASICA</option>
              <option value="37">PENSION GARANTIZADA UNIVERSAL</option>
              <option value="38">BOLSILLO FAMILIAR ELECTRONICO</option>
              <option value="39">PGU CONTRIBUTIVA (EXTERNA)</option>
              <option value="40">BONO APOYO A INGRESOS FAMILIARES</option>
              <option value="41">BONO EXTRAORDINARIO MARZO 2013</option>
              <option value="42">AFAM PAGO DIRECTO A TRABAJADORES</option>
              <option value="43">APS</option>
              <option value="44">SUBSIDIO DISCAPACIDAD MENTAL</option>
              <option value="45">ACCIDENTES DEL TRABAJO</option>
              <option value="46">BONO BODAS DE ORO</option>
              <option value="47">BONO POR HIJO de PBS</option>
              <option value="48">SUBSIDIO TRABAJADOR JOVEN</option>
            <option value="49">SUBSIDIO AL EMPLEO JOVEN</option>
          </select>
        </div>
        <div class="modal-form-group">
          <label>Monto</label>
          <input type="number" class="monto-input" placeholder="0" min="0" step="0.01" required oninput="calcularTotal()">
        </div>
          <button type="button" class="btn-add" onclick="agregarFilaBeneficio()">+</button>
        </div>
        <div class="modal-form-group" style="margin-top:24px; padding-top:24px; border-top:2px solid var(--border);">
          <label style="font-size:18px; font-weight:bold;">Total</label>
          <input type="text" id="total-saldo" class="monto-input" value="$0" readonly style="font-size:20px; font-weight:bold; background:#f8f9fa; color:#28a745;">
        </div>
      `;
    }
    
    function agregarFilaBeneficio() {
      const container = document.getElementById('beneficios-container');
      const nuevasFilas = container.querySelectorAll('.beneficio-row');
      
      // Cambiar el bot√≥n + de la primera fila a - si hay m√°s de una fila
      if (nuevasFilas.length === 1) {
        nuevasFilas[0].querySelector('.btn-add').outerHTML = '<button type="button" class="btn-remove" onclick="eliminarFilaBeneficio(this)">-</button>';
      }
      
      const nuevaFila = document.createElement('div');
      nuevaFila.className = 'beneficio-row';
      nuevaFila.innerHTML = `
        <div class="modal-form-group">
          <label>Beneficio</label>
          <select class="beneficio-select" required>
            <option value="">Seleccione un beneficio</option>
            <option value="1">EMPART</option>
            <option value="2">BANCARIA</option>
            <option value="3">CAPREBECH</option>
            <option value="4">CAPREMER</option>
            <option value="5">TRIOMAR</option>
            <option value="6">HIPICA</option>
            <option value="7">S.S.S.</option>
            <option value="8">OO.MM.REP.</option>
            <option value="9">SALITRE</option>
            <option value="10">C.C.U.</option>
            <option value="11">GILDEMEISTER</option>
            <option value="12">M. HOCHSCHILD</option>
            <option value="13">GASCO</option>
            <option value="14">BONO CHILE APOYA INVIERNO</option>
            <option value="15">EMOS EMPLEADOS</option>
            <option value="16">EMOS OBREROS</option>
            <option value="17">FERROCARRILES</option>
            <option value="18">CANAEMPU PUBLICOS</option>
            <option value="19">CANAEMPU PERIODISTAS</option>
            <option value="20">EE.MM.STGO</option>
            <option value="21">CAMUVAL</option>
            <option value="22">EE.MM.REP.</option>
            <option value="23">BONO CLASE MEDIA BENEFICIARIOS IPS</option>
            <option value="24">IFE UNIVERSAL</option>
            <option value="25">BONO APOYO A LA FAMILIA MARZO 2010</option>
            <option value="26">BONO SOLIDARIO ALIMENTOS BENEFICIARIOS IPS</option>
            <option value="27">INGRESO FAMILIAR DE EMERGENCIA</option>
            <option value="28">BONO A LA CULTURA</option>
            <option value="29">APORTE FAMILIAR PERMANENTE MARZO - IPS</option>
            <option value="30">APORTE FAMILIAR PERMANENTE MARZO</option>
            <option value="31">BENEFICIO LEY 21.247 CRIANZA PROTEGIDA</option>
            <option value="32">INDEMN. CARB√ìN</option>
            <option value="33">LEY REPARACIONES 19.123 (Rettig)</option>
            <option value="34">LEY DE REPARACI√ìN N¬∞ 19.992 (Valech)</option>
            <option value="35">BOLSILLO FAMILIAR ELECTRONICO II</option>
            <option value="36">APORTE COMPENSATORIO CANASTA BASICA</option>
            <option value="37">PENSION GARANTIZADA UNIVERSAL</option>
            <option value="38">BOLSILLO FAMILIAR ELECTRONICO</option>
            <option value="39">PGU CONTRIBUTIVA (EXTERNA)</option>
            <option value="40">BONO APOYO A INGRESOS FAMILIARES</option>
            <option value="41">BONO EXTRAORDINARIO MARZO 2013</option>
            <option value="42">AFAM PAGO DIRECTO A TRABAJADORES</option>
            <option value="43">APS</option>
            <option value="44">SUBSIDIO DISCAPACIDAD MENTAL</option>
            <option value="45">ACCIDENTES DEL TRABAJO</option>
            <option value="46">BONO BODAS DE ORO</option>
            <option value="47">BONO POR HIJO de PBS</option>
            <option value="48">SUBSIDIO TRABAJADOR JOVEN</option>
            <option value="49">SUBSIDIO AL EMPLEO JOVEN</option>
          </select>
        </div>
        <div class="modal-form-group">
          <label>Monto</label>
          <input type="number" class="monto-input" placeholder="0" min="0" step="0.01" required oninput="calcularTotal()">
        </div>
        <button type="button" class="btn-add" onclick="agregarFilaBeneficio()">+</button>
      `;
      container.appendChild(nuevaFila);
    }
    
    function eliminarFilaBeneficio(btn) {
      const fila = btn.closest('.beneficio-row');
      const container = document.getElementById('beneficios-container');
      const filas = container.querySelectorAll('.beneficio-row');
      
      // Si solo queda una fila, cambiar el bot√≥n - a +
      if (filas.length === 1) {
        btn.outerHTML = '<button type="button" class="btn-add" onclick="agregarFilaBeneficio()">+</button>';
      } else {
        fila.remove();
      }
      calcularTotal();
    }
    
    function calcularTotal() {
      const montos = document.querySelectorAll('.monto-input:not(#total-saldo)');
      let total = 0;
      
      montos.forEach(input => {
        const valor = parseFloat(input.value) || 0;
        total += valor;
      });
      
      const totalInput = document.getElementById('total-saldo');
      if (totalInput) {
        totalInput.value = '$' + total.toLocaleString('es-CL', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
      }
    }
    
    // Funci√≥n para activar modo edici√≥n
    function activarModoEdicion() {
      if (!expedienteActualId || !solicitudActualId) {
        alert('‚ùå Error: No se encontr√≥ el ID del expediente o solicitud');
        return;
      }
      
      // Recargar la p√°gina con par√°metros de modo edici√≥n
      window.location.href = `RevisionExpediente.html?expediente_id=${expedienteActualId}&solicitud_id=${solicitudActualId}&modo=edicion`;
    }
    
    async function reenviarSolicitud(solicitudId) {
      if (!confirm('¬øEst√°s seguro de que deseas reenviar esta solicitud para nueva evaluaci√≥n?\n\nLos items rechazados se resetear√°n a pendiente y la solicitud volver√° a la cola de jefatura.')) {
        return;
      }
      
      try {
        const response = await fetch(`http://localhost:3001/api/solicitudes/${solicitudId}/reenviar`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include'
        });
        
        if (response.ok) {
          const result = await response.json();
          alert('‚úÖ Solicitud reenviada exitosamente. La jefatura podr√° evaluarla nuevamente.');
          // Si est√° en modo edici√≥n, volver a BusquedaSaldoInsoluto
          if (modoEdicion) {
            window.location.href = 'BusquedaSaldoInsoluto.html';
          } else {
            // Recargar el expediente
            document.getElementById('searchForm').dispatchEvent(new Event('submit'));
          }
        } else {
          const error = await response.json();
          alert(`‚ùå Error: ${error.error || 'Error al reenviar solicitud'}`);
        }
      } catch (error) {
        alert(`‚ùå Error: ${error.message}`);
      }
    }
    
    async function enviarSolicitudRevision(solicitudId) {
      if (!confirm('¬øEst√°s seguro de que deseas enviar esta solicitud a revisi√≥n?\n\nLa solicitud aparecer√° en la cola de jefatura para nueva evaluaci√≥n.')) {
        return;
      }
      
      try {
        const response = await fetch(`http://localhost:3001/api/solicitudes/${solicitudId}/enviar`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include'
        });
        
        if (response.ok) {
          const result = await response.json();
          alert('‚úÖ Solicitud enviada a revisi√≥n exitosamente. La jefatura podr√° evaluarla nuevamente.');
          // Si est√° en modo edici√≥n, volver a BusquedaSaldoInsoluto
          if (modoEdicion) {
            window.location.href = 'BusquedaSaldoInsoluto.html';
          } else {
            // Recargar el expediente
            document.getElementById('searchForm').dispatchEvent(new Event('submit'));
          }
        } else {
          const error = await response.json();
          alert(`‚ùå Error: ${error.error || 'Error al enviar solicitud a revisi√≥n'}`);
        }
      } catch (error) {
        alert(`‚ùå Error: ${error.message || 'Error al enviar solicitud a revisi√≥n'}`);
      }
    }
    
    // Funci√≥n para guardar cambios del expediente
    async function guardarCambiosExpediente(expedienteId) {
      if (!confirm('¬øGuardar los cambios realizados en este expediente?')) {
        return;
      }
      
      try {
        // Recopilar datos de beneficiarios editables
        const beneficiariosActualizados = [];
        if (document.querySelectorAll('.edit-beneficiario-nombre').length > 0) {
          document.querySelectorAll('.edit-beneficiario-nombre').forEach(input => {
            const id = input.getAttribute('data-id');
            const nombre = input.value;
            const rutInput = document.querySelector(`.edit-beneficiario-rut[data-id="${id}"]`);
            const parentescoInput = document.querySelector(`.edit-beneficiario-parentesco[data-id="${id}"]`);
            if (nombre && rutInput) {
              beneficiariosActualizados.push({
                id: id,
                nombre: nombre,
                rut: rutInput.value || '',
                parentesco: parentescoInput?.value || ''
              });
            }
          });
        }
        
        const datosActualizados = {
          causante: document.getElementById('edit_causante_nombre') ? {
            nombre_completo: document.getElementById('edit_causante_nombre')?.value || '',
            fecha_defuncion: document.getElementById('edit_causante_fecha')?.value || '',
            comuna_defuncion: document.getElementById('edit_causante_comuna')?.value || '',
            nacionalidad: document.getElementById('edit_causante_nacionalidad')?.value || ''
          } : null,
          representante: document.getElementById('edit_rep_nombre') ? {
            nombre_completo: document.getElementById('edit_rep_nombre')?.value || '',
            rut: document.getElementById('edit_rep_rut')?.value || '',
            calidad: document.getElementById('edit_rep_calidad')?.value || '',
            telefono: document.getElementById('edit_rep_telefono')?.value || '',
            email: document.getElementById('edit_rep_email')?.value || ''
          } : null,
          beneficiarios: beneficiariosActualizados.length > 0 ? beneficiariosActualizados : null,
          sucursal: document.getElementById('edit_sucursal')?.value || ''
        };
        
        const response = await fetch(`http://localhost:3001/api/expediente/${expedienteId}/actualizar`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify(datosActualizados)
        });
        
        if (response.ok) {
          alert('‚úÖ Cambios guardados exitosamente');
          // Recargar el expediente
          document.getElementById('searchForm').dispatchEvent(new Event('submit'));
        } else {
          const error = await response.json();
          alert(`‚ùå Error: ${error.error || 'Error al guardar cambios'}`);
        }
      } catch (error) {
        alert(`‚ùå Error: ${error.message}`);
      }
    }
    
    // Funci√≥n para agregar beneficiario
    function agregarBeneficiario() {
      const container = document.querySelector('.beneficiarios-list');
      if (!container) return;
      
      const nuevoId = 'nuevo-' + Date.now();
      const nuevoBeneficiario = document.createElement('div');
      nuevoBeneficiario.className = 'beneficiario-item';
      nuevoBeneficiario.id = `beneficiario-${nuevoId}`;
      nuevoBeneficiario.innerHTML = `
        <div class="beneficiario-info">
          <input type="text" class="edit-beneficiario-nombre" value="" data-id="${nuevoId}" placeholder="Nombre completo" style="width: 100%; padding: 8px; border: 1px solid #0d6efd; border-radius: 4px; margin-bottom: 4px;">
          <div style="display: flex; gap: 8px; margin-top: 4px;">
            <input type="text" class="edit-beneficiario-rut" value="" data-id="${nuevoId}" placeholder="RUT" style="flex: 1; padding: 8px; border: 1px solid #0d6efd; border-radius: 4px;">
            <input type="text" class="edit-beneficiario-parentesco" value="" data-id="${nuevoId}" placeholder="Parentesco" style="flex: 1; padding: 8px; border: 1px solid #0d6efd; border-radius: 4px;">
          </div>
          <button class="btn btn-danger" onclick="eliminarBeneficiario('${nuevoId}')" style="margin-top: 8px; padding: 4px 12px; font-size: 12px;">
            üóëÔ∏è Eliminar
          </button>
        </div>
      `;
      container.appendChild(nuevoBeneficiario);
    }
    
    // Funci√≥n para eliminar beneficiario
    async function eliminarBeneficiario(beneficiarioId) {
      if (!confirm('¬øEst√°s seguro de que deseas eliminar este beneficiario?')) {
        return;
      }
      
      // Si es un ID num√©rico (existe en BD), llamar al backend
      if (!beneficiarioId.toString().startsWith('nuevo-')) {
        try {
          const response = await fetch(`http://localhost:3001/api/beneficiarios/${beneficiarioId}`, {
            method: 'DELETE',
            credentials: 'include'
          });
          
          if (!response.ok) {
            const error = await response.json();
            alert(`‚ùå Error: ${error.error || 'Error al eliminar beneficiario'}`);
            return;
          }
        } catch (error) {
          alert(`‚ùå Error: ${error.message}`);
          return;
        }
      }
      
      // Eliminar del DOM
      const elemento = document.getElementById(`beneficiario-${beneficiarioId}`);
      if (elemento) {
        elemento.remove();
      }
    }
    
    // Funci√≥n para agregar documento
    function agregarDocumento(expedienteId, solicitudId) {
      // Crear input file oculto
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.pdf,.doc,.docx,.jpg,.jpeg,.png';
      input.onchange = async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        const formData = new FormData();
        formData.append('archivo', file);
        formData.append('expediente_id', expedienteId);
        formData.append('solicitud_id', solicitudId);
        
        try {
          const response = await fetch('http://localhost:3001/api/upload-documento', {
            method: 'POST',
            credentials: 'include',
            body: formData
          });
          
          if (response.ok) {
            alert('‚úÖ Documento agregado exitosamente');
            document.getElementById('searchForm').dispatchEvent(new Event('submit'));
          } else {
            const error = await response.json();
            alert(`‚ùå Error: ${error.error || 'Error al agregar documento'}`);
          }
        } catch (error) {
          alert(`‚ùå Error: ${error.message}`);
        }
      };
      input.click();
    }
    
    // Funci√≥n para eliminar documento
    async function eliminarDocumento(documentoId) {
      if (!confirm('¬øEst√°s seguro de que deseas eliminar este documento?')) {
        return;
      }
      
      try {
        const response = await fetch(`http://localhost:3001/api/documentos/${documentoId}`, {
          method: 'DELETE',
          credentials: 'include'
        });
        
        if (response.ok) {
          alert('‚úÖ Documento eliminado exitosamente');
          document.getElementById('searchForm').dispatchEvent(new Event('submit'));
        } else {
          const error = await response.json();
          alert(`‚ùå Error: ${error.error || 'Error al eliminar documento'}`);
        }
      } catch (error) {
        alert(`‚ùå Error: ${error.message}`);
      }
    }
    

    async function guardarCalculo() {
      if (!expedienteActualId) {
        alert('‚ùå Error: No se encontr√≥ el ID del expediente');
        return;
      }
      
      // Obtener todos los beneficios ingresados
      const filas = document.querySelectorAll('.beneficio-row');
      const beneficios = [];
      let total = 0;
      let hayErrores = false;
      
      filas.forEach(fila => {
        const select = fila.querySelector('.beneficio-select');
        const input = fila.querySelector('.monto-input');
        
        const codigo = select.value;
        const nombre = select.options[select.selectedIndex].text;
        const monto = parseFloat(input.value) || 0;
        
        if (!codigo || monto <= 0) {
          hayErrores = true;
          return;
        }
        
        beneficios.push({
          codigo: parseInt(codigo),
          nombre: nombre,
          monto: monto
        });
        
        total += monto;
      });
      
      if (hayErrores || beneficios.length === 0) {
        alert('‚ùå Por favor, complete todos los campos de beneficio y monto');
        return;
      }
      
      // Confirmar antes de guardar
      if (!confirm(`¬øEst√° seguro de guardar este c√°lculo?\n\nTotal: $${total.toLocaleString('es-CL')}\nBeneficios: ${beneficios.length}`)) {
        return;
      }
      
      try {
        const response = await fetch('http://localhost:3001/api/calcular-saldo-insoluto', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          credentials: 'include',
          body: JSON.stringify({
            expediente_id: expedienteActualId,
            solicitud_id: solicitudActualId,
            beneficios: beneficios,
            total: total
          })
        });
        
        const resultado = await response.json();
        
        if (response.ok && resultado.success) {
          const estadoActualizado = resultado.data?.estado_actualizado || false;
          const mensaje = estadoActualizado 
            ? `‚úÖ C√°lculo guardado exitosamente\n\nID del c√°lculo: ${resultado.data.calculo_id}\nTotal: $${total.toLocaleString('es-CL')}\n\nüîí El expediente ha sido BLOQUEADO para revisi√≥n de jefatura.`
            : `‚úÖ C√°lculo guardado exitosamente\n\nID del c√°lculo: ${resultado.data.calculo_id}\nTotal: $${total.toLocaleString('es-CL')}\n\n‚ö†Ô∏è El expediente a√∫n no cumple todas las condiciones para ser bloqueado.`;
          
          alert(mensaje);
          cerrarModalCalculo();
          
          // Esperar un momento para que el commit se complete, luego recargar el expediente
          setTimeout(() => {
            if (document.getElementById('searchForm')) {
              console.log('üîÑ Recargando expediente despu√©s de guardar c√°lculo...');
              document.getElementById('searchForm').dispatchEvent(new Event('submit'));
            }
          }, 500);
        } else {
          alert(`‚ùå Error al guardar: ${resultado.error || 'Error desconocido'}`);
        }
      } catch (error) {
        console.error('Error guardando c√°lculo:', error);
        alert(`‚ùå Error al guardar c√°lculo:\n\n${error.message}\n\nVerifica que el servidor est√© corriendo.`);
      }
    }
  </script>
</body>
</html>

