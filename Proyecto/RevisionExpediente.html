<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Revisi√≥n de Expediente</title>
  <style>
    :root { --c1:#0d6efd; --cBg:#f6f7fb; --text:#333; --border:#e5e7eb; --success:#28a745; --warning:#ffc107; --danger:#dc3545; }
    * { box-sizing: border-box; }
    body {
      margin:0;
      font-family: Arial, sans-serif;
      background: linear-gradient(120deg, #e3f0ff 0%, #f7e3e3 100%, #f5f7fb 100%);
      color:var(--text);
      min-height: 100vh;
    }
    .header { background:#fff; border-bottom:1px solid var(--border); padding:20px; text-align:center; }
    h1 { margin:0; color:var(--c1); font-size:28px; }
    .container { max-width:1200px; margin:0 auto; padding:20px; }
    .search-box { background:#fff; border-radius:12px; padding:24px; box-shadow:0 4px 12px rgba(0,0,0,0.1); margin-bottom:20px; }
    .form-group { margin-bottom:16px; }
    label { display:block; margin-bottom:6px; font-weight:500; }
    input { width:100%; padding:12px; border:1px solid var(--border); border-radius:8px; font-size:16px; }
    .btn { background:var(--c1); color:#fff; border:none; padding:12px 24px; border-radius:8px; cursor:pointer; font-size:16px; }
    .btn:hover { background:#084298; }
    .btn-success { background:var(--success); }
    .btn-success:hover { background:#1e7e34; }
    .btn-warning { background:var(--warning); color:#000; }
    .btn-warning:hover { background:#e0a800; }
    .btn-danger { background:var(--danger); }
    .btn-danger:hover { background:#c82333; }
    
    .expediente-info { background:#fff; border-radius:12px; padding:24px; box-shadow:0 4px 12px rgba(0,0,0,0.1); margin-bottom:20px; }
    .info-grid { display:grid; grid-template-columns:1fr 1fr; gap:20px; margin-bottom:20px; }
    .info-section { background:#f8f9fa; padding:16px; border-radius:8px; }
    .info-section h3 { margin:0 0 12px; color:var(--c1); font-size:18px; }
    .info-item { margin-bottom:8px; }
    .info-label { font-weight:600; color:#666; }
    .info-value { color:#333; }
    
    .status-card { background:#fff; border-radius:12px; padding:24px; box-shadow:0 4px 12px rgba(0,0,0,0.1); margin-bottom:20px; }
    .status-header { display:flex; align-items:center; margin-bottom:16px; }
    .status-icon { font-size:24px; margin-right:12px; }
    .status-title { font-size:20px; font-weight:600; margin:0; }
    .status-details { display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:16px; }
    .status-item { text-align:center; padding:12px; background:#f8f9fa; border-radius:8px; }
    .status-number { font-size:24px; font-weight:bold; color:var(--c1); }
    .status-label { font-size:14px; color:#666; }
    
    .documentos-section { background:#fff; border-radius:12px; padding:24px; box-shadow:0 4px 12px rgba(0,0,0,0.1); margin-bottom:20px; }
    .documentos-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; }
    .documentos-count { background:var(--c1); color:#fff; padding:8px 16px; border-radius:20px; font-size:14px; font-weight:600; }
    .documentos-list { display:grid; gap:12px; }
    .documento-item { display:flex; justify-content:space-between; align-items:center; padding:16px; background:#f8f9fa; border-radius:8px; border-left:4px solid var(--c1); }
    .documento-info { flex:1; }
    .documento-nombre { font-weight:600; margin-bottom:4px; }
    .documento-detalles { font-size:14px; color:#666; }
    .documento-acciones { display:flex; gap:8px; }
    
    .beneficiarios-section { background:#fff; border-radius:12px; padding:24px; box-shadow:0 4px 12px rgba(0,0,0,0.1); margin-bottom:20px; }
    .beneficiarios-list { display:grid; gap:12px; }
    .beneficiario-item { display:flex; justify-content:space-between; align-items:center; padding:16px; background:#f8f9fa; border-radius:8px; }
    .beneficiario-info { flex:1; }
    .beneficiario-nombre { font-weight:600; margin-bottom:4px; }
    .beneficiario-detalles { font-size:14px; color:#666; }
    .firma-status { display:flex; align-items:center; gap:8px; }
    .firma-check { font-size:20px; }
    
    .download-section { background:#fff; border-radius:12px; padding:24px; box-shadow:0 4px 12px rgba(0,0,0,0.1); text-align:center; margin-bottom:20px; }
    .download-title { font-size:20px; font-weight:600; margin-bottom:12px; color:var(--c1); }
    .download-description { color:#666; margin-bottom:20px; }
    
    .btn-calculate { padding:12px 32px; font-size:16px; font-weight:600; border-radius:8px; cursor:pointer; transition:all 0.3s; border:none; }
    .btn-calculate:disabled { background:#ccc !important; color:#666 !important; cursor:not-allowed; opacity:0.6; }
    .btn-calculate.enabled { background:linear-gradient(135deg, #28a745 0%, #20c997 100%); color:#fff; box-shadow:0 4px 15px rgba(40,167,69,0.4); }
    .btn-calculate.enabled:hover { transform:translateY(-2px); box-shadow:0 6px 20px rgba(40,167,69,0.6); }
    .btn-calculate.disabled { background:#e0e0e0; color:#999; }
    .btn-inicio { background:var(--c1); color:#fff; margin-top:10px; }
    .btn-inicio:hover { background:#084298; }
    
    .modal-overlay { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:10000; justify-content:center; align-items:center; }
    .modal-content { background:#fff; border-radius:16px; padding:32px; max-width:600px; width:90%; max-height:80vh; overflow-y:auto; box-shadow:0 10px 40px rgba(0,0,0,0.3); }
    .modal-header { margin-bottom:24px; text-align:center; }
    .modal-header h2 { margin:0; color:var(--c1); font-size:24px; }
    .modal-body { margin-bottom:24px; }
    .modal-footer { text-align:center; }
    .modal-form-group { margin-bottom:16px; }
    .modal-form-group label { display:block; margin-bottom:8px; font-weight:600; color:#333; }
    .modal-form-group input, .modal-form-group textarea { width:100%; padding:12px; border:1px solid var(--border); border-radius:8px; font-size:16px; }
    .modal-form-group textarea { min-height:100px; resize:vertical; }
    
    .no-results { text-align:center; color:#6b7280; padding:40px; background:#fff; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.1); }
    
    @media (max-width: 768px) {
      .info-grid { grid-template-columns:1fr; }
      .status-details { grid-template-columns:1fr; }
      .documento-item { flex-direction:column; align-items:flex-start; gap:12px; }
      .beneficiario-item { flex-direction:column; align-items:flex-start; gap:12px; }
    }
  </style>
</head>
<body>
  <header class="header">
    <h1>Revisi√≥n de Expediente</h1>
  </header>
  
  <div class="container">
    <div class="search-box">
      <h2>Buscar Expediente</h2>
      <form id="searchForm">
        <div class="form-group">
          <label for="rut">RUT del Causante</label>
          <input type="text" id="rut" placeholder="12.345.678-9" required>
        </div>
        <button type="submit" class="btn">Buscar Expediente</button>
      </form>
    </div>
    
    <div id="expedienteContent" style="display:none;">
      <!-- Contenido del expediente se mostrar√° aqu√≠ -->
    </div>
    
    <div class="no-results" id="noResults" style="display:none;">
      <div style="font-size:48px; margin-bottom:16px;">üîç</div>
      <h3>No se encontr√≥ expediente</h3>
      <p>No se encontr√≥ ning√∫n expediente para el RUT proporcionado.</p>
    </div>
  </div>

  <!-- Modal de C√°lculo de Saldo Insoluto -->
  <div id="modal-calculo" class="modal-overlay" onclick="cerrarModalCalculo(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
      <div class="modal-header">
        <h2>üí∞ Calcular Saldo Insoluto</h2>
      </div>
      <div class="modal-body">
        <!-- Vac√≠o por mientras -->
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" onclick="cerrarModalCalculo()">Cerrar</button>
      </div>
    </div>
  </div>

  <script>
    // Variable global para el expediente actual
    let expedienteActualId = null;
    
    // Funci√≥n para calcular d√≠gito verificador
    function calcularDV(rut) {
      let suma = 0;
      let multiplicador = 2;
      
      for (let i = rut.length - 1; i >= 0; i--) {
        suma += parseInt(rut[i]) * multiplicador;
        multiplicador = multiplicador < 7 ? multiplicador + 1 : 2;
      }
      
      let resto = suma % 11;
      let dv = 11 - resto;
      
      if (dv === 11) return '0';
      if (dv === 10) return 'K';
      return dv.toString();
    }

    // Funci√≥n para formatear RUT autom√°ticamente
    function formatRUT(e) {
      let value = e.target.value.replace(/[^0-9kK]/g, '');
      
      if (value.length >= 2) {
        let body = value.slice(0, -1);
        let dv = value.slice(-1);
        
        // Si el DV no es v√°lido (no es n√∫mero ni K), calcularlo autom√°ticamente
        if (!/[0-9kK]/.test(dv) && body.length >= 7) {
          dv = calcularDV(body);
          value = body + dv;
        }
        
        if (body.length > 0) {
          if (body.length > 6) {
            body = body.slice(0, -6) + '.' + body.slice(-6, -3) + '.' + body.slice(-3);
          } else if (body.length > 3) {
            body = body.slice(0, -3) + '.' + body.slice(-3);
          }
          value = body + '-' + dv;
        }
      }
      
      e.target.value = value;
    }

    // Configurar formateo autom√°tico de RUT
    document.addEventListener('DOMContentLoaded', function() {
      const rutField = document.getElementById('rut');
      if (rutField) {
        rutField.addEventListener('input', formatRUT);
      }
    });

    document.getElementById('searchForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      let rut = document.getElementById('rut').value.trim();
      
      if (!rut) {
        alert('Ingresa el RUT del causante');
        return;
      }
      
      // Si el RUT no tiene formato completo, intentar completarlo
      let rutNumeros = rut.replace(/[^0-9]/g, '');
      if (rutNumeros.length >= 7 && rutNumeros.length <= 8 && !rut.includes('-')) {
        // Calcular DV autom√°ticamente si falta
        let dv = calcularDV(rutNumeros);
        rut = rutNumeros + '-' + dv;
        console.log('üîß RUT completado autom√°ticamente:', rut);
      }
      
      // Mostrar loading
      const submitBtn = e.target.querySelector('button[type="submit"]');
      const originalText = submitBtn.textContent;
      submitBtn.textContent = 'Buscando...';
      submitBtn.disabled = true;
      
      try {
        console.log('üîç Buscando expediente por RUT:', rut);
        
        const response = await fetch('http://localhost:3001/api/revision-expediente', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          credentials: 'include',
          body: JSON.stringify({ rut: rut })
        });
        
        console.log('üì° Respuesta recibida:', response.status);
        
        if (!response.ok) {
          // Intentar obtener el mensaje de error del servidor
          let errorMessage = `Error del servidor: ${response.status}`;
          try {
            const errorData = await response.json();
            if (errorData.error) {
              errorMessage = errorData.error;
            }
          } catch (e) {
            console.log('No se pudo obtener mensaje de error detallado');
          }
          throw new Error(errorMessage);
        }
        
        const resultado = await response.json();
        console.log('üìã Resultado completo:', resultado);
        console.log('üîç Datos del funcionario:', resultado.data?.funcionario);
        
        if (resultado.success) {
          if (resultado.data.expediente_id) {
            showExpediente(resultado.data);
          } else {
            showNoResults(rut);
          }
        } else {
          throw new Error(resultado.error || 'Error desconocido');
        }
        
      } catch (error) {
        console.error('‚ùå Error en b√∫squeda:', error);
        alert(`‚ùå Error al buscar expediente:\n\n${error.message}\n\nPor favor, verifica que el servidor est√© corriendo y vuelve a intentar.`);
      } finally {
        // Restaurar bot√≥n
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
      }
    });
    
    function showExpediente(data) {
      console.log('üîç Datos recibidos en showExpediente:', data);
      console.log('üîç Funcionario en showExpediente:', data.funcionario);
      document.getElementById('expedienteContent').style.display = 'block';
      document.getElementById('noResults').style.display = 'none';
      
      let html = `
        <!-- Informaci√≥n del Expediente -->
        <div class="expediente-info">
          <h2>üìã Expediente: ${data.expediente_numero}</h2>
          <div class="info-grid">
            <div class="info-section">
              <h3>üë§ Datos del Causante</h3>
              <div class="info-item">
                <span class="info-label">Nombre:</span>
                <span class="info-value">${data.causante.nombre_completo}</span>
              </div>
              <div class="info-item">
                <span class="info-label">RUT:</span>
                <span class="info-value">${data.causante.rut}</span>
              </div>
              <div class="info-item">
                <span class="info-label">Fecha Defunci√≥n:</span>
                <span class="info-value">${data.causante.fecha_defuncion}</span>
              </div>
              <div class="info-item">
                <span class="info-label">Comuna:</span>
                <span class="info-value">${data.causante.comuna_defuncion}</span>
              </div>
              <div class="info-item">
                <span class="info-label">Nacionalidad:</span>
                <span class="info-value">${data.causante.nacionalidad}</span>
              </div>
            </div>
            
            <div class="info-section">
              <h3>üìÑ Datos del Expediente</h3>
              <div class="info-item">
                <span class="info-label">ID Expediente:</span>
                <span class="info-value">${data.expediente_id}</span>
              </div>
              <div class="info-item">
                <span class="info-label">Folio:</span>
                <span class="info-value">${data.folio}</span>
              </div>
              <div class="info-item">
                <span class="info-label">Estado:</span>
                <span class="info-value">${data.estado_expediente}</span>
              </div>
              <div class="info-item">
                <span class="info-label">Fecha Creaci√≥n:</span>
                <span class="info-value">${data.fecha_creacion}</span>
              </div>
              <div class="info-item">
                <span class="info-label">Sucursal:</span>
                <span class="info-value">${data.solicitud.sucursal}</span>
              </div>
              <div class="info-item">
                <span class="info-label">Funcionario Responsable:</span>
                <span class="info-value">${data.funcionario.nombre_completo}</span>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Estado de Firmas -->
        <div class="status-card">
          <div class="status-header">
            <span class="status-icon">${data.firmas.icono}</span>
            <h3 class="status-title">Estado de Firmas Digitales</h3>
          </div>
          <div class="status-details">
            <div class="status-item">
              <div class="status-number">${data.firmas.total_firmas || 0}</div>
              <div class="status-label">Total Firmas</div>
            </div>
            <div class="status-item">
              <div class="status-number">${data.firmas.firmas_completadas || 0}</div>
              <div class="status-label">Firmadas</div>
            </div>
            <div class="status-item">
              <div class="status-number">${data.firmas.pendientes || 0}</div>
              <div class="status-label">Pendientes</div>
            </div>
            <div class="status-item">
              <div class="status-number" style="color:${data.firmas.color}">${data.firmas.estado}</div>
              <div class="status-label">Estado General</div>
            </div>
          </div>
        </div>
        
        <!-- Datos del Representante -->
        <div class="status-card">
          <div class="status-header">
            <span class="status-icon">üë®‚Äçüíº</span>
            <h3 class="status-title">Datos del Representante</h3>
            <div style="margin-left: auto;">
              <span class="firma-status" style="background: ${data.representante.firmado ? '#d4edda' : '#f8d7da'}; color: ${data.representante.firmado ? '#155724' : '#721c24'}; padding: 6px 12px; border-radius: 20px; font-size: 14px; font-weight: 600;">
                ${data.representante.firmado ? '‚úÖ Firmado' : '‚ùå Sin firmar'}
              </span>
            </div>
          </div>
          <div class="status-details">
            <div class="status-item">
              <div class="status-number" style="font-size: 16px; color: #333;">${data.representante.nombre_completo}</div>
              <div class="status-label">Nombre Completo</div>
            </div>
            <div class="status-item">
              <div class="status-number" style="font-size: 16px; color: #333;">${data.representante.rut}</div>
              <div class="status-label">RUT</div>
            </div>
            <div class="status-item">
              <div class="status-number" style="font-size: 16px; color: #333;">${data.representante.calidad}</div>
              <div class="status-label">Calidad</div>
            </div>
            <div class="status-item">
              <div class="status-number" style="font-size: 16px; color: #333;">${data.representante.telefono}</div>
              <div class="status-label">Tel√©fono</div>
            </div>
            <div class="status-item">
              <div class="status-number" style="font-size: 16px; color: #333;">${data.representante.email}</div>
              <div class="status-label">Email</div>
            </div>
            <div class="status-item">
              <div class="status-number" style="font-size: 16px; color: #666;">${data.representante.fecha_firma || 'No especificada'}</div>
              <div class="status-label">Fecha de Firma</div>
            </div>
          </div>
        </div>
        
        <!-- Lista de Beneficiarios -->
        <div class="beneficiarios-section">
          <div class="documentos-header">
            <h3>üë• Beneficiarios (${data.beneficiarios.length})</h3>
          </div>
          <div class="beneficiarios-list">
      `;
      
      data.beneficiarios.forEach(beneficiario => {
        const firmaIcon = beneficiario.firma.firmado ? '‚úÖ' : '‚ùå';
        const firmaText = beneficiario.firma.firmado ? 'Firmado' : 'Sin firmar';
        const firmaColor = beneficiario.firma.firmado ? 'color:#28a745' : 'color:#dc3545';
        
        html += `
          <div class="beneficiario-item">
            <div class="beneficiario-info">
              <div class="beneficiario-nombre">${beneficiario.nombre_completo}</div>
              <div class="beneficiario-detalles">
                RUT: ${beneficiario.rut} | Parentesco: ${beneficiario.parentesco}
              </div>
            </div>
            <div class="firma-status">
              <span class="firma-check" style="${firmaColor}">${firmaIcon}</span>
              <span style="${firmaColor}">${firmaText}</span>
            </div>
          </div>
        `;
      });
      
      html += `
          </div>
        </div>
        
        <!-- Lista de Documentos -->
        <div class="documentos-section">
          <div class="documentos-header">
            <h3>üìÅ Documentos (${data.documentos.total})</h3>
            <span class="documentos-count">${data.documentos.total} archivos</span>
          </div>
          <div class="documentos-list">
      `;
      
      if (data.documentos.lista.length > 0) {
        data.documentos.lista.forEach(documento => {
          html += `
            <div class="documento-item">
              <div class="documento-info">
                <div class="documento-nombre">${documento.nombre}</div>
                <div class="documento-detalles">
                  ${documento.mime_type} ‚Ä¢ ${documento.tamano_mb} MB ‚Ä¢ Subido: ${documento.fecha_subida}
                </div>
              </div>
              <div class="documento-acciones">
                <button class="btn btn-success" onclick="descargarDocumento(${documento.id})">
                  üì• Descargar
                </button>
              </div>
            </div>
          `;
        });
      } else {
        html += `
          <div style="text-align:center; padding:20px; color:#666;">
            No hay documentos cargados en este expediente.
          </div>
        `;
      }
      
      html += `
          </div>
        </div>
        
        <!-- Descarga Completa -->
        <div class="download-section">
          <h3 class="download-title">üì¶ Descargar Expediente Completo</h3>
          <p class="download-description">
            Descarga todos los documentos del expediente en un archivo ZIP comprimido.
          </p>
          <button class="btn btn-success" onclick="descargarExpedienteCompleto(${data.expediente_id})">
            üì¶ Descargar Expediente Completo
          </button>
          
          <!-- Bot√≥n Calcular Saldo Insoluto -->
          <div style="margin-top:20px;">
            <button 
              id="btn-calcular-saldo" 
              class="btn-calculate ${data.firmas.pendientes === 0 && data.representante.firmado ? 'enabled' : 'disabled'}" 
              ${data.firmas.pendientes === 0 && data.representante.firmado ? '' : 'disabled'}
              onclick="abrirModalCalculo(${data.expediente_id})">
              üí∞ Calcular Saldo Insoluto
            </button>
            ${data.firmas.pendientes > 0 || !data.representante.firmado ? 
              '<p style="color:#dc3545; font-size:14px; margin-top:8px;">‚ö†Ô∏è Faltan firmas por completar</p>' 
              : '<p style="color:#28a745; font-size:14px; margin-top:8px;">‚úÖ Todas las firmas est√°n completas</p>'
            }
          </div>
          
          <!-- Bot√≥n Regresar al Inicio -->
          <div style="margin-top:20px;">
            <button class="btn btn-inicio" onclick="window.location.href='index.html'">
              üè† Regresar al Inicio
            </button>
          </div>
        </div>
      `;
      
      document.getElementById('expedienteContent').innerHTML = html;
    }
    
    function showNoResults(rut) {
      document.getElementById('expedienteContent').style.display = 'none';
      document.getElementById('noResults').style.display = 'block';
      
      document.getElementById('noResults').innerHTML = `
        <div style="text-align:center; padding:40px;">
          <div style="font-size:48px; margin-bottom:16px;">üîç</div>
          <h3>No se encontr√≥ expediente</h3>
          <p>No se encontr√≥ ning√∫n expediente para el RUT: <strong>${rut}</strong></p>
          <p style="color:#6c757d; font-size:14px;">
            Verifica que el RUT est√© correcto o que exista un expediente para esta persona.
          </p>
        </div>
      `;
    }
    
    function descargarDocumento(documentoId) {
      window.open(`http://localhost:3001/api/download-documento/${documentoId}`, '_blank');
    }
    
    function descargarExpedienteCompleto(expedienteId) {
      // Descargar expediente completo como ZIP
      console.log('üì¶ Descargando expediente completo:', expedienteId);
      window.open(`http://localhost:3001/api/download-expediente-completo/${expedienteId}`, '_blank');
    }
    
    // Funciones para el modal de c√°lculo
    function abrirModalCalculo(expedienteId) {
      expedienteActualId = expedienteId;
      const modal = document.getElementById('modal-calculo');
      modal.style.display = 'flex';
    }
    
    function cerrarModalCalculo(event) {
      if (event && event.target.id !== 'modal-calculo') {
        return; // Solo cerrar si se hace click en el overlay
      }
      const modal = document.getElementById('modal-calculo');
      modal.style.display = 'none';
      expedienteActualId = null;
    }
  </script>
</body>
</html>

