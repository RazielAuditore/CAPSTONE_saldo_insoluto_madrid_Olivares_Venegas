<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Saldo Insoluto - Aprobaci√≥n de Solicitudes</title>
  <style>
    :root { 
      --c1: #0d6efd; 
      --c2: #f8f9fa; 
      --b: #212529; 
      --muted: #6c757d; 
      --ok: #28a745; 
      --bad: #dc3545; 
      --warning: #ffc107;
      --info: #17a2b8;
    }
    
    * { box-sizing: border-box; }
    
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      background: linear-gradient(120deg, #e3f0ff 0%, #f7e3e3 100%, #f5f7fb 100%);
      color: #222;
      min-height: 100vh;
    }
    
    .header {
      background: linear-gradient(160deg, #fff4f4 0%, #ffd6d6 100%);
      padding: 20px;
      border-bottom: 1px solid #e5e7eb;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .header-content {
      flex: 1;
    }
    
    .header h1 {
      margin: 0;
      color: #333;
      font-size: 24px;
    }
    
    .header p {
      margin: 5px 0 0 0;
      color: var(--muted);
    }
    
    .header-actions {
      display: flex;
      gap: 10px;
    }
    
    .header-actions .btn {
      text-decoration: none;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    
    .filters {
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    
    .filters h3 {
      margin: 0 0 15px 0;
      color: #333;
    }
    
    .filter-row {
      display: grid;
      grid-template-columns: 1fr 1fr auto;
      gap: 15px;
      align-items: end;
    }
    
    .filter-group {
      display: flex;
      flex-direction: column;
    }
    
    .filter-group label {
      font-weight: bold;
      margin-bottom: 5px;
      color: #555;
    }
    
    .filter-group select,
    .filter-group input {
      padding: 10px;
      border: 1px solid #ced4da;
      border-radius: 8px;
      font-size: 14px;
    }
    
    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: bold;
      transition: all 0.2s;
    }
    
    .btn-primary {
      background: var(--c1);
      color: white;
    }
    
    .btn-primary:hover {
      background: #0b5ed7;
    }
    
    .btn-success {
      background: var(--ok);
      color: white;
    }
    
    .btn-danger {
      background: var(--bad);
      color: white;
    }
    
    .btn-warning {
      background: var(--warning);
      color: #212529;
    }
    
    .btn-info {
      background: var(--info);
      color: white;
    }
    
    .btn-secondary {
      background: #6c757d;
      color: white;
    }
    
    .solicitudes-list {
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      overflow: hidden;
    }
    
    .solicitud-item {
      border-bottom: 1px solid #e9ecef;
      padding: 20px;
      transition: background-color 0.2s;
    }
    
    .solicitud-item:hover {
      background-color: #f8f9fa;
    }
    
    .solicitud-item:last-child {
      border-bottom: none;
    }
    
    .solicitud-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 15px;
    }
    
    .solicitud-info h4 {
      margin: 0 0 5px 0;
      color: #333;
      font-size: 18px;
    }
    
    .solicitud-meta {
      color: var(--muted);
      font-size: 14px;
    }
    
    .estado-badge {
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: bold;
      text-transform: uppercase;
    }
    
    .estado-pendiente {
      background: #fff3cd;
      color: #856404;
    }
    
    .estado-firmado {
      background: #d1ecf1;
      color: #0c5460;
    }
    
    .estado-completado {
      background: #d4edda;
      color: #155724;
    }
    
    .solicitud-details {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 20px;
      margin-bottom: 15px;
    }
    
    .detail-group h5 {
      margin: 0 0 8px 0;
      color: #555;
      font-size: 14px;
      font-weight: bold;
    }
    
    .detail-group p {
      margin: 0;
      color: #333;
      font-size: 14px;
    }
    
    .solicitud-actions {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }
    
    .loading {
      text-align: center;
      padding: 40px;
      color: var(--muted);
    }
    
    .no-results {
      text-align: center;
      padding: 40px;
      color: var(--muted);
    }
    
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
    }
    
    .modal-overlay {
      display: none;
      position: fixed;
      z-index: 10000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.7);
      justify-content: center;
      align-items: center;
    }
    
    .modal-content {
      background-color: white;
      margin: 5% auto;
      padding: 0;
      border-radius: 12px;
      width: 90%;
      max-width: 800px;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    }
    
    .modal-header {
      background: linear-gradient(160deg, #fff4f4 0%, #ffd6d6 100%);
      padding: 20px;
      border-radius: 12px 12px 0 0;
      border-bottom: 1px solid #e5e7eb;
    }
    
    .modal-header h2 {
      margin: 0;
      color: #333;
    }
    
    .modal-body {
      padding: 20px;
    }
    
    .close {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }
    
    .close:hover {
      color: #000;
    }
    
    .requisitos-section {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    
    .requisitos-section h4 {
      margin: 0 0 10px 0;
      color: #333;
    }
    
    .requisito-item {
      display: flex;
      align-items: center;
      margin-bottom: 8px;
      padding: 8px;
      background: white;
      border-radius: 6px;
      border-left: 4px solid #e9ecef;
    }
    
    .requisito-item.cumple {
      border-left-color: var(--ok);
    }
    
    .requisito-item.no-cumple {
      border-left-color: var(--bad);
    }
    
    .requisito-icon {
      margin-right: 10px;
      font-size: 16px;
    }
    
    .requisito-text {
      flex: 1;
      font-size: 14px;
    }
    
    .modal-actions {
      padding: 20px;
      border-top: 1px solid #e9ecef;
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }
    
    @media (max-width: 768px) {
      .filter-row {
        grid-template-columns: 1fr;
      }
      
      .solicitud-details {
        grid-template-columns: 1fr;
      }
      
      .solicitud-header {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .solicitud-actions {
        justify-content: flex-start;
        margin-top: 10px;
      }
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="header-content">
      <h1>üìã Aprobaci√≥n de Solicitudes</h1>
      <p>Revisa y aprueba las solicitudes de saldo insoluto pendientes de jefatura</p>
    </div>
    <div class="header-actions">
      <a href="FrontJefatura.html" class="btn btn-secondary">üè† Volver a Jefatura</a>
    </div>
  </div>

  <div class="container">
    <!-- Filtros -->
    <div class="filters">
      <h3>üîç Filtros de B√∫squeda</h3>
      <div class="filter-row">
        <div class="filter-group">
          <label for="filtro-estado">Estado</label>
          <select id="filtro-estado">
            <option value="">Todos los estados</option>
            <option value="pendiente">Pendientes (En revisi√≥n)</option>
            <option value="completado">Aprobadas (Completadas)</option>
          </select>
        </div>
        <div class="filter-group">
          <label for="filtro-sucursal">Sucursal</label>
          <select id="filtro-sucursal">
            <option value="">Todas las sucursales</option>
            <option value="providencia">Providencia</option>
            <option value="nunoa">√ëu√±oa</option>
            <option value="santo_domingo">Santo Domingo</option>
            <option value="IPS Central">IPS Central</option>
          </select>
        </div>
        <button class="btn btn-primary" onclick="cargarSolicitudes()">
          üîç Buscar
        </button>
      </div>
    </div>

    <!-- Lista de solicitudes -->
    <div class="solicitudes-list">
      <div id="loading" class="loading" style="display: none;">
        <p>üîÑ Cargando solicitudes...</p>
      </div>
      
      <div id="no-results" class="no-results" style="display: none;">
        <p>üì≠ No se encontraron solicitudes con los filtros aplicados</p>
      </div>
      
      <div id="solicitudes-container">
        <!-- Las solicitudes se cargar√°n aqu√≠ din√°micamente -->
      </div>
    </div>
  </div>

  <!-- Modal de detalles -->
  <div id="modal-detalles" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <span class="close" onclick="cerrarModal()">&times;</span>
        <h2 id="modal-titulo">Detalles de la Solicitud</h2>
      </div>
      <div class="modal-body" id="modal-body">
        <!-- Contenido del modal se cargar√° aqu√≠ -->
      </div>
      <div class="modal-actions" id="modal-actions">
        <!-- Botones de acci√≥n se cargar√°n aqu√≠ -->
      </div>
    </div>
  </div>

  <!-- Modal para Visualizar Documentos -->
  <div id="modal-documento" class="modal-overlay" onclick="cerrarModalDocumento(event)" style="display: none;">
    <div class="modal-content" onclick="event.stopPropagation()" style="max-width: 95%; max-height: 95vh; display: flex; flex-direction: column;">
      <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center;">
        <h2 id="modal-documento-titulo" style="margin: 0;">üìÑ Visualizar Documento</h2>
        <span class="close" onclick="cerrarModalDocumento()" style="cursor: pointer; font-size: 28px; color: #aaa;">&times;</span>
      </div>
      <div class="modal-body" style="padding: 0; flex: 1; overflow: hidden;">
        <iframe id="documento-iframe" 
                style="width: 100%; height: 100%; border: none; border-radius: 0;"
                frameborder="0">
        </iframe>
      </div>
      <div style="padding: 15px 20px; border-top: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center;">
        <button type="button" class="btn btn-secondary" onclick="cerrarModalDocumento()">Cerrar</button>
        <a id="descargar-documento-link" href="#" target="_blank" class="btn btn-primary">üì• Descargar</a>
      </div>
    </div>
  </div>

  <script>
    // Variables globales
    let solicitudesData = [];
    let solicitudActual = null;

    // Verificar sesi√≥n y rol de jefatura al iniciar
    document.addEventListener('DOMContentLoaded', async function() {
      // Verificar que el usuario sea jefatura antes de mostrar el contenido
      const tieneAcceso = await verificarAccesoJefatura();
      if (tieneAcceso) {
        cargarSolicitudes();
      } else {
        // Ocultar contenido y mostrar mensaje de no autorizado
        document.body.innerHTML = `
          <div style="display: flex; justify-content: center; align-items: center; min-height: 100vh; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
            <div style="background: white; padding: 40px; border-radius: 15px; box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1); text-align: center; max-width: 500px;">
              <h1 style="color: #dc3545; margin-bottom: 20px;">‚ùå Acceso No Autorizado</h1>
              <p style="color: #666; margin-bottom: 30px;">Esta p√°gina solo est√° disponible para usuarios con rol de jefatura.</p>
              <a href="FrontJefatura.html" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px 30px; border-radius: 8px; text-decoration: none; display: inline-block; margin-right: 10px;">Volver a Jefatura</a>
              <a href="index.html" style="background: #6c757d; color: white; padding: 15px 30px; border-radius: 8px; text-decoration: none; display: inline-block;">Ir al Inicio</a>
            </div>
          </div>
        `;
      }
    });

    // Funci√≥n para verificar acceso de jefatura
    async function verificarAccesoJefatura() {
      try {
        const response = await fetch('http://localhost:3001/api/check-session', {
          method: 'GET',
          credentials: 'include'
        });

        if (response.ok) {
          const data = await response.json();
          if (data.authenticated && data.user.rol === 'jefatura') {
            return true;
          } else {
            // Si no est√° autenticado o no es jefatura
            return false;
          }
        } else {
          return false;
        }
      } catch (error) {
        console.error('Error verificando acceso:', error);
        return false;
      }
    }

  // Cargar solicitudes al iniciar

    // Utilidad: formateo de RUT b√°sico
    function limpiarRut(r){ return (r||'').replace(/\./g,'').replace(/-/g,'').toUpperCase(); }

    // Funci√≥n para cargar solicitudes desde el backend
    async function cargarSolicitudes() {
      const loading = document.getElementById('loading');
      const noResults = document.getElementById('no-results');
      const container = document.getElementById('solicitudes-container');
      const rutInput = (document.getElementById('filtro-rut')?.value || '').trim();
      
      loading.style.display = 'block';
      noResults.style.display = 'none';
      container.innerHTML = '';

      try {
        // Si hay RUT, consultar expediente para ese RUT
        if (rutInput) {
          const resp = await fetch('http://localhost:3001/api/revision-expediente', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ rut: rutInput })
          });

          if (resp.status === 401) {
            loading.style.display = 'none';
            alert('Sesi√≥n no v√°lida. Inicia sesi√≥n e int√©ntalo de nuevo.');
            return;
          }

          const data = await resp.json();
          if (data.success && data.data && data.data.expediente_id) {
            solicitudesData = [mapResultadoAUI(data.data)];
          } else if (data.success && data.data && data.data.expediente) {
            // compatibilidad por si la estructura es diferente
            solicitudesData = [mapResultadoAUI(data.data.expediente)];
          } else {
            solicitudesData = [];
          }
        } else {
          // Listar solicitudes de jefatura
          const qs = new URLSearchParams();
          const filtroEstado = document.getElementById('filtro-estado').value || '';
          const filtroSucursal = document.getElementById('filtro-sucursal').value || '';
          if (filtroEstado) qs.append('estado', filtroEstado);
          if (filtroSucursal) qs.append('sucursal', filtroSucursal);

          const resp = await fetch('http://localhost:3001/api/solicitudes-pendientes?' + qs.toString(), {
            method: 'GET',
            credentials: 'include'
          });

          if (resp.status === 401) {
            loading.style.display = 'none';
            alert('Sesi√≥n no v√°lida. Inicia sesi√≥n e int√©ntalo de nuevo.');
            return;
          }

          const data = await resp.json();
          if (data.success && Array.isArray(data.data)) {
            // Cargar c√°lculos para cada solicitud
            solicitudesData = await Promise.all(data.data.map(async (x) => {
              let tiene_calculo = false;
              let estado_calculo = null;
              try {
                const calcResp = await fetch(`http://localhost:3001/api/expediente/${x.expediente_id}/calculo-existente`, {
                  method: 'GET',
                  credentials: 'include'
                });
                if (calcResp.ok) {
                  const calcJson = await calcResp.json();
                  tiene_calculo = calcJson.existe || false;
                  estado_calculo = calcJson.calculo?.estado || null;
                }
              } catch (error) {
                console.warn('Error verificando c√°lculo:', error);
              }
              
              return {
                id: x.expediente_id,
                solicitud_id: x.solicitud_id || x.expediente_id, // Usar solicitud_id si existe
                folio: x.folio,
                estado: x.estado_solicitud,
                firmado_funcionario: x.firmado_funcionario || false,
                fecha_creacion: x.fecha_creacion,
                sucursal: x.sucursal || 'No especificada',
                tiene_calculo: tiene_calculo,
                estado_calculo: estado_calculo,
                funcionario: { nombre_completo: '', iniciales: '' },
                causante: {
                  nombre_completo: x.causante?.nombre_completo || '',
                  rut: x.causante?.rut || '',
                  fecha_defuncion: x.causante?.fecha_defuncion || ''
                },
                representante: {
                  nombre_completo: x.representante?.nombre_completo || 'No especificado',
                  rut: x.representante?.rut || 'No especificado',
                  calidad: x.representante?.calidad || 'No especificada',
                  firmado: x.representante?.firmado || false
                },
                firmas: {
                  total_firmas: x.firmas?.total_beneficiarios || 0,
                  firmas_completadas: x.firmas?.beneficiarios_firmados || 0,
                  pendientes: x.firmas?.pendientes || 0
                },
                documentos: {
                  total: x.documentos?.total || 0,
                  lista: x.documentos?.lista || []
                },
                beneficiarios: (x.beneficiarios || []).map(b => ({
                  nombre: b.nombre_completo || 'Sin nombre',
                  rut: b.rut || '',
                  parentesco: b.parentesco || 'No especificado',
                  firmado: b.firma?.firmado === true
                }))
              };
            }));
          } else {
            solicitudesData = [];
          }
        }

        // Aplicar filtros
        let solicitudesFiltradas = solicitudesData;
        
        const filtroEstado = document.getElementById('filtro-estado').value;
        const filtroSucursal = document.getElementById('filtro-sucursal').value;
        
        if (filtroEstado) {
          // Filtrar por estado exacto (pendiente o completado)
          solicitudesFiltradas = solicitudesFiltradas.filter(s => s.estado === filtroEstado);
        }
        
        if (filtroSucursal) {
          solicitudesFiltradas = solicitudesFiltradas.filter(s => s.sucursal === filtroSucursal);
        }

        loading.style.display = 'none';

        if (solicitudesFiltradas.length === 0) {
          noResults.style.display = 'block';
        } else {
          mostrarSolicitudes(solicitudesFiltradas);
        }

      } catch (error) {
        console.error('Error cargando solicitudes:', error);
        loading.style.display = 'none';
        container.innerHTML = '<div class="no-results"><p>‚ùå Error cargando las solicitudes</p></div>';
      }
    }

    // Mapear el resultado del backend (estructura /api/revision-expediente) a la UI de esta p√°gina
    function mapResultadoAUI(r){
      // r es data.resultado del backend
      const documentosLista = (r.documentos?.lista || []).map(d => ({ 
        id: d.id, 
        nombre: d.nombre, 
        tipo: `Tipo ${d.tipo_id||''}`,
        mime_type: d.mime_type || 'application/pdf'
      }));
      const beneficiarios = (r.beneficiarios || []).map(b => ({
        nombre: b.nombre_completo,
        rut: b.rut,
        parentesco: b.parentesco || '',
        firmado: b.firma?.firmado === true || b.firma?.rut_firma
      }));

      return {
        id: r.expediente_id,
        solicitud_id: r.solicitud_id || r.solicitud?.id || r.expediente_id,
        folio: r.folio,
        estado: r.solicitud?.estado || r.estado_expediente || 'borrador',
        firmado_funcionario: r.solicitud?.firmado_funcionario || false,
        fecha_creacion: r.fecha_creacion,
        sucursal: r.solicitud?.sucursal || 'No especificada',
        funcionario: {
          nombre_completo: r.funcionario?.nombre_completo || '',
          iniciales: r.funcionario?.iniciales || ''
        },
        causante: {
          nombre_completo: r.causante?.nombre_completo || '',
          rut: r.causante?.rut || '',
          fecha_defuncion: r.causante?.fecha_defuncion || ''
        },
        representante: {
          nombre_completo: r.representante?.nombre_completo || 'No especificado',
          rut: r.representante?.rut || 'No especificado',
          calidad: r.representante?.calidad || 'No especificada'
        },
        firmas: {
          total_firmas: r.firmas?.total_firmas || 0,
          firmas_completadas: r.firmas?.firmas_completadas || 0,
          pendientes: r.firmas?.pendientes || 0
        },
        documentos: {
          total: r.documentos?.total || documentosLista.length,
          lista: documentosLista
        },
        beneficiarios
      };
    }

    // Funci√≥n para mostrar las solicitudes en la interfaz
    function mostrarSolicitudes(solicitudes) {
      const container = document.getElementById('solicitudes-container');
      
      container.innerHTML = solicitudes.map(solicitud => `
        <div class="solicitud-item">
          <div class="solicitud-header">
            <div class="solicitud-info">
              <h4>${solicitud.folio} - ${solicitud.causante.nombre_completo}</h4>
              <div class="solicitud-meta">
                üìÖ Creado: ${formatearFecha(solicitud.fecha_creacion)} | 
                üè¢ ${solicitud.sucursal} | 
                üë§ Funcionario: ${solicitud.funcionario.iniciales}
              </div>
            </div>
            <span class="estado-badge estado-${solicitud.estado}">
              ${obtenerTextoEstado(solicitud.estado)}
            </span>
          </div>
          
          <div class="solicitud-details">
            <div class="detail-group">
              <h5>üë§ Causante</h5>
              <p><strong>${solicitud.causante.nombre_completo}</strong></p>
              <p>RUT: ${solicitud.causante.rut}</p>
              <p>Fallecimiento: ${formatearFecha(solicitud.causante.fecha_defuncion)}</p>
            </div>
            
            <div class="detail-group">
              <h5>üë®‚Äçüíº Representante</h5>
              <p><strong>${solicitud.representante.nombre_completo}</strong></p>
              <p>RUT: ${solicitud.representante.rut}</p>
              <p>Calidad: ${solicitud.representante.calidad}</p>
            </div>
            
            <div class="detail-group">
              <h5>üìã Progreso</h5>
              <p>Beneficiarios: ${solicitud.beneficiarios.length}</p>
              <p>Firmas: ${solicitud.firmas.firmas_completadas}/${solicitud.firmas.total_firmas}</p>
              <p>Documentos: ${solicitud.documentos.total}</p>
              <p>üí∞ C√°lculo: ${solicitud.tiene_calculo ? (solicitud.estado_calculo === 'aprobado' ? '‚úÖ Aprobado' : '‚è≥ Pendiente') : '‚è≥ Pendiente'}</p>
            </div>
          </div>
          
          <div class="solicitud-actions">
            <button class="btn btn-info" onclick="verDetalles(${solicitud.id})">
              üëÅÔ∏è Ver Detalles
            </button>
            ${solicitud.firmado_funcionario === true && solicitud.estado !== 'completado' ? `
              <button class="btn btn-success" onclick="aprobarSolicitud(${solicitud.solicitud_id})">
                ‚úÖ Aprobar
              </button>
            ` : ''}
            ${solicitud.estado !== 'completado' ? `
              <button class="btn btn-warning" onclick="rechazarSolicitud(${solicitud.solicitud_id})">
                ‚ùå Rechazar
              </button>
            ` : ''}
          </div>
        </div>
      `).join('');
    }

    // Funci√≥n para ver detalles de una solicitud
    async function verDetalles(solicitudId) {
      solicitudActual = solicitudesData.find(s => s.id === solicitudId);
      
      if (!solicitudActual) return;

      const modal = document.getElementById('modal-detalles');
      const titulo = document.getElementById('modal-titulo');
      const body = document.getElementById('modal-body');
      const actions = document.getElementById('modal-actions');

      titulo.textContent = `Detalles: ${solicitudActual.folio}`;

      // Cargar c√°lculo del saldo insoluto
      let calculoData = null;
      try {
        const calculoResp = await fetch(`http://localhost:3001/api/expediente/${solicitudActual.id}/calculo-completo`, {
          method: 'GET',
          credentials: 'include'
        });
        if (calculoResp.ok) {
          const calculoJson = await calculoResp.json();
          if (calculoJson.existe) {
            calculoData = calculoJson.calculo;
          }
        }
      } catch (error) {
        console.warn('Error cargando c√°lculo:', error);
      }

      // Cargar estado de aprobaci√≥n de items
      let aprobacionItems = {};
      try {
        const aprobResp = await fetch(`http://localhost:3001/api/solicitudes/${solicitudActual.solicitud_id}/aprobacion-items`, {
          method: 'GET',
          credentials: 'include'
        });
        if (aprobResp.ok) {
          const aprobJson = await aprobResp.json();
          if (aprobJson.success) {
            aprobacionItems = aprobJson.data || {};
          }
        }
      } catch (error) {
        console.warn('Error cargando aprobaciones:', error);
      }

      // Verificar requisitos
      const requisitos = verificarRequisitos(solicitudActual);

      // Formatear monto en pesos chilenos
      const formatearMonto = (monto) => {
        return new Intl.NumberFormat('es-CL', {
          style: 'currency',
          currency: 'CLP',
          minimumFractionDigits: 0
        }).format(monto);
      };

      body.innerHTML = `
        <div class="requisitos-section">
          <h4>üìã Verificaci√≥n de Requisitos</h4>
            ${requisitos.map(req => `
            <div class="requisito-item ${req.cumple ? 'cumple' : 'no-cumple'}">
              <span class="requisito-icon">${req.cumple ? '‚úÖ' : '‚ùå'}</span>
              <span class="requisito-text">${req.descripcion}: ${req.texto || (req.cumple ? '‚úÖ Cumple' : '‚ùå No cumple')}</span>
            </div>
          `).join('')}
        </div>

        ${calculoData ? `
        <div style="margin-top: 20px; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; color: white;">
          <h4 style="margin: 0 0 15px 0; color: white;">üí∞ C√°lculo de Saldo Insoluto</h4>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
            <div>
              <p style="margin: 5px 0; font-size: 14px; opacity: 0.9;">Total Calculado:</p>
              <p style="margin: 0; font-size: 24px; font-weight: bold;">${formatearMonto(calculoData.total_calculado)}</p>
            </div>
            <div>
              <p style="margin: 5px 0; font-size: 14px; opacity: 0.9;">Estado:</p>
              <p style="margin: 0; font-size: 16px;">
                <span style="padding: 4px 12px; background: ${calculoData.estado === 'aprobado' ? '#28a745' : '#ffc107'}; border-radius: 20px; font-size: 14px;">
                  ${calculoData.estado === 'aprobado' ? '‚úÖ Aprobado' : '‚è≥ Pendiente'}
                </span>
              </p>
            </div>
          </div>
          <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 8px; margin-top: 10px;">
            <p style="margin: 5px 0; font-size: 13px; opacity: 0.9;">
              üìÖ Fecha: ${formatearFecha(calculoData.fecha_calculo)} | 
              üë§ Calculado por: ${calculoData.funcionario_nombre || 'N/A'}
            </p>
          </div>
        </div>

        <div style="margin-top: 20px; padding: 20px; background: #f8f9fa; border-radius: 12px; border-left: 4px solid #667eea;">
          <h4 style="margin: 0 0 15px 0;">üìä Detalle de Beneficios</h4>
          <div style="overflow-x: auto;">
            <table style="width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden;">
              <thead>
                <tr style="background: #667eea; color: white;">
                  <th style="padding: 12px; text-align: left; font-size: 14px;">C√≥digo</th>
                  <th style="padding: 12px; text-align: left; font-size: 14px;">Beneficio</th>
                  <th style="padding: 12px; text-align: right; font-size: 14px;">Monto</th>
                </tr>
              </thead>
              <tbody>
                ${calculoData.beneficios.map((ben, idx) => `
                  <tr style="border-bottom: 1px solid #e9ecef; ${idx % 2 === 0 ? 'background: #f8f9fa;' : 'background: white;'}">
                    <td style="padding: 10px 12px; font-size: 14px; font-weight: 600;">${ben.codigo}</td>
                    <td style="padding: 10px 12px; font-size: 14px;">${ben.nombre}</td>
                    <td style="padding: 10px 12px; font-size: 14px; text-align: right; font-weight: 600; color: #28a745;">${formatearMonto(ben.monto)}</td>
                  </tr>
                `).join('')}
                <tr style="background: #e9ecef; font-weight: bold;">
                  <td colspan="2" style="padding: 12px; text-align: right; font-size: 16px;">TOTAL:</td>
                  <td style="padding: 12px; text-align: right; font-size: 18px; color: #667eea;">${formatearMonto(calculoData.total_calculado)}</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
        ` : `
        <div style="margin-top: 20px; padding: 15px; background: #fff3cd; border-radius: 8px; border-left: 4px solid #ffc107;">
          <p style="margin: 0; color: #856404;">
            ‚ö†Ô∏è <strong>No se ha calculado el saldo insoluto</strong> para este expediente.
          </p>
        </div>
        `}

        <div style="margin-top: 30px; padding: 20px; background: #f0f4ff; border-radius: 12px; border: 2px solid #667eea;">
          <h4 style="margin: 0 0 20px 0; color: #333;">‚úÖ Aprobaci√≥n por Items - Jefatura</h4>
          
          ${crearItemAprobacion('causante', 'üë§ Causante', aprobacionItems.causante, solicitudActual.solicitud_id)}
          ${crearItemAprobacion('beneficiarios', 'üë• Beneficiarios', aprobacionItems.beneficiarios, solicitudActual.solicitud_id)}
          ${crearItemAprobacion('firmas', '‚úçÔ∏è Firmas', aprobacionItems.firmas, solicitudActual.solicitud_id)}
          ${crearItemAprobacion('calculo', 'üí∞ C√°lculo de Saldo Insoluto', aprobacionItems.calculo, solicitudActual.solicitud_id)}
          ${crearItemAprobacion('documentos', 'üìÅ Documentos', aprobacionItems.documentos, solicitudActual.solicitud_id)}
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
          <div>
            <h4>üë§ Datos del Causante</h4>
            <p><strong>Nombre:</strong> ${solicitudActual.causante.nombre_completo}</p>
            <p><strong>RUT:</strong> ${solicitudActual.causante.rut}</p>
            <p><strong>Fecha de fallecimiento:</strong> ${formatearFecha(solicitudActual.causante.fecha_defuncion)}</p>
          </div>
          
          <div>
            <h4>üë®‚Äçüíº Datos del Representante</h4>
            <p><strong>Nombre:</strong> ${solicitudActual.representante.nombre_completo}</p>
            <p><strong>RUT:</strong> ${solicitudActual.representante.rut}</p>
            <p><strong>Calidad:</strong> ${solicitudActual.representante.calidad}</p>
          </div>
        </div>

        <div style="margin-top: 20px;">
          <h4>üë• Beneficiarios</h4>
          <div style="display: grid; gap: 10px;">
            ${solicitudActual.beneficiarios.map(ben => `
              <div style="padding: 10px; background: #f8f9fa; border-radius: 6px; border-left: 4px solid ${ben.firmado ? '#28a745' : '#ffc107'};">
                <strong>${ben.nombre}</strong> (${ben.rut})<br>
                <small>Parentesco: ${ben.parentesco} | ${ben.firmado ? '‚úÖ Firmado' : '‚è≥ Pendiente'}</small>
              </div>
            `).join('')}
          </div>
        </div>

        <div style="margin-top: 20px;">
          <h4>üìÅ Documentos</h4>
          <div style="display: grid; gap: 10px;">
            ${solicitudActual.documentos.lista.map(doc => `
              <div style="padding: 10px; background: #f8f9fa; border-radius: 6px; cursor: pointer; transition: all 0.2s;" 
                   onclick="abrirModalDocumento(${doc.id}, '${doc.nombre.replace(/'/g, "\\'")}')"
                   onmouseover="this.style.background='#e9ecef'; this.style.transform='translateY(-2px)'"
                   onmouseout="this.style.background='#f8f9fa'; this.style.transform='translateY(0)'">
                <strong>${doc.tipo}</strong><br>
                <small style="color: #0d6efd; text-decoration: underline;">üëÅÔ∏è ${doc.nombre}</small>
              </div>
            `).join('')}
          </div>
        </div>
      `;

      // Botones de acci√≥n
      const puedeAprobar = requisitos.every(req => req.cumple);
      
      actions.innerHTML = `
        <button class="btn btn-secondary" onclick="cerrarModal()">Cerrar</button>
        ${solicitudActual.estado === 'completado' ? `
          <span style="padding: 8px 16px; background: #28a745; color: white; border-radius: 8px; font-weight: bold;">
            ‚úÖ Solicitud Aprobada
          </span>
        ` : puedeAprobar ? `
          <button class="btn btn-success" onclick="aprobarSolicitud(${solicitudActual.solicitud_id})">
            ‚úÖ Aprobar Solicitud
          </button>
        ` : `
          <button class="btn btn-warning" onclick="rechazarSolicitud(${solicitudActual.solicitud_id})">
            ‚ùå Rechazar (Faltan requisitos)
          </button>
        `}
      `;

      modal.style.display = 'block';
    }

    // Funci√≥n helper para crear item de aprobaci√≥n con checkbox y campo de observaci√≥n
    function crearItemAprobacion(itemTipo, titulo, estadoItem, solicitudId) {
      const estado = estadoItem?.estado || 'pendiente';
      const observacion = estadoItem?.observacion || '';
      const fechaAprobacion = estadoItem?.fecha_aprobacion || '';
      const aprobadoPor = estadoItem?.aprobado_por || '';
      
      const estadoColor = estado === 'aprobado' ? '#28a745' : estado === 'rechazado' ? '#dc3545' : '#6c757d';
      const estadoIcono = estado === 'aprobado' ? '‚úÖ' : estado === 'rechazado' ? '‚ùå' : '‚è≥';
      const estadoTexto = estado === 'aprobado' ? 'Aprobado' : estado === 'rechazado' ? 'Rechazado' : 'Pendiente';
      
      return `
        <div style="margin-bottom: 20px; padding: 15px; background: white; border-radius: 8px; border-left: 4px solid ${estadoColor};">
          <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px;">
            <div style="display: flex; align-items: center; gap: 10px;">
              <h5 style="margin: 0; font-size: 16px;">${titulo}</h5>
              <span style="padding: 4px 10px; background: ${estadoColor}; color: white; border-radius: 12px; font-size: 12px;">
                ${estadoIcono} ${estadoTexto}
              </span>
            </div>
            <div style="display: flex; gap: 10px; align-items: center;">
              <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                <input type="checkbox" id="check_${itemTipo}_${solicitudId}" 
                  ${estado === 'aprobado' ? 'checked' : ''} 
                  ${estado === 'aprobado' ? '' : `onchange="if(this.checked) toggleItemAprobacion('${itemTipo}', ${solicitudId}, true)"`}
                  style="width: 18px; height: 18px; cursor: pointer;"
                  ${estado === 'aprobado' ? 'disabled' : ''}>
                <span style="font-size: 14px;">Aprobar</span>
              </label>
              <button onclick="toggleItemAprobacion('${itemTipo}', ${solicitudId}, false)" 
                style="padding: 5px 12px; background: #dc3545; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px;">
                Rechazar
              </button>
            </div>
          </div>
          
          ${estado === 'rechazado' || observacion ? `
            <div style="margin-top: 10px;">
              <label style="display: block; margin-bottom: 5px; font-size: 13px; font-weight: 600;">Observaci√≥n:</label>
              <textarea id="obs_${itemTipo}_${solicitudId}" 
                placeholder="Ingrese la raz√≥n del rechazo..." 
                style="width: 100%; min-height: 60px; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 13px; font-family: inherit;"
                ${estado === 'rechazado' ? 'required' : ''}>${observacion}</textarea>
              ${estado === 'rechazado' ? `
                <button onclick="guardarRechazo('${itemTipo}', ${solicitudId})" 
                  style="margin-top: 8px; padding: 6px 15px; background: #dc3545; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px;">
                  Guardar Rechazo
                </button>
              ` : ''}
            </div>
          ` : `
            <div id="obs_container_${itemTipo}_${solicitudId}" style="display: none; margin-top: 10px;">
              <label style="display: block; margin-bottom: 5px; font-size: 13px; font-weight: 600;">Observaci√≥n (obligatoria):</label>
              <textarea id="obs_${itemTipo}_${solicitudId}" 
                placeholder="Ingrese la raz√≥n del rechazo..." 
                style="width: 100%; min-height: 60px; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 13px; font-family: inherit;"
                required></textarea>
              <button onclick="guardarRechazo('${itemTipo}', ${solicitudId})" 
                style="margin-top: 8px; padding: 6px 15px; background: #dc3545; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px;">
                Guardar Rechazo
              </button>
            </div>
          `}
          
          ${fechaAprobacion ? `
            <div style="margin-top: 8px; font-size: 12px; color: #6c757d;">
              üìÖ ${formatearFecha(fechaAprobacion)} ${aprobadoPor ? `| üë§ ${aprobadoPor}` : ''}
            </div>
          ` : ''}
        </div>
      `;
    }

    // Funci√≥n para toggle de aprobaci√≥n/rechazo de item
    async function toggleItemAprobacion(itemTipo, solicitudId, aprobar) {
      if (aprobar) {
        // Aprobar item
        try {
          const response = await fetch(`http://localhost:3001/api/solicitudes/${solicitudId}/aprobacion-items`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({
              item_tipo: itemTipo,
              estado: 'aprobado',
              observacion: ''
            })
          });
          
          if (response.ok) {
            alert(`‚úÖ Item ${itemTipo} aprobado exitosamente`);
            verDetalles(solicitudActual.id); // Recargar modal
          } else {
            const error = await response.json();
            alert(`‚ùå Error: ${error.error || 'Error al aprobar item'}`);
          }
        } catch (error) {
          alert(`‚ùå Error: ${error.message}`);
        }
      } else {
        // Mostrar campo de observaci√≥n para rechazo
        const obsContainer = document.getElementById(`obs_container_${itemTipo}_${solicitudId}`);
        if (obsContainer) {
          obsContainer.style.display = 'block';
        }
      }
    }

    // Funci√≥n para guardar rechazo con observaci√≥n
    async function guardarRechazo(itemTipo, solicitudId) {
      const observacion = document.getElementById(`obs_${itemTipo}_${solicitudId}`).value.trim();
      
      if (!observacion) {
        alert('‚ö†Ô∏è La observaci√≥n es obligatoria al rechazar un item');
        return;
      }
      
      try {
        const response = await fetch(`http://localhost:3001/api/solicitudes/${solicitudId}/aprobacion-items`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({
            item_tipo: itemTipo,
            estado: 'rechazado',
            observacion: observacion
          })
        });
        
        if (response.ok) {
          alert(`‚ùå Item ${itemTipo} rechazado exitosamente`);
          verDetalles(solicitudActual.id); // Recargar modal
        } else {
          const error = await response.json();
          alert(`‚ùå Error: ${error.error || 'Error al rechazar item'}`);
        }
      } catch (error) {
        alert(`‚ùå Error: ${error.message}`);
      }
    }

    // Funci√≥n para verificar requisitos de una solicitud
    function verificarRequisitos(solicitud) {
      return [
        {
          descripcion: 'Solicitud firmada por funcionario',
          cumple: solicitud.firmado_funcionario === true,
          texto: solicitud.firmado_funcionario === true ? '‚úÖ Firmado' : '‚ùå No firmado'
        },
        {
          descripcion: 'Todos los beneficiarios han firmado',
          cumple: solicitud.firmas.pendientes === 0
        },
        {
          descripcion: 'Documentos requeridos subidos',
          cumple: solicitud.documentos.total >= 2
        },
        {
          descripcion: 'Datos del causante completos',
          cumple: solicitud.causante.nombre_completo && solicitud.causante.rut && solicitud.causante.fecha_defuncion
        },
        {
          descripcion: 'Datos del representante completos',
          cumple: solicitud.representante.nombre_completo && solicitud.representante.rut && solicitud.representante.calidad
        }
      ];
    }

    // Funci√≥n para aprobar una solicitud
    async function aprobarSolicitud(solicitudId) {
      if (!confirm('¬øEst√°s seguro de que deseas aprobar esta solicitud?\n\nSe verificar√° que todos los items est√©n aprobados.')) {
        return;
      }

      try {
        const response = await fetch(`http://localhost:3001/api/solicitudes/${solicitudId}/aprobar`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include'
        });
        
        if (response.ok) {
          const result = await response.json();
          alert('‚úÖ Solicitud aprobada exitosamente');
          
          cerrarModal();
          cargarSolicitudes(); // Recargar lista (la aprobada desaparecer√° del filtro)
        } else {
          const error = await response.json();
          alert(`‚ùå Error: ${error.error || 'Error al aprobar la solicitud'}`);
        }
        
      } catch (error) {
        console.error('Error aprobando solicitud:', error);
        alert(`‚ùå Error: ${error.message || 'Error al aprobar la solicitud'}`);
      }
    }

    // Funci√≥n para rechazar una solicitud
    async function rechazarSolicitud(solicitudId) {
      const motivo = prompt('Ingresa el motivo del rechazo:');
      if (!motivo) return;

      try {
        // Aqu√≠ ir√≠a la llamada al backend para rechazar
        // const response = await fetch(`/api/solicitudes/${solicitudId}/rechazar`, {
        //   method: 'POST',
        //   headers: { 'Content-Type': 'application/json' },
        //   credentials: 'include',
        //   body: JSON.stringify({ motivo })
        // });

        alert('‚ùå Solicitud rechazada');
        cerrarModal();
        cargarSolicitudes();
        
      } catch (error) {
        console.error('Error rechazando solicitud:', error);
        alert('‚ùå Error al rechazar la solicitud');
      }
    }

    // Funci√≥n para cerrar el modal
    function cerrarModal() {
      document.getElementById('modal-detalles').style.display = 'none';
    }
    
    // Funciones para el modal de documentos
    function abrirModalDocumento(documentoId, nombreDocumento) {
      const modal = document.getElementById('modal-documento');
      const iframe = document.getElementById('documento-iframe');
      const titulo = document.getElementById('modal-documento-titulo');
      const descargarLink = document.getElementById('descargar-documento-link');
      
      // Configurar t√≠tulo
      titulo.textContent = `üìÑ ${nombreDocumento}`;
      
      // Configurar iframe para visualizar el documento
      const urlVisualizar = `http://localhost:3001/api/documentos/${documentoId}/ver`;
      iframe.src = urlVisualizar;
      
      // Configurar link de descarga
      descargarLink.href = `http://localhost:3001/api/download-documento/${documentoId}`;
      
      // Mostrar modal
      modal.style.display = 'flex';
    }
    
    function cerrarModalDocumento(event) {
      if (event && event.target.id !== 'modal-documento') {
        return;
      }
      const modal = document.getElementById('modal-documento');
      const iframe = document.getElementById('documento-iframe');
      
      // Limpiar iframe
      iframe.src = '';
      
      // Ocultar modal
      modal.style.display = 'none';
    }

    // Funci√≥n para formatear fechas
    function formatearFecha(fecha) {
      if (!fecha) return 'No especificada';
      return new Date(fecha).toLocaleDateString('es-CL');
    }

    // Funci√≥n para obtener texto del estado
    function obtenerTextoEstado(estado) {
      const estados = {
        'borrador': 'Borrador',
        'firmado_funcionario': 'Firmado por Funcionario',
        'completado': 'Completado (Aprobado)',
        'pendiente': 'Pendiente (En Revisi√≥n)'
      };
      return estados[estado] || estado;
    }

    // Cerrar modal al hacer clic fuera de √©l
    window.onclick = function(event) {
      const modal = document.getElementById('modal-detalles');
      if (event.target === modal) {
        cerrarModal();
      }
    }
  </script>
</body>
</html>
