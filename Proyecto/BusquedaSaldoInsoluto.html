<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Consulta de Saldos Insolutos</title>
  <style>
    :root { --c1:#0d6efd; --cBg:#f6f7fb; --text:#333; --border:#e5e7eb; }
    * { box-sizing: border-box; }
    body {
      margin:0;
      font-family: Arial, sans-serif;
      background: linear-gradient(120deg, #e3f0ff 0%, #f7e3e3 100%, #f5f7fb 100%);
      color:var(--text);
      min-height: 100vh;
    }
    .header { background:#fff; border-bottom:1px solid var(--border); padding:20px; text-align:center; }
    h1 { margin:0; color:var(--c1); font-size:28px; }
    .container { max-width:1200px; margin:0 auto; padding:20px; }
    .search-box { background:#fff; border-radius:12px; padding:24px; box-shadow:0 4px 12px rgba(0,0,0,0.1); margin-bottom:20px; }
    .form-group { margin-bottom:16px; }
    label { display:block; margin-bottom:6px; font-weight:500; }
    input, select { width:100%; padding:12px; border:1px solid var(--border); border-radius:8px; font-size:16px; }
    .btn { background:var(--c1); color:#fff; border:none; padding:12px 24px; border-radius:8px; cursor:pointer; font-size:16px; }
    .btn:hover { background:#084298; }
    .results { background:#fff; border-radius:12px; padding:24px; box-shadow:0 4px 12px rgba(0,0,0,0.1); }
    .no-results { text-align:center; color:#6b7280; padding:40px; }
    .editable { background: #fff3cd !important; border: 2px dashed #ffc107 !important; }
    .edit-mode input, .edit-mode select, .edit-mode textarea { background: white; border: 1px solid #0d6efd; }
    .btn-success { background: #28a745; }
    .btn-success:hover { background: #1e7e34; }
    .btn-warning { background: #ffc107; color: #000; }
    .btn-warning:hover { background: #e0a800; }
    .btn-danger { background: #dc3545; }
    .btn-danger:hover { background: #c82333; }
    .rechazado-badge { background: #dc3545; color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: bold; }
    .items-rechazados { background: #fff5f5; border-left: 4px solid #dc3545; padding: 12px; border-radius: 6px; margin-top: 12px; }
    .item-rechazado { background: white; padding: 10px; margin-bottom: 8px; border-radius: 4px; border-left: 3px solid #dc3545; }
  </style>
</head>
<body>
  <header class="header">
    <h1>Consulta de Saldos Insolutos</h1>
  </header>
  
  <div class="container">
    <div style="display: flex; gap: 20px; margin-bottom: 20px;">
      <button class="btn" onclick="mostrarBusqueda()" id="btnBusqueda" style="flex: 1;">üîç Buscar por RUT</button>
      <button class="btn" onclick="mostrarRechazados()" id="btnRechazados" style="flex: 1; background: #dc3545;">‚ö†Ô∏è Mis Expedientes Rechazados</button>
    </div>
    
    <!-- Secci√≥n de B√∫squeda -->
    <div id="seccionBusqueda">
      <div class="search-box">
        <h2>Buscar Saldo Insoluto</h2>
        <form id="searchForm">
          <div class="form-group">
            <label for="rut">RUT del Fallecido</label>
            <input type="text" id="rut" placeholder="12.345.678-9" required>
          </div>
          <button type="submit" class="btn">Buscar</button>
        </form>
      </div>
      
      <div class="results" id="results" style="display:none;">
        <h3>Resultados de la B√∫squeda</h3>
        <div id="resultsContent"></div>
      </div>
      
      <div class="no-results" id="noResults" style="display:none;">
        <p>No se encontraron saldos insolutos para los criterios de b√∫squeda.</p>
      </div>
    </div>
    
    <!-- Secci√≥n de Expedientes Rechazados -->
    <div id="seccionRechazados" style="display:none;">
      <div class="search-box">
        <h2>‚ö†Ô∏è Mis Expedientes Rechazados</h2>
        <p style="color: #666; margin-bottom: 16px;">Aqu√≠ puedes ver y editar tus expedientes que fueron rechazados por la jefatura.</p>
        <button class="btn" onclick="cargarRechazados()" style="background: #dc3545;">üîÑ Cargar Expedientes Rechazados</button>
      </div>
      
      <div class="results" id="rechazadosResults" style="display:none;">
        <h3>Expedientes Rechazados</h3>
        <div id="rechazadosContent"></div>
      </div>
      
      <div class="no-results" id="noRechazados" style="display:none;">
        <p>No tienes expedientes rechazados pendientes de correcci√≥n.</p>
      </div>
    </div>
  </div>

  <script>
    // Funci√≥n para calcular d√≠gito verificador
    function calcularDV(rut) {
      let suma = 0;
      let multiplicador = 2;
      
      for (let i = rut.length - 1; i >= 0; i--) {
        suma += parseInt(rut[i]) * multiplicador;
        multiplicador = multiplicador < 7 ? multiplicador + 1 : 2;
      }
      
      let resto = suma % 11;
      let dv = 11 - resto;
      
      if (dv === 11) return '0';
      if (dv === 10) return 'K';
      return dv.toString();
    }

    // Funci√≥n para formatear RUT autom√°ticamente
    function formatRUT(e) {
      let value = e.target.value.replace(/[^0-9kK-]/g, '');
      
      if (!value) {
        e.target.value = '';
        return;
      }
      
      // Si tiene guion, separar body y DV
      if (value.includes('-')) {
        let parts = value.split('-');
        let body = parts[0].replace(/[^0-9]/g, '');
        let dv = parts[1] ? parts[1].replace(/[^0-9kK]/g, '').toUpperCase() : '';
        
        if (!body) {
          e.target.value = dv ? '-' + dv : '';
          return;
        }
        
        // Formatear body con puntos
        let formatted = '';
        if (body.length > 6) {
          formatted = body.slice(0, -6) + '.' + body.slice(-6, -3) + '.' + body.slice(-3);
        } else if (body.length > 3) {
          formatted = body.slice(0, -3) + '.' + body.slice(-3);
        } else {
          formatted = body;
        }
        
        e.target.value = formatted + (dv ? '-' + dv : '');
        return;
      }
      
      // Si no tiene guion
      let numeros = value.replace(/[^0-9]/g, '');
      let letras = value.replace(/[^kK]/g, '');
      
      // Si tiene 8-9 caracteres (8 d√≠gitos + 1 DV), separar body y DV
      if (numeros.length >= 8 || (numeros.length >= 7 && letras.length > 0)) {
        let body = numeros.slice(0, 8);
        let dv = value.slice(-1).toUpperCase();
        
        // Formatear body con puntos
        let formatted = '';
        if (body.length === 8) {
          formatted = body.slice(0, 2) + '.' + body.slice(2, 5) + '.' + body.slice(5);
        } else if (body.length > 6) {
          formatted = body.slice(0, -6) + '.' + body.slice(-6, -3) + '.' + body.slice(-3);
        } else if (body.length > 3) {
          formatted = body.slice(0, -3) + '.' + body.slice(-3);
        } else {
          formatted = body;
        }
        
        e.target.value = formatted + '-' + dv;
      } else if (numeros.length > 0) {
        // Menos de 8 d√≠gitos, solo formatear con puntos
        let formatted = '';
        if (numeros.length > 6) {
          formatted = numeros.slice(0, -6) + '.' + numeros.slice(-6, -3) + '.' + numeros.slice(-3);
        } else if (numeros.length > 3) {
          formatted = numeros.slice(0, -3) + '.' + numeros.slice(-3);
        } else {
          formatted = numeros;
        }
        e.target.value = formatted;
      } else {
        e.target.value = value;
      }
    }

    // Configurar formateo autom√°tico de RUT
    document.addEventListener('DOMContentLoaded', function() {
      const rutField = document.getElementById('rut');
      if (rutField) {
        rutField.addEventListener('input', formatRUT);
      }
    });

    document.getElementById('searchForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      let rut = document.getElementById('rut').value.trim();
      
      if (!rut) {
        alert('Ingresa el RUT del fallecido');
        return;
      }
      
      // Si el RUT no tiene formato completo, intentar completarlo
      let rutNumeros = rut.replace(/[^0-9]/g, '');
      if (rutNumeros.length >= 7 && rutNumeros.length <= 8 && !rut.includes('-')) {
        // Calcular DV autom√°ticamente si falta
        let dv = calcularDV(rutNumeros);
        rut = rutNumeros + '-' + dv;
        console.log('üîß RUT completado autom√°ticamente:', rut);
      }
      
      // Mostrar loading
      const submitBtn = e.target.querySelector('button[type="submit"]');
      const originalText = submitBtn.textContent;
      submitBtn.textContent = 'Buscando...';
      submitBtn.disabled = true;
      
      try {
        console.log('üîç Buscando por RUT:', rut);
        console.log('üîç RUT length:', rut.length);
        console.log('üîç RUT type:', typeof rut);
        
        const requestData = { rut: rut };
        console.log('üîç Datos a enviar:', requestData);
        
        const response = await fetch('http://localhost:3001/api/buscar-saldo-insoluto', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          credentials: 'include',
          body: JSON.stringify(requestData)
        });
        
        console.log('üì° Respuesta recibida:', response.status);
        
        if (!response.ok) {
          // Intentar obtener el mensaje de error del servidor
          let errorMessage = `Error del servidor: ${response.status}`;
          try {
            const errorData = await response.json();
            if (errorData.error) {
              errorMessage = errorData.error;
            }
          } catch (e) {
            console.log('No se pudo obtener mensaje de error detallado');
          }
          throw new Error(errorMessage);
        }
        
        const resultado = await response.json();
        console.log('üìã Resultado completo:', resultado);
        
        if (resultado.success) {
          if (resultado.data.total > 0) {
            showResults(resultado.data);
          } else {
            showNoResults(rut);
          }
        } else {
          throw new Error(resultado.error || 'Error desconocido');
        }
        
      } catch (error) {
        console.error('‚ùå Error en b√∫squeda:', error);
        alert(`‚ùå Error al buscar saldo insoluto:\n\n${error.message}\n\nPor favor, verifica que el servidor est√© corriendo y vuelve a intentar.`);
      } finally {
        // Restaurar bot√≥n
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
      }
    });
    
    function showResults(data) {
      document.getElementById('results').style.display = 'block';
      document.getElementById('noResults').style.display = 'none';
      
      let html = `<h3>Resultados para RUT: ${data.rut}</h3>`;
      html += `<p class="muted">Se encontraron ${data.total} saldo(s) insoluto(s)</p>`;
      
      data.expedientes.forEach(expediente => {
        html += `
          <div style="border:1px solid #e5e7eb; border-radius:8px; padding:16px; margin-bottom:16px; background:#f8f9fa;">
            <div style="display:flex; justify-content:space-between; align-items:start; margin-bottom:12px;">
              <h4 style="margin:0; color:#0d6efd;">${expediente.causante.nombre_completo}</h4>
              <span style="background:${expediente.color_estado}; color:white; padding:4px 8px; border-radius:4px; font-size:12px; font-weight:bold;">
                ${expediente.estado_general}
              </span>
            </div>
            
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:12px;">
              <div>
                <p style="margin:4px 0;"><strong>RUT:</strong> ${expediente.causante.rut}</p>
                <p style="margin:4px 0;"><strong>Fecha Defunci√≥n:</strong> ${expediente.causante.fecha_defuncion}</p>
                <p style="margin:4px 0;"><strong>Sucursal:</strong> ${expediente.causante.sucursal}</p>
              </div>
              <div>
                <p style="margin:4px 0;"><strong>Expediente:</strong> ${expediente.expediente_numero}</p>
                <p style="margin:4px 0;"><strong>Folio:</strong> ${expediente.folio}</p>
                <p style="margin:4px 0;"><strong>Estado:</strong> ${expediente.solicitud.estado}</p>
              </div>
            </div>
            
            <div style="background:white; padding:12px; border-radius:6px; border-left:4px solid ${expediente.color_estado};">
              <p style="margin:4px 0;"><strong>Estado de Firmas:</strong></p>
              <p style="margin:4px 0;">
                Beneficiarios: ${expediente.firmas.total_beneficiarios} | 
                Firmados: ${expediente.firmas.beneficiarios_firmados} | 
                Pendientes: ${expediente.firmas.pendientes}
              </p>
              <p style="margin:4px 0; font-size:12px; color:#6c757d;">
                Creado: ${expediente.solicitud.fecha_creacion}
              </p>
            </div>
          </div>
        `;
      });
      
      document.getElementById('resultsContent').innerHTML = html;
    }
    
    function showNoResults(rut) {
      document.getElementById('results').style.display = 'none';
      document.getElementById('noResults').style.display = 'block';
      
      document.getElementById('noResults').innerHTML = `
        <div style="text-align:center; padding:40px;">
          <div style="font-size:48px; margin-bottom:16px;">üîç</div>
          <h3>No se encontraron resultados</h3>
          <p>No se encontraron saldos insolutos para el RUT: <strong>${rut}</strong></p>
          <p style="color:#6c757d; font-size:14px;">
            Verifica que el RUT est√© correcto o que existan expedientes para esta persona.
          </p>
        </div>
      `;
    }
    
    // Funciones para cambiar entre secciones
    function mostrarBusqueda() {
      document.getElementById('seccionBusqueda').style.display = 'block';
      document.getElementById('seccionRechazados').style.display = 'none';
      document.getElementById('btnBusqueda').style.background = '#0d6efd';
      document.getElementById('btnRechazados').style.background = '#dc3545';
    }
    
    function mostrarRechazados() {
      document.getElementById('seccionBusqueda').style.display = 'none';
      document.getElementById('seccionRechazados').style.display = 'block';
      document.getElementById('btnBusqueda').style.background = '#6c757d';
      document.getElementById('btnRechazados').style.background = '#c82333';
      cargarRechazados();
    }
    
    // Cargar expedientes rechazados del funcionario
    async function cargarRechazados() {
      const rechazadosResults = document.getElementById('rechazadosResults');
      const noRechazados = document.getElementById('noRechazados');
      const rechazadosContent = document.getElementById('rechazadosContent');
      
      rechazadosResults.style.display = 'none';
      noRechazados.style.display = 'none';
      rechazadosContent.innerHTML = '<p>Cargando...</p>';
      
      try {
        const response = await fetch('http://localhost:3001/api/solicitudes-rechazadas', {
          method: 'GET',
          credentials: 'include'
        });
        
        if (response.status === 401) {
          alert('Sesi√≥n no v√°lida. Inicia sesi√≥n e int√©ntalo de nuevo.');
          return;
        }
        
        if (!response.ok) {
          throw new Error('Error al cargar expedientes rechazados');
        }
        
        const resultado = await response.json();
        
        if (resultado.success && resultado.data && resultado.data.length > 0) {
          mostrarRechazadosList(resultado.data);
          rechazadosResults.style.display = 'block';
        } else {
          noRechazados.style.display = 'block';
          rechazadosContent.innerHTML = '';
        }
      } catch (error) {
        console.error('Error cargando rechazados:', error);
        alert(`Error: ${error.message}`);
        rechazadosContent.innerHTML = '';
      }
    }
    
    // Mostrar lista de expedientes rechazados
    async function mostrarRechazadosList(expedientes) {
      const rechazadosContent = document.getElementById('rechazadosContent');
      
      let html = '';
      
      for (const exp of expedientes) {
        // Cargar detalles de aprobaci√≥n para cada expediente
        let aprobacionItems = {};
        try {
          const aprobResp = await fetch(`http://localhost:3001/api/solicitudes/${exp.solicitud_id}/aprobacion-items`, {
            method: 'GET',
            credentials: 'include'
          });
          if (aprobResp.ok) {
            const aprobJson = await aprobResp.json();
            aprobacionItems = aprobJson.data || {};
          }
        } catch (error) {
          console.warn('Error cargando aprobaciones:', error);
        }
        
        html += `
          <div class="editable" style="border:1px solid #dc3545; border-radius:8px; padding:20px; margin-bottom:20px; background:#fff5f5;">
            <div style="display:flex; justify-content:space-between; align-items:start; margin-bottom:16px;">
              <div>
                <h4 style="margin:0; color:#333;">${exp.folio} - ${exp.causante.nombre_completo}</h4>
                <p style="margin:4px 0; color:#666; font-size:14px;">RUT: ${exp.causante.rut}</p>
              </div>
              <span class="rechazado-badge">${exp.estado_solicitud === 'rechazado/enRevision' ? 'üîÑ EN REVISI√ìN' : '‚ùå RECHAZADO'}</span>
            </div>
            
            ${Object.keys(aprobacionItems).filter(tipo => aprobacionItems[tipo].estado === 'rechazado').length > 0 ? `
            <div class="items-rechazados">
              <strong style="color:#dc3545; display:block; margin-bottom:8px;">‚ö†Ô∏è Items Rechazados:</strong>
              ${Object.entries(aprobacionItems).filter(([tipo, item]) => item.estado === 'rechazado').map(([tipo, item]) => `
                <div class="item-rechazado">
                  <strong>${tipo === 'causante' ? 'üë§ Causante' : 
                    tipo === 'beneficiarios' ? 'üë• Beneficiarios' : 
                    tipo === 'firmas' ? '‚úçÔ∏è Firmas' : 
                    tipo === 'calculo' ? 'üí∞ C√°lculo' : 
                    tipo === 'documentos' ? 'üìÅ Documentos' : tipo}</strong>
                  <p style="margin:4px 0; font-size:13px; color:#333;">${item.observacion || 'Sin observaci√≥n'}</p>
                </div>
              `).join('')}
            </div>
            ` : ''}
            
            ${exp.estado_solicitud === 'rechazado/enRevision' ? `
            <div style="background: #d4edda; border: 2px solid #28a745; border-radius: 8px; padding: 12px; margin-top: 16px; color: #155724;">
              <strong>‚úÖ Solicitud enviada a revisi√≥n</strong>
              <p style="margin: 4px 0 0 0; font-size: 14px;">La jefatura est√° evaluando las correcciones realizadas.</p>
            </div>
            ` : `
            <div style="margin-top:16px; display:flex; gap:10px;">
              <button class="btn btn-warning" onclick="editarExpediente(${exp.expediente_id}, ${exp.solicitud_id})">
                ‚úèÔ∏è Editar Expediente
              </button>
              <button class="btn btn-success" onclick="reenviarExpediente(${exp.solicitud_id})">
                üì§ Enviar a Revisi√≥n
              </button>
            </div>
            `}
          </div>
        `;
      }
      
      rechazadosContent.innerHTML = html;
    }
    
    // Funci√≥n para editar expediente (redirige a formulario de edici√≥n)
    function editarExpediente(expedienteId, solicitudId) {
      // Redirigir a RevisionExpediente con el expediente cargado
      window.location.href = `RevisionExpediente.html?expediente_id=${expedienteId}&solicitud_id=${solicitudId}&modo=edicion`;
    }
    
    // Funci√≥n para reenviar expediente (mantener por compatibilidad)
    async function reenviarExpediente(solicitudId) {
      if (!confirm('¬øEst√°s seguro de que deseas reenviar este expediente para nueva evaluaci√≥n?\n\nAseg√∫rate de haber realizado todas las correcciones necesarias.')) {
        return;
      }
      
      try {
        const response = await fetch(`http://localhost:3001/api/solicitudes/${solicitudId}/reenviar`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include'
        });
        
        if (response.ok) {
          const result = await response.json();
          alert('‚úÖ Expediente reenviado exitosamente. La jefatura podr√° evaluarlo nuevamente.');
          cargarRechazados(); // Recargar lista
        } else {
          const error = await response.json();
          alert(`‚ùå Error: ${error.error || 'Error al reenviar expediente'}`);
        }
      } catch (error) {
        alert(`‚ùå Error: ${error.message}`);
      }
    }
    
    // Funci√≥n para enviar expediente a revisi√≥n
    async function enviarExpedienteRevision(solicitudId) {
      if (!confirm('¬øEst√°s seguro de que deseas enviar este expediente a revisi√≥n?\n\nLa solicitud aparecer√° en la cola de jefatura para nueva evaluaci√≥n.')) {
        return;
      }
      
      try {
        const response = await fetch(`http://localhost:3001/api/solicitudes/${solicitudId}/enviar`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include'
        });
        
        if (response.ok) {
          const result = await response.json();
          alert('‚úÖ Expediente enviado a revisi√≥n exitosamente. La jefatura podr√° evaluarlo nuevamente.');
          cargarRechazados(); // Recargar lista
        } else {
          const error = await response.json();
          alert(`‚ùå Error: ${error.error || 'Error al enviar expediente a revisi√≥n'}`);
        }
      } catch (error) {
        alert(`‚ùå Error: ${error.message}`);
      }
    }
  </script>
</body>
</html>
