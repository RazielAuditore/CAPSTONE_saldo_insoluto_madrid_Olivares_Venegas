<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Saldo Insoluto ‚Äî Formulario</title>
  <style>
    :root { --c1:#0d6efd; --c2:#f8f9fa; --b:#212529; --muted:#6c757d; --ok:#28a745; --bad:#dc3545; }
    * { box-sizing: border-box; }
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background: linear-gradient(120deg, #e3f0ff 0%, #f7e3e3 100%, #f5f7fb 100%);
      color: #222;
      min-height: 100vh;
    }
    .logo-ips {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1000;
      width: 220px;
      max-width: 30vw;
      height: auto;
    }
    h1 { margin: 0 0 16px; }
    .card { background:#fff; border-radius:12px; box-shadow:0 8px 24px rgba(0,0,0,0.06); overflow:hidden; }
    .tabs { display:flex; gap:8px; padding:12px; background:var(--c2); border-bottom:1px solid #e9ecef; flex-wrap: wrap; }
    .tab-btn { padding:10px 14px; border:1px solid #e9ecef; background:#fff; border-radius:8px; cursor:pointer; color:#333; }
    .tab-btn.active { background:var(--c1); border-color:var(--c1); color:#fff; }
    .section { display:none; padding:18px; }
    .section.active { display:block; }
    fieldset { border:1px solid #e9ecef; border-radius:10px; padding:14px; margin:0 0 16px; background:#fff; }
    legend { padding:0 8px; color:#555; }
    label { display:block; margin-top:10px; color:#333; font-size:14px; }
    input, select, textarea { width:100%; padding:10px; margin-top:6px; border:1px solid #ced4da; border-radius:8px; background:#fff; }
    .row { display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    .row3 { display:grid; grid-template-columns: 1fr 1fr 1fr; gap:12px; }
    .region-comuna-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      align-items: end;
    }
    .region-comuna-row label {
      margin-bottom: 0;
    }
    @media (max-width: 700px) {
      .region-comuna-row { grid-template-columns: 1fr; }
    }
    .actions { display:flex; justify-content:space-between; gap:12px; margin-top:18px; flex-wrap: wrap; }
    .btn { padding:10px 14px; border:none; border-radius:8px; cursor:pointer; }
    .btn-primary { background:var(--c1); color:#fff; }
    .btn-secondary { background:#adb5bd; color:#fff; }
    .btn-ok { background:var(--ok); color:#fff; }
    .btn-bad { background:var(--bad); color:#fff; }
    table { width:100%; border-collapse: collapse; margin-top:12px; }
    th, td { border-bottom: 1px solid #e9ecef; padding:10px; text-align:left; }
    th { background:#f8f9fa; }
    .muted { color: var(--muted); font-size: 13px; }
    .badge { display:inline-block; padding:4px 10px; border-radius:999px; font-size:12px; background:#eef; margin-left:8px; }
    .badge.ok { background:#e6f6ea; color:#0f7a2e; }
    
    /* Estilos para lista de archivos */
    .archivos-lista {
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 10px;
      background-color: #f9f9f9;
    }
    
    .archivo-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px;
      margin: 5px 0;
      background-color: white;
      border: 1px solid #eee;
      border-radius: 4px;
    }
    
    .archivo-info {
      flex: 1;
    }
    
    .archivo-nombre {
      font-weight: bold;
      color: #333;
    }
    
    .archivo-detalles {
      font-size: 0.9em;
      color: #666;
    }
    
    .archivo-acciones {
      display: flex;
      gap: 10px;
    }
    
    /* Estilos para documentos */
    .documento-item {
      margin-bottom: 20px;
      padding: 15px;
      border: 1px solid #e9ecef;
      border-radius: 8px;
      background-color: #f8f9fa;
    }
    
    .tipo-documento-select {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid #ced4da;
      border-radius: 4px;
      font-size: 14px;
      background-color: white;
    }
    
    .tipo-documento-select:focus {
      outline: none;
      border-color: var(--c1);
      box-shadow: 0 0 0 2px rgba(13, 110, 253, 0.25);
    }
    
    .col-md-6 {
      flex: 0 0 50%;
      padding: 0 10px;
    }
    
    @media (max-width: 700px) { 
      .row, .row3 { grid-template-columns: 1fr; } 
      .col-md-6 { flex: 0 0 100%; padding: 0; }
    }
  </style>
</head>
<body>
  <img src="img/IPS_ChileAtiende_logo.png.png" alt="IPS ChileAtiende" class="logo-ips" />
  <h1>Formulario de saldo insoluto  </h1>
  <div class="card">
    <!-- Tabs -->
    <div class="tabs">
      <button class="tab-btn active" data-tab="rep">Representante</button>
      <button class="tab-btn" data-tab="fal">Causante</button>
      <button class="tab-btn" data-tab="ben">Beneficiarios</button>
      <button class="tab-btn" data-tab="docs">Documentos</button>
      <button class="tab-btn" data-tab="validacion">Validaci√≥n</button>
      <button class="tab-btn" data-tab="enviar">Enviar</button>
    </div>

    <form id="formSaldo" onsubmit="handleSubmit(event)" method="post" novalidate>
      <!-- REPRESENTANTE -->
      <section id="rep" class="section active">
        <fieldset>
          <legend><b>Datos del Representante</b></legend>
          <div class="row">
            <label>RUT Representante
              <input id="rep_rut" name="rep_rut" type="text" placeholder="12.345.678-9" required>
            </label>
            <label>Calidad
              <select id="rep_calidad" name="rep_calidad">
                <option value="Heredero">Heredero</option>
                <option value="Representante con poder">Representante con poder</option>
                <option value="Curador">Curador</option>
              </select>
            </label>
          </div>
          <div class="row">
            <label>Nombres
              <input id="rep_nombre" name="rep_nombre" type="text" required>
            </label>
            <label>Apellido Paterno
              <input id="rep_apellido_p" name="rep_apellido_p" type="text" required>
            </label>
          </div>
          <div class="row">
            <label>Apellido Materno
              <input id="rep_apellido_m" name="rep_apellido_m" type="text">
            </label>
            <label>Tel√©fono
              <input id="rep_telefono" name="rep_telefono" type="tel" placeholder="+56 9 1234 5678">
            </label>
          </div>
          <label>Domicilio
            <input id="rep_direccion" name="rep_direccion" type="text">
          </label>
          <div class="row">
            <label>Comuna
              <input id="rep_comuna" name="rep_comuna" type="text">
            </label>
            <label>Regi√≥n
              <input id="rep_region" name="rep_region" type="text">
            </label>
          </div>
          <label>Email
            <input id="rep_email" name="rep_email" type="email">
          </label>
        </fieldset>
        <div class="actions">
          <span class="muted">Completa los datos del representante y avanza.</span>
          <button type="button" class="btn btn-primary" onclick="goTab('fal')">Siguiente: Fallecido </button>
        </div>
      </section>

      <!-- FALLECIDO -->
      <section id="fal" class="section">
        <fieldset>
          <legend><b>Datos del Causante</b></legend>
          <div class="row">
            <label>RUT Causante
              <input id="fal_run" name="fal_run" type="text" placeholder="12.345.678-9" required>
            </label>
            <label>Nacionalidad
              <select id="fal_nac" name="fal_nac">
                <option value="Chileno/a">Chileno/a</option>
                <option value="Extranjero/a">Extranjero/a</option>
              </select>
            </label>
          </div>
          <div class="row">
            <label>Nombres
              <input id="fal_nombre" name="fal_nombre" type="text" required>
            </label>
            <label>Apellido Paterno
              <input id="fal_apellido_p" name="fal_apellido_p" type="text" required>
            </label>
          </div>
          <div class="row">
            <label>Apellido Materno
              <input id="fal_apellido_m" name="fal_apellido_m" type="text">
            </label>
            <label>Fecha Defunci√≥n
              <input id="fal_fecha_defuncion" name="fal_fecha_defuncion" type="date">
            </label>
        </div>
        <div class="row region-comuna-row">
            <!-- Regi√≥n de fallecimiento eliminada -->
            <label style="flex:1; min-width:180px; max-width:260px;">Comuna de fallecimiento
              <input id="fal_comuna_defuncion" name="fal_comuna_defuncion" type="text" maxlength="50" placeholder="Ingrese comuna...">
            </label>
          </div>
        </fieldset>
        <div class="actions">
          <button type="button" class="btn btn-secondary" onclick="goTab('rep')">‚Üê Volver</button>
          <button type="button" class="btn btn-primary" onclick="goTab('ben')">Siguiente: Beneficiarios </button>
        </div>
      </section>

      <!-- BENEFICIARIOS -->
      <section id="ben" class="section">
        <fieldset>
          <legend><b>Beneficiarios / Herederos</b></legend>

          <div class="row3">
            <label>Nombre completo
              <input id="ben_nombre" type="text" placeholder="Ej.: Ana P√©rez G√≥mez">
            </label>
            <label>RUN
              <input id="ben_run" type="text" placeholder="12.345.678-9"
                     pattern="\\d{1,2}\\.\\d{3}\\.\\d{3}-[0-9kK]">
            </label>
            <label>Parentesco
              <select id="ben_parentesco">
                <option value="">Seleccione...</option>
                <option>C√≥nyuge (esposo/a sobreviviente)</option>
                <option>Conviviente civil</option>
                <option>Hijos/as</option>
                <option>Nietos/as (cuando heredan por representaci√≥n de un hijo fallecido)</option>
                <option>Padres</option>
                <option>Madre o padre sobreviviente</option>
                <option>Abuelos/as</option>
                <option>Hermanos/as</option>
                <option>Sobrinos/as (heredan por representaci√≥n de un hermano fallecido)</option>
                <option>T√≠os/as</option>
                <option>Sobrinos/as nietos/as (hijos de tus sobrinos)</option>
                <option>Primos/as hermanos/as (hijos de tus t√≠os)</option>
                <option>T√≠os/as abuelos/as (hermanos de tus abuelos)</option>
                <option>Primos/as segundos/as (hijos de primos hermanos)</option>
                <option>Parientes m√°s lejanos hasta el 6¬∫ grado de consanguinidad</option>
              </select>
            </label>
          </div>
          <div class="actions">
            <button type="button" class="btn btn-ok" onclick="agregarBeneficiario()">+ Agregar beneficiario</button>
          </div>

          <table id="tablaBen">
            <thead>
              <tr>
                <th>Nombre</th><th>RUN</th><th>Parentesco</th><th>¬øRepresentante?</th><th></th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
          <p class="muted">Marca ‚ÄúRepresentante‚Äù solo para la persona que act√∫a en representaci√≥n.</p>
        </fieldset>
        <div class="actions">
          <button type="button" class="btn btn-secondary" onclick="goTab('fal')"> Volver</button>
          <button type="button" class="btn btn-primary" onclick="goTab('docs')">Siguiente: Documentos </button>
        </div>
      </section>

      <!-- DOCUMENTOS -->
      <section id="docs" class="section">
        <fieldset>
          <legend><b>Documentos</b></legend>
          <div id="documentos-container">
            <!-- Documento 1 -->
            <div class="documento-item">
              <div class="row">
                <div class="col-md-6">
                  <label>Tipo de Documento
                    <select name="tipo_documento[]" class="tipo-documento-select" required>
                      <option value="">Seleccione el tipo de documento</option>
                      <option value="1">Certificado de Defunci√≥n</option>
                      <option value="2">Certificado de Nacimiento</option>
                      <option value="3">Certificado de Matrimonio</option>
                      <option value="4">C√©dula de Identidad</option>
                      <option value="5">Poder Notarial</option>
                      <option value="6">Resoluci√≥n de Posesi√≥n Efectiva</option>
                      <option value="7">Otros Documentos</option>
                    </select>
                  </label>
                </div>
                <div class="col-md-6">
                  <label>Archivo
                    <input type="file" name="documento[]" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx" required />
                  </label>
                </div>
              </div>
            </div>

            <!-- Documento 2 -->
            <div class="documento-item">
              <div class="row">
                <div class="col-md-6">
                  <label>Tipo de Documento
                    <select name="tipo_documento[]" class="tipo-documento-select">
                      <option value="">Seleccione el tipo de documento</option>
                      <option value="1">Certificado de Defunci√≥n</option>
                      <option value="2">Certificado de Nacimiento</option>
                      <option value="3">Certificado de Matrimonio</option>
                      <option value="4">C√©dula de Identidad</option>
                      <option value="5">Poder Notarial</option>
                      <option value="6">Resoluci√≥n de Posesi√≥n Efectiva</option>
                      <option value="7">Otros Documentos</option>
                    </select>
                  </label>
                </div>
                <div class="col-md-6">
                  <label>Archivo
                    <input type="file" name="documento[]" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx" />
                  </label>
                </div>
              </div>
            </div>

            <!-- Documento 3 -->
            <div class="documento-item">
              <div class="row">
                <div class="col-md-6">
                  <label>Tipo de Documento
                    <select name="tipo_documento[]" class="tipo-documento-select">
                      <option value="">Seleccione el tipo de documento</option>
                      <option value="1">Certificado de Defunci√≥n</option>
                      <option value="2">Certificado de Nacimiento</option>
                      <option value="3">Certificado de Matrimonio</option>
                      <option value="4">C√©dula de Identidad</option>
                      <option value="5">Poder Notarial</option>
                      <option value="6">Resoluci√≥n de Posesi√≥n Efectiva</option>
                      <option value="7">Otros Documentos</option>
                    </select>
                  </label>
                </div>
                <div class="col-md-6">
                  <label>Archivo
                    <input type="file" name="documento[]" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx" />
                  </label>
                </div>
              </div>
            </div>

            <!-- Documento 4 -->
            <div class="documento-item">
              <div class="row">
                <div class="col-md-6">
                  <label>Tipo de Documento
                    <select name="tipo_documento[]" class="tipo-documento-select">
                      <option value="">Seleccione el tipo de documento</option>
                      <option value="1">Certificado de Defunci√≥n</option>
                      <option value="2">Certificado de Nacimiento</option>
                      <option value="3">Certificado de Matrimonio</option>
                      <option value="4">C√©dula de Identidad</option>
                      <option value="5">Poder Notarial</option>
                      <option value="6">Resoluci√≥n de Posesi√≥n Efectiva</option>
                      <option value="7">Otros Documentos</option>
                    </select>
                  </label>
                </div>
                <div class="col-md-6">
                  <label>Archivo
                    <input type="file" name="documento[]" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx" />
                  </label>
                </div>
              </div>
            </div>

            <!-- Documento 5 -->
            <div class="documento-item">
              <div class="row">
                <div class="col-md-6">
                  <label>Tipo de Documento
                    <select name="tipo_documento[]" class="tipo-documento-select">
                      <option value="">Seleccione el tipo de documento</option>
                      <option value="1">Certificado de Defunci√≥n</option>
                      <option value="2">Certificado de Nacimiento</option>
                      <option value="3">Certificado de Matrimonio</option>
                      <option value="4">C√©dula de Identidad</option>
                      <option value="5">Poder Notarial</option>
                      <option value="6">Resoluci√≥n de Posesi√≥n Efectiva</option>
                      <option value="7">Otros Documentos</option>
                    </select>
                  </label>
                </div>
                <div class="col-md-6">
                  <label>Archivo
                    <input type="file" name="documento[]" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx" />
                  </label>
                </div>
              </div>
            </div>
          </div>
          <button type="button" class="btn btn-ok" id="addDocBtn" style="margin-top:10px;">+ Agregar otro documento</button>
          
          <!-- Secci√≥n para mostrar archivos subidos -->
          <div id="archivos-subidos" style="margin-top: 20px; display: none;">
            <h4>üìÅ Archivos Subidos</h4>
            <div id="lista-archivos" class="archivos-lista">
              <!-- Los archivos se mostrar√°n aqu√≠ din√°micamente -->
            </div>
          </div>
        </fieldset>
        <div class="actions">
          <button type="button" class="btn btn-secondary" onclick="goTab('ben')"> Volver</button>
          <button type="button" class="btn btn-primary" onclick="goTab('validacion')">Siguiente: Validaci√≥n </button>
        </div>
      </section>

      <!-- VALIDACI√ìN Y EXPEDICI√ìN -->
      <section id="validacion" class="section">
        <fieldset>
          <legend><b>Validaci√≥n y Expedici√≥n</b></legend>
          <label>Sucursal de expedici√≥n
            <input type="text" id="sucursal" name="sucursal" placeholder="Ej: IPS Providencia">
          </label>

          <div class="row">
            <div>
              <label>Clave del Funcionario (para firmar y validar)
                <input type="password" id="pass_func" name="pass_func" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
              </label>
              <button type="button" class="btn btn-ok" onclick="firmarFuncionario()">Firmar y Validar</button>
              <span id="badge_func" class="badge" style="display:none;">Sin firma</span>
            </div>
          </div>

          <p class="muted" style="margin-top:8px;">
            La firma se genera como <b>HMAC-SHA256</b> usando la clave del funcionario logueado. El representante firmar√° con la aplicaci√≥n externa.
          </p>
        </fieldset>
        <div class="actions">
          <button type="button" class="btn btn-secondary" onclick="goTab('docs')">‚Üê Volver</button>
          <button type="button" class="btn btn-primary" onclick="goTab('enviar')">Siguiente: Enviar ‚Üí</button>
        </div>
      </section>

      <!-- ENVIAR -->
      <section id="enviar" class="section">
        <fieldset>
          <legend><b>Revisi√≥n y Env√≠o</b></legend>
          <p class="muted">Al enviar, los datos se guardar√°n en la base de datos y se generar√° un ID √∫nico para el saldo insoluto. Tambi√©n se descargar√° un archivo JSON de respaldo.</p>
          <div class="actions">
            <button type="button" class="btn btn-secondary" onclick="goTab('validacion')">‚Üê Volver</button>
            <button type="submit" class="btn btn-ok">Guardar Solicitud</button>
          </div>
        </fieldset>
      </section>
    </form>
  </div>

  <script>
    // Variables globales
    let currentTab = 'rep';
    let beneficiarios = [];



    // --- Comunas por regi√≥n ---
    const comunasPorRegion = {
      "Arica y Parinacota": ["Arica", "Camarones", "Putre", "General Lagos"],
      "Tarapac√°": ["Iquique", "Alto Hospicio", "Pozo Almonte", "Cami√±a", "Colchane", "Huara", "Pica"],
      "Antofagasta": ["Antofagasta", "Mejillones", "Sierra Gorda", "Taltal", "Calama", "Ollag√ºe", "San Pedro de Atacama", "Tocopilla", "Mar√≠a Elena"],
      "Atacama": ["Copiap√≥", "Caldera", "Tierra Amarilla", "Cha√±aral", "Diego de Almagro", "Vallenar", "Alto del Carmen", "Freirina", "Huasco"],
      "Coquimbo": ["La Serena", "Coquimbo", "Andacollo", "La Higuera", "Paiguano", "Vicu√±a", "Illapel", "Canela", "Los Vilos", "Salamanca", "Ovalle", "Combarbal√°", "Monte Patria", "Punitaqui", "R√≠o Hurtado"],
      "Valpara√≠so": ["Valpara√≠so", "Casablanca", "Conc√≥n", "Juan Fern√°ndez", "Puchuncav√≠", "Quintero", "Vi√±a del Mar", "Quilpu√©", "Limache", "Olmu√©", "Villa Alemana", "Isla de Pascua", "Los Andes", "Calle Larga", "Rinconada", "San Esteban", "La Ligua", "Cabildo", "Papudo", "Petorca", "Zapallar", "Quillota", "Calera", "Hijuelas", "La Cruz", "Nogales", "San Antonio", "Algarrobo", "Cartagena", "El Quisco", "El Tabo", "Santo Domingo", "San Felipe", "Catemu", "Llaillay", "Panquehue", "Putaendo", "Santa Mar√≠a"],
      "Metropolitana de Santiago": ["Cerrillos", "Cerro Navia", "Conchal√≠", "El Bosque", "Estaci√≥n Central", "Huechuraba", "Independencia", "La Cisterna", "La Florida", "La Granja", "La Pintana", "La Reina", "Las Condes", "Lo Barnechea", "Lo Espejo", "Lo Prado", "Macul", "Maip√∫", "√ëu√±oa", "Pedro Aguirre Cerda", "Pe√±alol√©n", "Providencia", "Pudahuel", "Quilicura", "Quinta Normal", "Recoleta", "Renca", "San Joaqu√≠n", "San Miguel", "San Ram√≥n", "Vitacura", "Puente Alto", "Pirque", "San Jos√© de Maipo", "Colina", "Lampa", "Tiltil", "San Bernardo", "Buin", "Calera de Tango", "Paine", "Melipilla", "Alhu√©", "Curacav√≠", "Mar√≠a Pinto", "San Pedro", "Talagante", "El Monte", "Isla de Maipo", "Padre Hurtado", "Pe√±aflor"],
      "Libertador General Bernardo O'Higgins": ["Rancagua", "Codegua", "Coinco", "Coltauco", "Do√±ihue", "Graneros", "Las Cabras", "Machal√≠", "Malloa", "Mostazal", "Olivar", "Peumo", "Pichidegua", "Quinta de Tilcoco", "Rengo", "Requ√≠noa", "San Vicente", "Pichilemu", "La Estrella", "Litueche", "Marchihue", "Navidad", "Paredones", "San Fernando", "Ch√©pica", "Chimbarongo", "Lolol", "Nancagua", "Palmilla", "Peralillo", "Placilla", "Pumanque", "Santa Cruz"],
      "Maule": ["Talca", "Constituci√≥n", "Curepto", "Empedrado", "Maule", "Pelarco", "Pencahue", "R√≠o Claro", "San Clemente", "San Rafael", "Cauquenes", "Chanco", "Pelluhue", "Curic√≥", "Huala√±√©", "Licant√©n", "Molina", "Rauco", "Romeral", "Sagrada Familia", "Teno", "Vichuqu√©n", "Linares", "Colb√∫n", "Longav√≠", "Parral", "Retiro", "San Javier", "Villa Alegre", "Yerbas Buenas"],
      "√ëuble": ["Chill√°n", "Bulnes", "Cobquecura", "Coelemu", "Coihueco", "Chill√°n Viejo", "El Carmen", "Ninhue", "√ëiqu√©n", "Pemuco", "Pinto", "Portezuelo", "Quill√≥n", "Quirihue", "R√°nquil", "San Carlos", "San Fabi√°n", "San Ignacio", "San Nicol√°s", "Treguaco", "Yungay"],
      "Biob√≠o": ["Concepci√≥n", "Coronel", "Chiguayante", "Florida", "Hualp√©n", "Hualqui", "Lota", "Penco", "San Pedro de la Paz", "Santa Juana", "Talcahuano", "Tom√©", "Hualqui", "Cabrero", "Laja", "Los √Ångeles", "Mulch√©n", "Nacimiento", "Negrete", "Quilaco", "Quilleco", "San Rosendo", "Santa B√°rbara", "Tucapel", "Yumbel", "Alto Biob√≠o"],
      "La Araucan√≠a": ["Temuco", "Carahue", "Cunco", "Curarrehue", "Freire", "Galvarino", "Gorbea", "Lautaro", "Loncoche", "Melipeuco", "Nueva Imperial", "Padre Las Casas", "Perquenco", "Pitrufqu√©n", "Puc√≥n", "Saavedra", "Teodoro Schmidt", "Tolt√©n", "Vilc√∫n", "Villarrica", "Cholchol", "Angol", "Collipulli", "Curacaut√≠n", "Ercilla", "Lonquimay", "Los Sauces", "Lumaco", "Pur√©n", "Renaico", "Traigu√©n", "Victoria"],
      "Los R√≠os": ["Valdivia", "Corral", "Lanco", "Los Lagos", "M√°fil", "Mariquina", "Paillaco", "Panguipulli", "La Uni√≥n", "Futrono", "Lago Ranco", "R√≠o Bueno"],
      "Los Lagos": ["Puerto Montt", "Calbuco", "Cocham√≥", "Fresia", "Frutillar", "Los Muermos", "Llanquihue", "Maull√≠n", "Puerto Varas", "Castro", "Ancud", "Chonchi", "Curaco de V√©lez", "Dalcahue", "Puqueld√≥n", "Queil√©n", "Quell√≥n", "Quemchi", "Quinchao", "Osorno", "Puerto Octay", "Purranque", "Puyehue", "R√≠o Negro", "San Juan de la Costa", "San Pablo"],
      "Ays√©n del General Carlos Ib√°√±ez del Campo": ["Coyhaique", "Lago Verde", "Ays√©n", "Cisnes", "Guaitecas", "Cochrane", "O'Higgins", "Tortel", "Chile Chico", "R√≠o Ib√°√±ez"],
      "Magallanes y de la Ant√°rtica Chilena": ["Punta Arenas", "Laguna Blanca", "R√≠o Verde", "San Gregorio", "Cabo de Hornos", "Ant√°rtica", "Porvenir", "Primavera", "Timaukel", "Natales", "Torres del Paine"]
    };

    document.addEventListener('DOMContentLoaded', function() {
      // Verificar que los elementos existan antes de usarlos
      const regionSelect = document.getElementById('fal_region');
      const comunaSelect = document.getElementById('fal_comuna');
      
      // Solo ejecutar si los elementos existen
      if (regionSelect && comunaSelect) {
        // Al cargar la p√°gina, solo mostrar la opci√≥n por defecto
        comunaSelect.innerHTML = '<option value="">Seleccione comuna...</option>';
        regionSelect.addEventListener('change', function() {
          const region = regionSelect.value;
          comunaSelect.innerHTML = '<option value="">Seleccione comuna...</option>';
          if (comunasPorRegion[region]) {
            comunasPorRegion[region].forEach(comuna => {
              const opt = document.createElement('option');
              opt.value = comuna;
              opt.textContent = comuna;
              comunaSelect.appendChild(opt);
            });
          }
        });
      }

      // Configurar formateo autom√°tico de RUT
      const rutFields = ['rep_rut', 'fal_run', 'ben_run'];
      rutFields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) {
          field.addEventListener('input', formatRUT);
        }
      });

      // Configurar autocompletado desde Excel
      configurarAutocompletado();
    });

    // ----- Autocompletado desde Excel -----
    function normalizarRUT(rut) {
      if (!rut) return '';
      return rut.replace(/[^0-9kK]/gi, '').toUpperCase();
    }

    function esRUTCompleto(rut) {
      const rutNorm = normalizarRUT(rut);
      return rutNorm.length >= 8 && rutNorm.length <= 9;
    }

    async function autocompletarRepresentante(rut) {
      if (!esRUTCompleto(rut)) return;

      try {
        const response = await fetch(`http://localhost:3001/api/autocompletar/representante/${encodeURIComponent(rut)}`, {
          method: 'GET',
          credentials: 'include'
        });

        if (response.ok) {
          const resultado = await response.json();
          if (resultado.data) {
            const datos = resultado.data;
            
            // Autocompletar campos del representante
            if (datos.rut) document.getElementById('rep_rut').value = datos.rut;
            if (datos.calidad) document.getElementById('rep_calidad').value = datos.calidad;
            if (datos.nombre) document.getElementById('rep_nombre').value = datos.nombre;
            if (datos.apellido_paterno) document.getElementById('rep_apellido_p').value = datos.apellido_paterno;
            if (datos.apellido_materno) document.getElementById('rep_apellido_m').value = datos.apellido_materno;
            if (datos.telefono) document.getElementById('rep_telefono').value = datos.telefono;
            if (datos.direccion) document.getElementById('rep_direccion').value = datos.direccion;
            if (datos.comuna) document.getElementById('rep_comuna').value = datos.comuna;
            if (datos.region) document.getElementById('rep_region').value = datos.region;
            if (datos.email) document.getElementById('rep_email').value = datos.email;

            console.log('‚úÖ Datos del representante autocompletados');
          }
        } else if (response.status === 404) {
          console.log('‚ÑπÔ∏è Representante no encontrado en Excel');
        }
      } catch (error) {
        console.error('‚ùå Error al autocompletar representante:', error);
      }
    }

    async function autocompletarCausante(rut) {
      if (!esRUTCompleto(rut)) return;

      try {
        const response = await fetch(`http://localhost:3001/api/autocompletar/causante/${encodeURIComponent(rut)}`, {
          method: 'GET',
          credentials: 'include'
        });

        if (response.ok) {
          const resultado = await response.json();
          if (resultado.data) {
            const datos = resultado.data;
            
            // Autocompletar campos del causante
            if (datos.rut) document.getElementById('fal_run').value = datos.rut;
            if (datos.nacionalidad) document.getElementById('fal_nac').value = datos.nacionalidad;
            if (datos.nombre) document.getElementById('fal_nombre').value = datos.nombre;
            if (datos.apellido_paterno) document.getElementById('fal_apellido_p').value = datos.apellido_paterno;
            if (datos.apellido_materno) document.getElementById('fal_apellido_m').value = datos.apellido_materno;
            if (datos.fecha_defuncion) document.getElementById('fal_fecha_defuncion').value = datos.fecha_defuncion;
            if (datos.comuna_defuncion) document.getElementById('fal_comuna_defuncion').value = datos.comuna_defuncion;

            console.log('‚úÖ Datos del causante autocompletados');

            // Despu√©s de autocompletar causante, cargar beneficiarios autom√°ticamente
            await autocompletarBeneficiarios(rut);
          }
        } else if (response.status === 404) {
          console.log('‚ÑπÔ∏è Causante no encontrado en Excel');
        }
      } catch (error) {
        console.error('‚ùå Error al autocompletar causante:', error);
      }
    }

    async function autocompletarBeneficiarios(rutCausante) {
      if (!esRUTCompleto(rutCausante)) return;

      try {
        const response = await fetch(`http://localhost:3001/api/autocompletar/beneficiarios/${encodeURIComponent(rutCausante)}`, {
          method: 'GET',
          credentials: 'include'
        });

        if (response.ok) {
          const resultado = await response.json();
          if (resultado.data && resultado.data.length > 0) {
            const beneficiarios = resultado.data;
            
            // Limpiar tabla de beneficiarios existente
            const tbody = document.querySelector("#tablaBen tbody");
            tbody.innerHTML = '';

            // Agregar cada beneficiario a la tabla
            beneficiarios.forEach(ben => {
              // Separar nombre completo en nombre y apellidos si es necesario
              const nombreCompleto = ben.nombre_completo || '';
              const partes = nombreCompleto.split(' ');
              const nombre = partes[0] || '';
              const apellidos = partes.slice(1).join(' ') || '';

              // Llenar campos temporales
              document.getElementById('ben_nombre').value = nombreCompleto;
              document.getElementById('ben_run').value = ben.rut_beneficiario || '';
              document.getElementById('ben_parentesco').value = ben.parentesco || '';

              // Agregar a la tabla
              agregarBeneficiario();

              // Si es representante, marcar el checkbox
              const ultimaFila = tbody.querySelector('tr:last-child');
              if (ultimaFila && ben.es_representante) {
                const checkbox = ultimaFila.querySelector('.esRep');
                if (checkbox) checkbox.checked = true;
              }
            });

            // Limpiar campos temporales
            document.getElementById('ben_nombre').value = '';
            document.getElementById('ben_run').value = '';
            document.getElementById('ben_parentesco').value = '';

            console.log(`‚úÖ ${beneficiarios.length} beneficiario(s) autocompletado(s)`);
          } else {
            console.log('‚ÑπÔ∏è No se encontraron beneficiarios en Excel');
          }
        }
      } catch (error) {
        console.error('‚ùå Error al autocompletar beneficiarios:', error);
      }
    }

    function configurarAutocompletado() {
      // Autocompletar representante cuando se completa el RUT
      const repRutField = document.getElementById('rep_rut');
      if (repRutField) {
        repRutField.addEventListener('blur', function() {
          const rut = this.value.trim();
          if (rut && esRUTCompleto(rut)) {
            autocompletarRepresentante(rut);
          }
        });
      }

      // Autocompletar causante cuando se completa el RUT
      const falRunField = document.getElementById('fal_run');
      if (falRunField) {
        falRunField.addEventListener('blur', function() {
          const rut = this.value.trim();
          if (rut && esRUTCompleto(rut)) {
            autocompletarCausante(rut);
          }
        });
      }

      // Autocompletar nombre de beneficiario cuando se completa el RUT
      const benRunField = document.getElementById('ben_run');
      if (benRunField) {
        benRunField.addEventListener('blur', async function() {
          const rut = this.value.trim();
          if (rut && esRUTCompleto(rut)) {
            await autocompletarNombreBeneficiario(rut);
          }
        });
      }
    }

    async function autocompletarNombreBeneficiario(rut) {
      try {
        const response = await fetch(`http://localhost:3001/api/autocompletar/beneficiario/${encodeURIComponent(rut)}`, {
          method: 'GET',
          credentials: 'include'
        });

        if (response.ok) {
          const resultado = await response.json();
          if (resultado.data && resultado.data.nombre) {
            // Solo autocompletar el nombre
            document.getElementById('ben_nombre').value = resultado.data.nombre;
            console.log('‚úÖ Nombre del beneficiario autocompletado');
          }
        } else if (response.status === 404) {
          console.log('‚ÑπÔ∏è Beneficiario no encontrado en Excel');
        }
      } catch (error) {
        console.error('‚ùå Error al autocompletar beneficiario:', error);
      }
    }
    // ----- Tabs -----
    const tabButtons = document.querySelectorAll(".tab-btn");
    function goTab(id) {
      document.querySelectorAll(".section").forEach(s => s.classList.remove("active"));
      document.getElementById(id).classList.add("active");
      tabButtons.forEach(b => b.classList.toggle("active", b.dataset.tab === id));
    }
    tabButtons.forEach(b => b.addEventListener("click", () => goTab(b.dataset.tab)));

    // ----- Beneficiarios din√°micos -----

    // ----- Funci√≥n para calcular d√≠gito verificador -----
    function calcularDV(rut) {
      let suma = 0;
      let multiplicador = 2;
      
      for (let i = rut.length - 1; i >= 0; i--) {
        suma += parseInt(rut[i]) * multiplicador;
        multiplicador = multiplicador < 7 ? multiplicador + 1 : 2;
      }
      
      let resto = suma % 11;
      let dv = 11 - resto;
      
      if (dv === 11) return '0';
      if (dv === 10) return 'K';
      return dv.toString();
    }

    // ----- Formateo autom√°tico de RUT -----
    function formatRUT(e) {
      let input = e.target;
      let value = input.value.replace(/[^0-9kK]/g, '');
      
      if (value.length > 0) {
        // Determinar si es RUT de 7 o 8 d√≠gitos (sin contar el DV)
        const bodyLength = value.length - 1; // Restar el d√≠gito verificador
        
        if (bodyLength <= 7) {
          // Formato: x.xxx.xxx-x (7 d√≠gitos + DV)
          if (value.length > 1) {
            value = value.substring(0, 1) + '.' + value.substring(1);
          }
          if (value.length > 5) {
            value = value.substring(0, 5) + '.' + value.substring(5);
          }
        } else {
          // Formato: xx.xxx.xxx-x (8 d√≠gitos + DV)
          if (value.length > 2) {
            value = value.substring(0, 2) + '.' + value.substring(2);
          }
          if (value.length > 6) {
            value = value.substring(0, 6) + '.' + value.substring(6);
          }
        }
        
        // Agregar gui√≥n antes del √∫ltimo car√°cter si es necesario
        if (value.length > 8 && !value.includes('-')) {
          const lastChar = value.slice(-1);
          value = value.slice(0, -1) + '-' + lastChar;
        }
      }
      
      input.value = value;
    }

    // ----- Documentos din√°micos -----
    let docCount = 5;
    document.getElementById('addDocBtn').addEventListener('click', function() {
      docCount++;
      const container = document.getElementById('documentos-container');
      const newDiv = document.createElement('div');
      newDiv.className = 'documento-item';
      newDiv.innerHTML = `
        <div class="row">
          <div class="col-md-6">
            <label>Tipo de Documento
              <select name="tipo_documento[]" class="tipo-documento-select">
                <option value="">Seleccione el tipo de documento</option>
                <option value="1">Certificado de Defunci√≥n</option>
                <option value="2">Certificado de Nacimiento</option>
                <option value="3">Certificado de Matrimonio</option>
                <option value="4">C√©dula de Identidad</option>
                <option value="5">Poder Notarial</option>
                <option value="6">Resoluci√≥n de Posesi√≥n Efectiva</option>
                <option value="7">Otros Documentos</option>
              </select>
            </label>
          </div>
          <div class="col-md-6">
            <label>Archivo
              <input type="file" name="documento[]" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx" />
            </label>
          </div>
        </div>
      `;
      container.appendChild(newDiv);
    });
    const tbody = document.querySelector("#tablaBen tbody");
    function agregarBeneficiario() {
      const nombre = document.getElementById("ben_nombre").value.trim();
      const run = document.getElementById("ben_run").value.trim();
      const par = document.getElementById("ben_parentesco").value;
      if (!nombre || !run) { alert("Completa nombre y RUN del beneficiario"); return; }

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${nombre}</td>
        <td>${run}</td>
        <td>${par}</td>
        <td style="text-align:center;"><input type="checkbox" class="esRep"></td>
        <td><button type="button" class="btn btn-bad" onclick="this.closest('tr').remove()">Eliminar</button></td>
      `;
      tbody.appendChild(tr);

      document.getElementById("ben_nombre").value = "";
      document.getElementById("ben_run").value = "";
      document.getElementById("ben_parentesco").value = "";
    }

    // ----- WebCrypto utils -----
    function strToUint8(s){ return new TextEncoder().encode(s); }
    function bufToHex(buf){ return [...new Uint8Array(buf)].map(b=>b.toString(16).padStart(2,"0")).join(""); }
    async function deriveHmacKey(password, salt) {
      const baseKey = await crypto.subtle.importKey("raw", strToUint8(password), { name:"PBKDF2" }, false, ["deriveKey"]);
      return crypto.subtle.deriveKey(
        { name:"PBKDF2", salt, iterations:100000, hash:"SHA-256" },
        baseKey,
        { name:"HMAC", hash:"SHA-256", length:256 },
        false,
        ["sign"]
      );
    }
    async function hmacSign(key, payloadStr){
      const sig = await crypto.subtle.sign("HMAC", key, strToUint8(payloadStr));
      return bufToHex(sig);
    }

    // ----- Payload can√≥nico simple para las firmas -----
    function buildPayload() {
      // Puedes agregar m√°s campos si quieres que queden ‚Äúbajo firma‚Äù
      return [
        document.getElementById("fal_run").value,
        document.getElementById("fal_nombre").value,
        document.getElementById("fal_apellido_p").value,
        document.getElementById("fal_fecha_defuncion").value || "",
        document.getElementById("sucursal").value || ""
      ].join("|");
    }

    // ----- Firma del funcionario -----
    let firmaFunc = null; // { firma_hex, salt_hex, ts }

    async function firmarFuncionario(){
      const pass = document.getElementById("pass_func").value.trim();
      if(!pass){ alert("Ingresa la clave del funcionario"); return; }
      
      try {
        // Validar la clave del funcionario con el backend
        const response = await fetch('http://localhost:3001/api/validar-clave-funcionario', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          credentials: 'include',
          body: JSON.stringify({ password: pass })
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error || 'Error validando clave');
        }

        const resultado = await response.json();
        if (!resultado.valid) {
          alert("‚ùå Clave incorrecta. Verifica tu contrase√±a.");
          return;
        }

        // Generar firma HMAC-SHA256
        const salt = crypto.getRandomValues(new Uint8Array(16));
        const key = await deriveHmacKey(pass, salt);
        const payload = buildPayload();
        const firma_hex = await hmacSign(key, payload);
        const ts = new Date().toISOString();
        
        firmaFunc = { 
          payload, 
          firma_hex, 
          salt_hex: bufToHex(salt), 
          algoritmo: "HMAC-SHA256", 
          ts,
          funcionario_id: resultado.funcionario_id,
          funcionario_nombre: resultado.funcionario_nombre
        };
        
        // Guardar el ID de solicitud para enviar la firma despu√©s
        window.solicitudIdParaFirma = null; // Se establecer√° despu√©s de crear la solicitud
        
        const badge = document.getElementById("badge_func");
        badge.textContent = "Funcionario: Firmado y Validado";
        badge.classList.add("ok"); 
        badge.style.display="inline-block";
        alert("‚úÖ Firma del Funcionario generada y validada correctamente");
        
      } catch (error) {
        console.error('Error firmando funcionario:', error);
        alert(`‚ùå Error: ${error.message}`);
      }
    }

    // ----- Subir archivos individuales -----
    async function subirArchivo(file, solicitudId, docTipoId = 1) {
      // Validar que solicitudId sea un n√∫mero v√°lido
      if (!solicitudId || solicitudId === 'undefined' || isNaN(solicitudId)) {
        throw new Error('ID de solicitud inv√°lido para subir archivo');
      }
      
      const formData = new FormData();
      formData.append('archivo', file);
      formData.append('solicitud_id', solicitudId);
      formData.append('doc_tipo_id', docTipoId);
      formData.append('observaciones', 'Subido desde formulario web');

      try {
        const response = await fetch('http://localhost:3001/api/upload-documento', {
          method: 'POST',
          credentials: 'include',
          body: formData
        });

        if (!response.ok) {
          throw new Error(`Error subiendo archivo: ${response.status}`);
        }

        const resultado = await response.json();
        console.log('üìÅ Archivo subido:', resultado);
        return resultado;
      } catch (error) {
        console.error('‚ùå Error subiendo archivo:', error);
        throw error;
      }
    }

    // ----- Subir todos los archivos de una solicitud -----
    async function subirTodosLosArchivos(solicitudId) {
      // Obtener todos los contenedores de documentos (incluyendo los agregados din√°micamente)
      const documentoItems = document.querySelectorAll('#documentos-container .documento-item');
      
      const resultados = [];
      let archivosSubidosCount = 0;
      
      console.log(`üìÅ Encontrados ${documentoItems.length} campos de documento`);
      
      // Recorrer cada contenedor de documento
      for (let i = 0; i < documentoItems.length; i++) {
        const item = documentoItems[i];
        const archivoInput = item.querySelector('input[name="documento[]"]');
        const tipoSelect = item.querySelector('select[name="tipo_documento[]"]');
        
        if (!archivoInput || !tipoSelect) {
          console.warn(`‚ö†Ô∏è Documento ${i + 1}: Campos no encontrados`);
          continue;
        }
        
        const archivo = archivoInput.files[0];
        const tipo = tipoSelect.value;
        
        // Debug
        console.log(`üîç Documento ${i + 1}:`, {
          archivo: archivo ? archivo.name : 'No hay archivo',
          tipo: tipo || 'No hay tipo seleccionado'
        });
        
        // Solo subir si tiene archivo Y tipo seleccionado
        if (archivo && tipo) {
          try {
            archivosSubidosCount++;
            console.log(`üì§ Subiendo archivo ${archivosSubidosCount}: ${archivo.name} (tipo: ${tipo})`);
            const resultado = await subirArchivo(archivo, solicitudId, tipo);
            resultados.push(resultado);
            console.log(`‚úÖ Archivo ${archivosSubidosCount} subido exitosamente: ${archivo.name}`);
          } catch (error) {
            console.error(`‚ùå Error subiendo archivo ${archivosSubidosCount} "${archivo.name}":`, error);
            // Mostrar alerta pero continuar con los dem√°s archivos
            alert(`‚ö†Ô∏è Error subiendo archivo "${archivo.name}": ${error.message}`);
          }
        } else {
          if (archivo && !tipo) {
            console.warn(`‚ö†Ô∏è Archivo "${archivo.name}" no tiene tipo seleccionado - Omitido`);
          } else if (!archivo && tipo) {
            console.warn(`‚ö†Ô∏è Tipo seleccionado pero no hay archivo - Omitido`);
          }
        }
      }
      
      console.log(`üìä Resumen: ${archivosSubidosCount} archivo(s) procesado(s) de ${documentoItems.length} campos`);
      
      return resultados;
    }

    // ----- Mostrar archivos subidos -----
    function mostrarArchivosSubidos(archivos) {
      const seccionArchivos = document.getElementById('archivos-subidos');
      const listaArchivos = document.getElementById('lista-archivos');
      
      // Limpiar lista anterior
      listaArchivos.innerHTML = '';
      
      // Mostrar cada archivo
      archivos.forEach(archivo => {
        const archivoDiv = document.createElement('div');
        archivoDiv.className = 'archivo-item';
        
        const tamanoMB = (archivo.data.tamano_bytes / (1024 * 1024)).toFixed(2);
        
        archivoDiv.innerHTML = `
          <div class="archivo-info">
            <div class="archivo-nombre">${archivo.data.nombre_archivo}</div>
            <div class="archivo-detalles">
              ${archivo.data.mime_type} ‚Ä¢ ${tamanoMB} MB ‚Ä¢ ID: ${archivo.data.documento_id}
            </div>
          </div>
          <div class="archivo-acciones">
            <button type="button" class="btn btn-primary" onclick="descargarArchivo(${archivo.data.documento_id})">
              üì• Descargar
            </button>
          </div>
        `;
        
        listaArchivos.appendChild(archivoDiv);
      });
      
      // Mostrar la secci√≥n
      seccionArchivos.style.display = 'block';
    }

    // ----- Descargar archivo -----
    function descargarArchivo(documentoId) {
      window.open(`http://localhost:3001/api/download-documento/${documentoId}`, '_blank');
    }

    // ----- Enviar (guardar en base de datos) -----
    async function handleSubmit(e) {
      console.log('üöÄ handleSubmit ejecut√°ndose...');
      e.preventDefault();

      // Mostrar loading
      const submitBtn = e.target.querySelector('button[type="submit"]');
      const originalText = submitBtn.textContent;
      submitBtn.textContent = 'Guardando...';
      submitBtn.disabled = true;
      
      console.log('üìù Bot√≥n actualizado a:', submitBtn.textContent);

      try {
        // Validar que los datos b√°sicos est√©n completos
        const rutRep = document.getElementById("rep_rut")?.value || "";
        const nombresRep = document.getElementById("rep_nombre")?.value || "";
        const apPatRep = document.getElementById("rep_apellido_p")?.value || "";
        const rutFal = document.getElementById("fal_run")?.value || "";
        const nombresFal = document.getElementById("fal_nombre")?.value || "";
        const apPatFal = document.getElementById("fal_apellido_p")?.value || "";

        if (!rutRep || !nombresRep || !apPatRep || !rutFal || !nombresFal || !apPatFal) {
          alert("‚ö† Por favor completa los datos b√°sicos del representante y fallecido antes de enviar.");
          goTab('rep');
          return;
        }


        // Preparar datos para enviar a la API (estructura plana como espera el servidor)
        const beneficiarios = Array.from(tbody.querySelectorAll("tr")).map(tr => {
          const tds = tr.querySelectorAll("td");
          return {
            nombre: tds[0]?.textContent || "",
            run: tds[1]?.textContent || "",
            parentesco: tds[2]?.textContent || "",
            es_representante: tr.querySelector(".esRep")?.checked || false
          };
        });

        const data = {
          // Datos del representante
          rep_run: document.getElementById("rep_rut")?.value || "",
          rep_calidad: document.getElementById("rep_calidad")?.value || "",
          rep_nombre: document.getElementById("rep_nombre")?.value || "",
          rep_apellido_p: document.getElementById("rep_apellido_p")?.value || "",
          rep_apellido_m: document.getElementById("rep_apellido_m")?.value || "",
          rep_telefono: document.getElementById("rep_telefono")?.value || "",
          rep_direccion: document.getElementById("rep_direccion")?.value || "",
          rep_comuna: document.getElementById("rep_comuna")?.value || "",
          rep_region: document.getElementById("rep_region")?.value || "",
          rep_email: document.getElementById("rep_email")?.value || "",
          
          // Datos del fallecido
          fal_run: document.getElementById("fal_run")?.value || "",
          fal_nacionalidad: document.getElementById("fal_nac")?.value || "",
          fal_nombre: document.getElementById("fal_nombre")?.value || "",
          fal_apellido_p: document.getElementById("fal_apellido_p")?.value || "",
          fal_apellido_m: document.getElementById("fal_apellido_m")?.value || "",
          fal_fecha_defuncion: document.getElementById("fal_fecha_defuncion")?.value || "",
          fal_comuna_defuncion: document.getElementById("fal_comuna_defuncion")?.value || "",
          
          // Datos de la solicitud
          monto_solicitado: 0, // Campo requerido por el servidor
          motivo_solicitud: "", // Campo eliminado del frontend, se env√≠a vac√≠o
          sucursal: document.getElementById("sucursal")?.value || "",
          
          // Beneficiarios
          beneficiarios: beneficiarios
        };

        // Debug: Mostrar valores espec√≠ficos
        console.log('üîç Debug - Valores de campos:');
        console.log('  fal_fecha_defuncion:', document.getElementById("fal_fecha_defuncion")?.value);
        console.log('  fal_comuna_defuncion:', document.getElementById("fal_comuna_defuncion")?.value);
        console.log('  fal_nombre:', document.getElementById("fal_nombre")?.value);
        
        // Enviar datos a la API
        console.log('üåê Enviando datos a la API...', data);
        const response = await fetch('http://localhost:3001/api/solicitudes', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          credentials: 'include',
          body: JSON.stringify(data)
        });
        
        console.log('üì° Respuesta recibida:', response.status);

        if (!response.ok) {
          throw new Error(`Error del servidor: ${response.status}`);
        }

        const resultado = await response.json();
        console.log('üìã Resultado completo:', resultado);
        console.log('üÜî Solicitud ID del resultado:', resultado.data?.solicitud_id);
        console.log('üìÑ Folio del resultado:', resultado.data?.folio);

        // Validar que tenemos los datos necesarios
        if (!resultado.data || !resultado.data.solicitud_id || !resultado.data.folio) {
          console.error('‚ùå Estructura de respuesta incorrecta:', resultado);
          alert('Error: No se recibieron los datos correctos del servidor');
          return;
        }

        // Enviar firma del funcionario si existe
        if (firmaFunc) {
          try {
            console.log('üîê Enviando firma del funcionario...');
            const firmaResponse = await fetch(`http://localhost:3001/api/solicitudes/${resultado.data.solicitud_id}/firmar-funcionario-directo`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              credentials: 'include',
              body: JSON.stringify({ firma_data: firmaFunc })
            });

            if (firmaResponse.ok) {
              const firmaResult = await firmaResponse.json();
              console.log('‚úÖ Firma del funcionario enviada:', firmaResult);
            } else {
              console.warn('‚ö†Ô∏è Error enviando firma del funcionario:', firmaResponse.status);
            }
          } catch (error) {
            console.warn('‚ö†Ô∏è Error enviando firma del funcionario:', error);
          }
        }

        // Subir archivos si los hay
        let archivosSubidos = [];
        try {
          archivosSubidos = await subirTodosLosArchivos(resultado.data.solicitud_id);
          console.log('üìÅ Archivos subidos:', archivosSubidos);
          
          // Mostrar archivos subidos en la interfaz
          if (archivosSubidos.length > 0) {
            mostrarArchivosSubidos(archivosSubidos);
          }
        } catch (error) {
          console.error('‚ùå Error subiendo archivos:', error);
          // No interrumpir el flujo, solo mostrar advertencia
        }

        // Mostrar mensaje de √©xito
        const mensajeArchivos = archivosSubidos.length > 0 
          ? `\n\nüìÅ Archivos subidos: ${archivosSubidos.length}`
          : '\n\nüìÅ No se subieron archivos';
        
        // Mostrar modal de √©xito en lugar de alert
        mostrarModalExito(resultado.data, mensajeArchivos);

        // Opcional: Descargar JSON de respaldo
        const dataCompleto = {
          ...data,
          folio: resultado.data.folio,
          solicitud_id: resultado.data.solicitud_id,
          validacion: {
            sucursal: document.getElementById("sucursal").value,
            firma_funcionario: firmaFunc,
            nota: "Representante firmar√° con aplicaci√≥n externa"
          }
        };

        const blob = new Blob([JSON.stringify(dataCompleto, null, 2)], {type:"application/json"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url; 
        a.download = `saldo_insoluto_${resultado.data.folio}.json`; 
        a.click();
        URL.revokeObjectURL(url);

        // Limpiar formulario
        document.getElementById("formSaldo").reset();
        tbody.innerHTML = '';
        firmaFunc = null;
        
        // Resetear badge
        document.getElementById("badge_func").style.display = "none";

      } catch (error) {
        console.error('Error:', error);
        alert(`‚ùå Error al guardar la solicitud:\n\n${error.message}\n\nPor favor, verifica que el servidor est√© corriendo y vuelve a intentar.`);
      } finally {
        // Restaurar bot√≥n
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
      }
    }
    // Funci√≥n para mostrar modal de √©xito
    function mostrarModalExito(datos, mensajeArchivos) {
      const modal = document.createElement('div');
      modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 10000;
      `;
      
      modal.innerHTML = `
        <div style="
          background: white;
          padding: 40px;
          border-radius: 16px;
          max-width: 500px;
          text-align: center;
          box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        ">
          <div style="font-size: 64px; margin-bottom: 20px;">‚úÖ</div>
          <h2 style="color: #28a745; margin-bottom: 20px;">¬°Expediente Creado Exitosamente!</h2>
          <div style="text-align: left; margin-bottom: 20px;">
            <p><strong>Folio:</strong> ${datos.folio}</p>
            <p><strong>Expediente:</strong> ${datos.expediente_numero}</p>
            <p><strong>Estado:</strong> ${datos.estado}</p>
            ${mensajeArchivos}
          </div>
          <button onclick="window.location.href='index.html'" style="
            background: #0d6efd;
            color: white;
            border: none;
            padding: 12px 32px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            font-weight: 600;
          ">
            üè† Volver al Inicio
          </button>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      // Cerrar modal si hace click fuera
      modal.addEventListener('click', function(e) {
        if (e.target === modal) {
          document.body.removeChild(modal);
        }
      });
    }
  </script>
</body>
</html>



