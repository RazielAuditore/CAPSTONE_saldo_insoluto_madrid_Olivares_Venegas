<!doctype html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Login Saldos Insolutos</title>
  <style>
    .logo-ips {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1000;
      width: 220px;
      max-width: 30vw;
      height: auto;
    }
    body {
      font-family: Arial, sans-serif;
      background: linear-gradient(120deg, #e3f0ff 0%, #f7e3e3 100%, #f5f7fb 100%);
      display:flex;
      height:100vh;
      justify-content:center;
      align-items:center;
      margin:0;
    }
    .login-box { background:#fff; padding:30px; border-radius:10px; box-shadow:0 4px 8px rgba(0,0,0,0.1); width:320px; text-align:center; }
    input { width:90%; padding:8px; margin:10px 0; border:1px solid #ccc; border-radius:5px; }
    button { background:#007BFF; color:#fff; border:none; padding:10px; width:100%; border-radius:5px; cursor:pointer; }
    button:hover { background:#0056b3; }
    .error { color:red; font-size:14px; min-height:20px; }
    .titulo {
      font-size: 22px;
      font-weight: bold;
      color: #0d6efd;
      margin-bottom: 18px;
      letter-spacing: 1px;
    }
  </style>
</head>
<body>
  <img src="img/IPS_ChileAtiende_logo.png.png" alt="IPS ChileAtiende" class="logo-ips" />
  <div class="login-box">
    <div class="titulo">Software de saldos insolutos</div>
    <h2>Ingresar</h2>
    <input type="text" id="rut" placeholder="RUT (ej: 12.345.678-9)" maxlength="12" oninput="formatearRUT(this)" onkeypress="if(event.key==='Enter') login()">
    <input type="password" id="pass" placeholder="Contraseña" onkeypress="if(event.key==='Enter') login()">
    <button onclick="login()">Entrar</button>
    <div style="margin-top:10px;">
      <a href="#" style="font-size:14px; color:#007BFF; text-decoration:underline; cursor:pointer;">¿Se le olvidó la contraseña?</a>
    </div>
    <p class="error" id="msg"></p>
  </div>

  <script>
    function formatearRUT(input) {
      // Obtener solo números y K
      let valor = input.value.replace(/[^0-9Kk]/g, '');
      
      // Limitar a 9 caracteres máximo
      if (valor.length > 9) {
        valor = valor.substring(0, 9);
      }
      
      // Formatear con puntos y guión
      if (valor.length > 0) {
        let rutFormateado = '';
        
        // Si tiene más de 1 dígito, separar el dígito verificador
        if (valor.length > 1) {
          const numero = valor.slice(0, -1); // Todo excepto el último dígito
          const dv = valor.slice(-1); // Último dígito (verificador)
          
          // Formatear el número con puntos
          let numeroFormateado = '';
          for (let i = numero.length - 1, j = 0; i >= 0; i--, j++) {
            if (j > 0 && j % 3 === 0) {
              numeroFormateado = '.' + numeroFormateado;
            }
            numeroFormateado = numero[i] + numeroFormateado;
          }
          
          rutFormateado = numeroFormateado + '-' + dv;
        } else {
          rutFormateado = valor;
        }
        
        input.value = rutFormateado;
      }
    }

    async function login() {
      const rut = document.getElementById("rut").value.trim();
      const password = document.getElementById("pass").value.trim();
      const msg = document.getElementById("msg");

      // Limpiar mensaje anterior
      msg.textContent = '';

      // Validar que ambos campos estén llenos
      if (!rut || !password) {
        msg.textContent = "Por favor complete todos los campos";
        return;
      }

      try {
        console.log('🚀 Enviando credenciales de login...');
        console.log('📤 RUT:', rut);
        console.log('📤 Password:', password);
        
        // Enviar credenciales al backend
        const response = await fetch('http://localhost:3001/api/login', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          credentials: 'include',
          body: JSON.stringify({
            username: rut,
            password: password
          })
        });

        console.log('📥 Respuesta recibida:', response.status, response.statusText);
        const resultado = await response.json();
        console.log('📥 Datos respuesta:', resultado);

        if (response.ok && resultado.success) {
          // Login exitoso - redirigir al dashboard
          window.location.href = "index.html";
        } else {
          msg.textContent = resultado.error || "RUT o contraseña incorrectos";
        }

      } catch (error) {
        console.error('Error en login:', error);
        msg.textContent = "Error de conexión. Intente nuevamente.";
      }
    }
  </script>
</body>
</html>

