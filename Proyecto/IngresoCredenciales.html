<!doctype html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Login Saldos Insolutos</title>
  <style>
    .logo-ips {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1000;
      width: 220px;
      max-width: 30vw;
      height: auto;
    }
    body {
      font-family: Arial, sans-serif;
      background: linear-gradient(120deg, #e3f0ff 0%, #f7e3e3 100%, #f5f7fb 100%);
      display:flex;
      height:100vh;
      justify-content:center;
      align-items:center;
      margin:0;
    }
    .login-box { background:#fff; padding:30px; border-radius:10px; box-shadow:0 4px 8px rgba(0,0,0,0.1); width:320px; text-align:center; }
    input { width:90%; padding:8px; margin:10px 0; border:1px solid #ccc; border-radius:5px; }
    button { background:#007BFF; color:#fff; border:none; padding:10px; width:100%; border-radius:5px; cursor:pointer; }
    button:hover { background:#0056b3; }
    .error { color:red; font-size:14px; min-height:20px; }
    .titulo {
      font-size: 22px;
      font-weight: bold;
      color: #0d6efd;
      margin-bottom: 18px;
      letter-spacing: 1px;
    }
  </style>
</head>
<body>
  <img src="img/IPS_ChileAtiende_logo.png.png" alt="IPS ChileAtiende" class="logo-ips" />
  <div class="login-box">
    <div class="titulo">Software de saldos insolutos</div>
    <h2>Ingresar</h2>
    <input type="text" id="rut" placeholder="RUT (ej: 12.345.678-9)" maxlength="12" oninput="formatearRUT(this)" onkeypress="if(event.key==='Enter') login()">
    <input type="password" id="pass" placeholder="Contrase침a" onkeypress="if(event.key==='Enter') login()">
    <button onclick="login()">Entrar</button>
    <div style="margin-top:10px;">
      <a href="#" style="font-size:14px; color:#007BFF; text-decoration:underline; cursor:pointer;">쯉e le olvid칩 la contrase침a?</a>
    </div>
    <p class="error" id="msg"></p>
  </div>

  <script>
    function formatearRUT(input) {
      let value = input.value.replace(/[^0-9kK]/g, '');
      
      if (value.length > 0) {
        // Determinar si es RUT de 7 o 8 d칤gitos (sin contar el DV)
        const bodyLength = value.length - 1; // Restar el d칤gito verificador
        
        if (bodyLength <= 7) {
          // Formato: x.xxx.xxx-x (7 d칤gitos + DV)
          if (value.length > 1) {
            value = value.substring(0, 1) + '.' + value.substring(1);
          }
          if (value.length > 5) {
            value = value.substring(0, 5) + '.' + value.substring(5);
          }
        } else {
          // Formato: xx.xxx.xxx-x (8 d칤gitos + DV)
          if (value.length > 2) {
            value = value.substring(0, 2) + '.' + value.substring(2);
          }
          if (value.length > 6) {
            value = value.substring(0, 6) + '.' + value.substring(6);
          }
        }
        
        // Agregar gui칩n antes del 칰ltimo car치cter si es necesario
        if (value.length > 8 && !value.includes('-')) {
          const lastChar = value.slice(-1);
          value = value.slice(0, -1) + '-' + lastChar;
        }
      }
      
      input.value = value;
    }

    async function login() {
      const rut = document.getElementById("rut").value.trim();
      const password = document.getElementById("pass").value.trim();
      const msg = document.getElementById("msg");

      // Limpiar mensaje anterior
      msg.textContent = '';

      // Validar que ambos campos est칠n llenos
      if (!rut || !password) {
        msg.textContent = "Por favor complete todos los campos";
        return;
      }

      try {
        console.log('游 Enviando credenciales de login...');
        console.log('游닋 RUT:', rut);
        console.log('游닋 Password:', password);
        
        // Enviar credenciales al backend
        const response = await fetch('http://localhost:3001/api/login', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          credentials: 'include',
          body: JSON.stringify({
            username: rut,
            password: password
          })
        });

        console.log('游닌 Respuesta recibida:', response.status, response.statusText);
        const resultado = await response.json();
        console.log('游닌 Datos respuesta:', resultado);

        if (response.ok && resultado.success) {
          // Login exitoso - redirigir seg칰n rol
          if (resultado.user.rol === 'jefatura') {
            window.location.href = "FrontJefatura.html";
          } else {
            window.location.href = "index.html";
          }
        } else {
          msg.textContent = resultado.error || "RUT o contrase침a incorrectos";
        }

      } catch (error) {
        console.error('Error en login:', error);
        msg.textContent = "Error de conexi칩n. Intente nuevamente.";
      }
    }
  </script>
</body>
</html>

