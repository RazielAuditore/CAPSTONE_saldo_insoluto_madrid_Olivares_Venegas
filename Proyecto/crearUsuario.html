<!doctype html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Crear Usuario - Sistema Saldos Insolutos</title>
  <style>
    .logo-ips {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1000;
      width: 220px;
      max-width: 30vw;
      height: auto;
    }
    
    body {
      font-family: Arial, sans-serif;
      background: linear-gradient(120deg, #e3f0ff 0%, #f7e3e3 100%, #f5f7fb 100%);
      display: flex;
      min-height: 100vh;
      justify-content: center;
      align-items: flex-start;
      margin: 0;
      padding: 20px;
      padding-top: 40px;
    }
    
    .form-container {
      background: #fff;
      padding: 40px;
      border-radius: 15px;
      box-shadow: 0 8px 25px rgba(0,0,0,0.15);
      width: 100%;
      max-width: 500px;
      text-align: center;
      margin-top: 20px;
      margin-bottom: 20px;
    }
    
    .titulo {
      font-size: 28px;
      font-weight: bold;
      color: #0d6efd;
      margin-bottom: 15px;
      letter-spacing: 1px;
      text-shadow: 0 2px 4px rgba(0,0,0,0.1);
      line-height: 1.2;
    }
    
    .subtitulo {
      font-size: 16px;
      color: #666;
      margin-bottom: 30px;
    }
    
    .form-group {
      margin-bottom: 20px;
      text-align: left;
    }
    
    label {
      display: block;
      margin-bottom: 8px;
      font-weight: bold;
      color: #333;
      font-size: 14px;
    }
    
    input[type="text"],
    input[type="password"] {
      width: 100%;
      padding: 12px 15px;
      border: 2px solid #e1e5e9;
      border-radius: 8px;
      font-size: 16px;
      transition: border-color 0.3s ease;
      box-sizing: border-box;
    }
    
    input[type="text"]:focus,
    input[type="password"]:focus,
    input[type="email"]:focus,
    select:focus {
      outline: none;
      border-color: #0d6efd;
      box-shadow: 0 0 0 3px rgba(13, 110, 253, 0.1);
    }
    
    .password-requirements {
      background: #f8f9fa;
      border: 1px solid #e9ecef;
      border-radius: 8px;
      padding: 15px;
      margin: 15px 0;
      text-align: left;
    }
    
    .password-requirements h4 {
      margin: 0 0 10px 0;
      color: #495057;
      font-size: 14px;
    }
    
    .requirement {
      display: flex;
      align-items: center;
      margin: 5px 0;
      font-size: 13px;
    }
    
    .requirement-icon {
      width: 16px;
      height: 16px;
      margin-right: 8px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      font-weight: bold;
    }
    
    .requirement-valid {
      background: #28a745;
      color: white;
    }
    
    .requirement-invalid {
      background: #dc3545;
      color: white;
    }
    
    .btn-crear {
      background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
      color: #fff;
      border: none;
      padding: 15px 30px;
      width: 100%;
      border-radius: 8px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-top: 20px;
    }
    
    .btn-crear:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0, 123, 255, 0.3);
    }
    
    .btn-crear:disabled {
      background: #6c757d;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    
    .btn-volver {
      background: #6c757d;
      color: #fff;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
      text-decoration: none;
      display: inline-block;
      margin-top: 15px;
      transition: background 0.3s ease;
    }
    
    .btn-volver:hover {
      background: #5a6268;
    }
    
    .error {
      color: #dc3545;
      font-size: 14px;
      margin-top: 10px;
      min-height: 20px;
    }
    
    .success {
      color: #28a745;
      font-size: 14px;
      margin-top: 10px;
      min-height: 20px;
    }
    
    .row {
      display: flex;
      gap: 15px;
    }
    
    .row .form-group {
      flex: 1;
    }
    
    @media (max-width: 600px) {
      .row {
        flex-direction: column;
        gap: 0;
      }
      
      .form-container {
        padding: 30px 20px;
      }
    }
  </style>
</head>
<body>
  <img src="img/IPS_ChileAtiende_logo.png.png" alt="IPS ChileAtiende" class="logo-ips" />
  
  <div class="form-container">
    <div class="titulo">Crear Usuario</div>
    <div class="subtitulo">Sistema de Saldos Insolutos - IPS</div>
    
    <form id="formCrearUsuario" onsubmit="crearUsuario(event)">
      <div class="row">
        <div class="form-group">
          <label for="nombres">Nombres *</label>
          <input type="text" id="nombres" name="nombres" required 
                 placeholder="Ej: Juan Carlos" maxlength="100">
        </div>
      </div>
      
      <div class="row">
        <div class="form-group">
          <label for="apellido_p">Apellido Paterno *</label>
          <input type="text" id="apellido_p" name="apellido_p" required 
                 placeholder="Ej: González" maxlength="50">
        </div>
        <div class="form-group">
          <label for="apellido_m">Apellido Materno</label>
          <input type="text" id="apellido_m" name="apellido_m" 
                 placeholder="Ej: Pérez" maxlength="50">
        </div>
      </div>
      
      <div class="form-group">
        <label for="rut">RUT *</label>
        <input type="text" id="rut" name="rut" required 
               placeholder="12.345.678-9" maxlength="12">
      </div>
      
      <div class="form-group">
        <label for="email">Correo Electrónico *</label>
        <input type="email" id="email" name="email" required 
               placeholder="ejemplo@ips.gob.cl" maxlength="100" 
               style="width: 100%; padding: 12px 15px; border: 2px solid #e1e5e9; border-radius: 8px; font-size: 16px; box-sizing: border-box;">
      </div>
      
      <div class="form-group">
        <label for="rol">Rol *</label>
        <select id="rol" name="rol" required style="width: 100%; padding: 12px 15px; border: 2px solid #e1e5e9; border-radius: 8px; font-size: 16px; background-color: white;">
          <option value="">Seleccione un rol</option>
          <option value="ejecutivo_plataforma">Ejecutivo de Plataforma</option>
          <option value="jefatura">Jefatura IPS</option>
        </select>
      </div>
      
      <div class="form-group">
        <label for="sucursal">Sucursal</label>
        <select id="sucursal" name="sucursal" style="width: 100%; padding: 12px 15px; border: 2px solid #e1e5e9; border-radius: 8px; font-size: 16px; background-color: white;">
          <option value="">Seleccione una sucursal</option>
          <option value="providencia">ChileAtiende Providencia</option>
          <option value="nunoa">ChileAtiende Ñuñoa</option>
          <option value="santo_domingo">ChileAtiende Santo Domingo</option>
        </select>
      </div>
      
      <div class="form-group">
        <label for="password">Nueva Contraseña *</label>
        <input type="password" id="password" name="password" required 
               placeholder="Mínimo 8 caracteres" minlength="8">
      </div>
      
      <div class="form-group">
        <label for="password_confirm">Repetir Contraseña *</label>
        <input type="password" id="password_confirm" name="password_confirm" required 
               placeholder="Confirme su contraseña" minlength="8">
      </div>
      
      <div class="password-requirements">
        <h4>Requisitos de la contraseña:</h4>
        <div class="requirement">
          <div class="requirement-icon" id="req-length">✗</div>
          <span>Mínimo 8 caracteres</span>
        </div>
        <div class="requirement">
          <div class="requirement-icon" id="req-uppercase">✗</div>
          <span>Al menos una mayúscula (A-Z)</span>
        </div>
        <div class="requirement">
          <div class="requirement-icon" id="req-lowercase">✗</div>
          <span>Al menos una minúscula (a-z)</span>
        </div>
        <div class="requirement">
          <div class="requirement-icon" id="req-number">✗</div>
          <span>Al menos un número (0-9)</span>
        </div>
        <div class="requirement">
          <div class="requirement-icon" id="req-special">✗</div>
          <span>Al menos un símbolo (!@#$%^&*)</span>
        </div>
      </div>
      
      <button type="submit" class="btn-crear" id="btnCrear" disabled>
        Crear Usuario
      </button>
      
      <a href="IngresoCredenciales.html" class="btn-volver">
        ← Volver al Login
      </a>
      
      <div class="error" id="errorMsg"></div>
      <div class="success" id="successMsg"></div>
    </form>
  </div>

  <script>
    // Variables globales
    let passwordInput, passwordConfirmInput, btnCrear, errorMsg, successMsg;
    let reqLength, reqUppercase, reqLowercase, reqNumber, reqSpecial;

    function validatePassword(password) {
      const requirements = {
        length: password.length >= 8,
        uppercase: /[A-Z]/.test(password),
        lowercase: /[a-z]/.test(password),
        number: /[0-9]/.test(password),
        special: /[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(password)
      };

      // Actualizar iconos
      if (reqLength) updateRequirement(reqLength, requirements.length);
      if (reqUppercase) updateRequirement(reqUppercase, requirements.uppercase);
      if (reqLowercase) updateRequirement(reqLowercase, requirements.lowercase);
      if (reqNumber) updateRequirement(reqNumber, requirements.number);
      if (reqSpecial) updateRequirement(reqSpecial, requirements.special);

      return Object.values(requirements).every(req => req === true);
    }

    function updateRequirement(element, isValid) {
      if (element) {
        if (isValid) {
          element.className = 'requirement-icon requirement-valid';
          element.textContent = '✓';
        } else {
          element.className = 'requirement-icon requirement-invalid';
          element.textContent = '✗';
        }
      }
    }

    function validateForm() {
      const password = passwordInput.value;
      const passwordConfirm = passwordConfirmInput.value;
      const nombres = document.getElementById('nombres').value.trim();
      const apellidoP = document.getElementById('apellido_p').value.trim();
      const rut = document.getElementById('rut').value.trim();
      const email = document.getElementById('email').value.trim();
      const rol = document.getElementById('rol').value;

      const passwordValid = validatePassword(password);
      const passwordsMatch = password === passwordConfirm && password.length > 0;
      const basicFieldsValid = nombres && apellidoP && rut && email && rol;

      // Actualizar estado del botón
      if (passwordValid && passwordsMatch && basicFieldsValid) {
        btnCrear.disabled = false;
        btnCrear.textContent = 'Crear Usuario';
      } else {
        btnCrear.disabled = true;
        btnCrear.textContent = 'Completar todos los campos';
      }

      // Mostrar error si las contraseñas no coinciden
      if (passwordConfirm.length > 0 && !passwordsMatch) {
        errorMsg.textContent = 'Las contraseñas no coinciden';
      } else {
        errorMsg.textContent = '';
      }
    }

    // Función para formatear RUT
    function formatRUT(e) {
      let value = e.target.value.replace(/[^0-9kK]/g, '');
      
      if (value.length >= 2) {
        let body = value.slice(0, -1);
        let dv = value.slice(-1);
        
        if (body.length > 0) {
          if (body.length > 6) {
            body = body.slice(0, -6) + '.' + body.slice(-6, -3) + '.' + body.slice(-3);
          } else if (body.length > 3) {
            body = body.slice(0, -3) + '.' + body.slice(-3);
          }
          value = body + '-' + dv;
        }
      }
      
      e.target.value = value;
      validateForm();
    }

    // Inicializar cuando el DOM esté listo
    document.addEventListener('DOMContentLoaded', function() {
      // Obtener elementos
      passwordInput = document.getElementById('password');
      passwordConfirmInput = document.getElementById('password_confirm');
      btnCrear = document.getElementById('btnCrear');
      errorMsg = document.getElementById('errorMsg');
      successMsg = document.getElementById('successMsg');
      
      reqLength = document.getElementById('req-length');
      reqUppercase = document.getElementById('req-uppercase');
      reqLowercase = document.getElementById('req-lowercase');
      reqNumber = document.getElementById('req-number');
      reqSpecial = document.getElementById('req-special');

      // Event listeners
      passwordInput.addEventListener('input', validateForm);
      passwordConfirmInput.addEventListener('input', validateForm);
      document.getElementById('nombres').addEventListener('input', validateForm);
      document.getElementById('apellido_p').addEventListener('input', validateForm);
      document.getElementById('email').addEventListener('input', validateForm);
      document.getElementById('rol').addEventListener('change', validateForm);
      document.getElementById('rut').addEventListener('input', formatRUT);

      // Formatear RUT si ya tiene valor
      const rutField = document.getElementById('rut');
      if (rutField.value) {
        const event = new Event('input');
        rutField.dispatchEvent(event);
      }

      // Validación inicial
      validateForm();
    });

    // Función para crear usuario
    async function crearUsuario(event) {
      event.preventDefault();
      
      const formData = {
        nombres: document.getElementById('nombres').value.trim(),
        apellido_p: document.getElementById('apellido_p').value.trim(),
        apellido_m: document.getElementById('apellido_m').value.trim(),
        rut: document.getElementById('rut').value.trim(),
        email: document.getElementById('email').value.trim(),
        rol: document.getElementById('rol').value,
        sucursal: document.getElementById('sucursal').value,
        password: passwordInput.value,
        password_confirm: passwordConfirmInput.value
      };

      // Validaciones finales
      if (!validatePassword(formData.password)) {
        errorMsg.textContent = 'La contraseña no cumple con todos los requisitos';
        return;
      }

      if (formData.password !== formData.password_confirm) {
        errorMsg.textContent = 'Las contraseñas no coinciden';
        return;
      }

      // Validar RUT en formato xx.xxx.xxx-x
      const rutPattern = /^\d{1,2}\.\d{3}\.\d{3}-[0-9kK]$/;
      if (!rutPattern.test(formData.rut)) {
        errorMsg.textContent = 'Formato de RUT inválido. Use: 12.345.678-9';
        return;
      }

      // Validar email
      const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailPattern.test(formData.email)) {
        errorMsg.textContent = 'Formato de email inválido';
        return;
      }

      // Mostrar loading
      btnCrear.disabled = true;
      btnCrear.textContent = 'Creando usuario...';
      errorMsg.textContent = '';
      successMsg.textContent = '';

      // Enviar datos al backend
      try {
        console.log('🚀 Enviando petición al backend...');
        console.log('📤 Datos a enviar:', formData);
        
        const response = await fetch('http://localhost:3001/api/usuarios', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(formData)
        });
        
        console.log('📥 Respuesta recibida:', response.status, response.statusText);

        const resultado = await response.json();

        if (!response.ok) {
          throw new Error(resultado.error || 'Error del servidor');
        }

        // Éxito
        const rolTexto = resultado.data.rol === 'ejecutivo_plataforma' ? 'Ejecutivo de Plataforma' : 'Jefatura IPS';
        successMsg.textContent = `Usuario creado exitosamente - ${rolTexto} - Iniciales: ${resultado.data.iniciales}`;
        btnCrear.textContent = 'Usuario Creado ✓';
        
        // Limpiar formulario después de 3 segundos
        setTimeout(() => {
          document.getElementById('formCrearUsuario').reset();
          validateForm();
        }, 3000);

      } catch (error) {
        console.error('❌ Error en la petición:', error);
        errorMsg.textContent = error.message;
        btnCrear.disabled = false;
        btnCrear.textContent = 'Crear Usuario';
      }
    }

  </script>
</body>
</html>
